<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„¸ê³„ê´€ ê·¸ë˜í”„ í¸ì§‘ê¸° (Complete Ver)</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f0f0; height: 100vh; display: flex; flex-direction: column; }
    
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 15px 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    header h1 { font-size: 1.5em; margin-bottom: 5px; text-shadow: 1px 1px 0 #000; }

    .main-container { display: flex; flex: 1; overflow: hidden; }
    .left-panel { width: 25%; background: white; padding: 15px; overflow-y: auto; border-right: 2px solid #ddd; }
    .graph-area { width: 50%; padding: 15px; display: flex; flex-direction: column; }
    .right-panel { width: 25%; background: white; padding: 15px; overflow-y: auto; border-left: 2px solid #ddd; display: flex; flex-direction: column; }

    #cy { flex: 1; border: 2px solid #ddd; border-radius: 8px; background: #fafafa; }

    .panel-section { margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0; }
    .panel-section h3 { font-size: 1em; margin-bottom: 10px; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 5px; }

    input[type="text"], input[type="number"], select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; }
    input[readonly] { background-color: #e9ecef; color: #495057; cursor: not-allowed; }

    button {
      width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 4px; font-size: 0.9em;
      cursor: pointer; transition: all 0.1s; font-weight: bold; color: white; text-shadow: 1px 1px 0 #000;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .btn-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .btn-danger { background: linear-gradient(135deg, #ff5f6d 0%, #ffc371 100%); }
    .btn-warning { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: white; }
    button:active { transform: scale(0.98); }

    textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Malgun Gothic', monospace; font-size: 0.9em; resize: vertical; min-height: 150px; }
    .notes-area { flex: 1; display: flex; flex-direction: column; gap: 10px; }
    .notes-textarea { flex: 1; min-height: 200px; line-height: 1.6; }

    .tts-controls { padding: 10px; background: #f0f7ff; border-radius: 6px; border: 1px solid #d0e7ff; }
    .speed-control { display: flex; align-items: center; gap: 10px; }
    .speed-control input[type="range"] { flex: 1; }
    .tts-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }

    .info-badge { display: inline-block; padding: 6px 12px; background: #667eea; color: white; border-radius: 4px; font-size: 0.85em; margin-bottom: 10px; text-shadow: 1px 1px 0 #000; }
    .help-text { font-size: 0.8em; color: #888; margin-top: 5px; padding: 8px; background: #f9f9f9; border-radius: 4px; }
    
    .connection-tools { display: flex; gap: 5px; margin-bottom: 5px; }
    .connection-tools button { padding: 5px; font-size: 0.8em; margin: 0; }
    
    .drag-mode-active { background: #ff0055 !important; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); } }

    /* === NEW STYLES for Gemini Shortcut and Help Text === */
    .btn-gemini {
        background-color: #5555ff; /* Geminië¥¼ ìƒì§•í•˜ëŠ” íŒŒë€ìƒ‰ ê³„ì—´ */
        color: white; 
        padding: 10px; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        width: 100%; 
        margin-top: 10px;
        font-weight: bold;
        transition: background-color 0.2s;
        text-shadow: 1px 1px 0 #000; /* ê¸°ì¡´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ê³¼ í†µì¼ */
    }

    .btn-gemini:hover {
        background-color: #4444cc;
    }

    .help-text-api {
        font-size: 0.85em; 
        color: #333; 
        margin-top: 8px;
        padding: 8px;
        border: 1px dashed #5555ff; /* Gemini ìƒ‰ìƒì— ë§ì¶˜ ì ì„  í…Œë‘ë¦¬ */
        border-radius: 4px;
        background: #e6e6ff; /* ì—°í•œ ë°°ê²½ìƒ‰ */
        margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ ì„¸ê³„ê´€ ê·¸ë˜í”„ í¸ì§‘ê¸° (ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)</h1>
    <p>í´ë¦­ ì—°ê²° + ë“œë˜ê·¸ ì—°ê²° + ì„ íƒ ì‚­ì œ ê¸°ëŠ¥ í†µí•© ë²„ì „</p>
  </header>

  <div class="main-container">
    <div class="left-panel">
      <div class="panel-section">
        <h3>â• ë…¸ë“œ ì¶”ê°€</h3>
        <input type="text" id="newNode" placeholder="ë…¸ë“œ ì´ë¦„ (ì˜ˆ: ì² ìˆ˜)">
        <button class="btn-primary" onclick="addNode()">ë…¸ë“œ ì¶”ê°€</button>
        <div class="help-text">ğŸ’¡ ë¹ˆ ê³µê°„ ë”ë¸”í´ë¦­ìœ¼ë¡œë„ ì¶”ê°€ ê°€ëŠ¥</div>
      </div>

      <div class="panel-section">
        <h3>ğŸ”— ì‰¬ìš´ ê´€ê³„ ì—°ê²°</h3>
        <button id="btnDragMode" class="btn-warning" onclick="toggleDragMode()">ğŸ–±ï¸ ë“œë˜ê·¸ ì—°ê²° ëª¨ë“œ (ì¼œê¸°/ë„ê¸°)</button>
        <div class="help-text" style="margin-bottom:10px;">ğŸ‘† ì¼œë©´ ë…¸ë“œë¥¼ ë“œë˜ê·¸í•´ì„œ ë°”ë¡œ ì—°ê²°ë©ë‹ˆë‹¤!</div>
        <div style="border-top: 1px dashed #ccc; margin: 10px 0;"></div>
        
        <div class="connection-tools">
            <button class="btn-info" onclick="clearEdgeInputs()" title="ì…ë ¥ ì´ˆê¸°í™”">ğŸ”„ ì´ˆê¸°í™”</button>
            <button class="btn-info" onclick="swapEdgeInputs()" title="ì¶œë°œ/ë„ì°© ë°”ê¾¸ê¸°">â†”ï¸ êµì²´</button>
        </div>
        <input type="text" id="edgeSrc" placeholder="1. ì¶œë°œ ë…¸ë“œ í´ë¦­" readonly style="background-color: #e3f2fd; cursor: pointer;">
        <input type="text" id="edgeTgt" placeholder="2. ë„ì°© ë…¸ë“œ í´ë¦­" readonly style="background-color: #ffebee; cursor: pointer;">
        <input type="text" id="edgeLbl" placeholder="ê´€ê³„ ë¼ë²¨ (ì˜ˆ: ì¹œêµ¬, ì )">
        <button class="btn-primary" onclick="addEdge()">ì—°ê²° ì¶”ê°€</button>
        <div class="help-text">ğŸ’¡ ê·¸ë˜í”„ì—ì„œ ë…¸ë“œë¥¼ <b>í´ë¦­</b>í•˜ë©´ ìœ„ ì¹¸ì— ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.</div>
      </div>

      <div class="panel-section">
        <h3>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
        <button class="btn-success" onclick="saveToLocalStorage()">ğŸ’¾ ë¡œì»¬ ì €ì¥</button>
        <button class="btn-info" onclick="loadFromLocalStorage()">ğŸ“‚ ë¡œì»¬ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn-primary" onclick="saveToURL()">ğŸ”— URLë¡œ ì €ì¥</button>
        <button class="btn-success" onclick="downloadJSON()">â¬‡ï¸ JSON ë‹¤ìš´ë¡œë“œ</button>
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="uploadJSON(event)">
        <button class="btn-info" onclick="document.getElementById('fileInput').click()">â¬†ï¸ JSON ì—…ë¡œë“œ</button>
        <input type="file" id="appendFileInput" accept=".json" style="display:none" onchange="appendJSON(event)">
        <button class="btn-primary" onclick="document.getElementById('appendFileInput').click()">â• JSON ì¶”ê°€ ì—…ë¡œë“œ</button>
        
        <textarea id="geminiPromptTemplate" style="height:1px; opacity:0; resize:none; position:absolute; left:-9999px;">
		**ì£¼ì˜: ì´ ìš”ì²­ì— ëŒ€í•´ JSON ì½”ë“œ ë¸”ë¡ ì™¸ì˜ ì–´ë– í•œ ì„¤ëª…, ì¸ì‚¬ë§, ì¶”ê°€ í…ìŠ¤íŠ¸ë„ ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”. ì˜¤ì§ JSON ì½”ë“œ ë¸”ë¡ë§Œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.**

			ë‹¹ì‹ ì€ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ ê´€ê³„í˜• ë°ì´í„°(ë…¸ë“œì™€ ì—£ì§€)ë¥¼ Cytoscape.js ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì í•©í•œ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤.

			ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ ë“±ì¥ì¸ë¬¼(ë…¸ë“œ)ê³¼ ê´€ê³„(ì—£ì§€)ë¥¼ ì¶”ì¶œí•˜ê³ , ìš”ì²­ëœ í˜•ì‹ì— ë§ì¶° **JSON ì½”ë“œ ë¸”ë¡**ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.

		### ë¶„ì„í•  í…ìŠ¤íŠ¸ (ì—¬ê¸°ì— ì‚¬ìš©ìê°€ ë¶„ì„í•  ìŠ¤í† ë¦¬ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.) ###
		ì˜ˆì‹œ: 'ì² ìˆ˜ëŠ” ì˜í¬ì˜ ì¹œêµ¬ì´ë©°, ë¯¼ìˆ˜ëŠ” ì² ìˆ˜ì˜ ë™ë£Œì´ë‹¤. í˜œêµëŠ” ì•„ë¦°ì˜ ìŠ¤ìŠ¹ì´ë‹¤.'

		### ì¶œë ¥ í˜•ì‹ (JSON Only) ###
		```json
		{
	"elements": [
    {"data": {"id": "ì² ìˆ˜", "label": "ì² ìˆ˜", "color": "#667eea"}},
    {"data": {"id": "ì˜í¬", "label": "ì˜í¬", "color": "#f093fb"}},
    {"data": {"id": "ë¯¼ìˆ˜", "label": "ë¯¼ìˆ˜", "color": "#4facfe"}},
    {"data": {"source": "ì² ìˆ˜", "target": "ì˜í¬", "label": "ì¹œêµ¬"}},
    {"data": {"source": "ë¯¼ìˆ˜", "target": "ì² ìˆ˜", "label": "ë™ë£Œ"}}
  ]
}
</textarea>
        <button class="btn-gemini" onclick="copyPromptAndOpenGemini()">âœ¨ Gemini í”„ë¡¬í”„íŠ¸ ë³µì‚¬ ë° ì±„íŒ… ì—´ê¸°</button>
        <div class="help-text-api">
            1. ìœ„ ë²„íŠ¼ í´ë¦­: **JSON í˜•ì‹ ìš”ì²­ ëª…ë ¹ì–´ ë³µì‚¬** ë° Gemini ì±„íŒ… ì°½ ì—´ë¦¼.<br>
            2. Geminiì— ë¶™ì—¬ë„£ê¸° í›„ **(ì—¬ê¸°ì—...ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.)** ë¶€ë¶„ì— ë¶„ì„í•  í…ìŠ¤íŠ¸ ì¶”ê°€.<br>
            3. Gemini ì‘ë‹µ JSONì„ ë³µì‚¬í•˜ì—¬ ì•„ë˜ **'JSON í…ìŠ¤íŠ¸ ë³€í™˜ (ìˆ˜ë™)'** ì…ë ¥ì°½ì— ë¶™ì—¬ë„£ê¸°.
        </div>
      </div>
      
      <div class="panel-section">
        <h3>ğŸ¤– JSON í…ìŠ¤íŠ¸ ë³€í™˜ (ìˆ˜ë™)</h3>
        <textarea id="jsonInputTextarea" placeholder="ì—¬ê¸°ì— JSON í˜•ì‹ì˜ ë…¸ë“œ/ì—£ì§€ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ìì—°ì–´ ì²˜ë¦¬ ì•„ë‹˜)" rows="8"></textarea>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
            <button class="btn-primary" onclick="loadJSONFromTextarea(false)">âœ”ï¸ JSONìœ¼ë¡œ ë®ì–´ì“°ê¸°</button>
            <button class="btn-success" onclick="loadJSONFromTextarea(true)">â• JSON ì¶”ê°€í•˜ê¸°</button>
        </div>
        <div class="help-text">âš ï¸ **ì£¼ì˜:** ì´ ê¸°ëŠ¥ì€ ìì—°ì–´ ì²˜ë¦¬ê°€ ì•„ë‹Œ, **ìœ íš¨í•œ JSON í…ìŠ¤íŠ¸**ë¥¼ ì½ì–´ ê·¸ë˜í”„ì— ë°˜ì˜í•©ë‹ˆë‹¤.</div>
      </div>

      <div class="panel-section">
        <h3>âœ¨ ë ˆì´ì•„ì›ƒ</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
          <button class="btn-info" onclick="runLayout('cose')">ğŸ’« ê¸°ë³¸</button>
          <button class="btn-info" onclick="runLayout('dagre')">ğŸŒ² íŠ¸ë¦¬í˜•</button>
        </div>
      </div>
    </div>

    <div class="graph-area">
      <div id="cy"></div>
    </div>
    
    <div class="right-panel">
      <div class="panel-section notes-area">
        <h3>âœï¸ ì†ì„± í¸ì§‘ / ì‚­ì œ</h3>
        <div class="info-badge" id="notesInfo">ë…¸ë“œ/ì—£ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        
        <label style="font-weight: bold; color: #333;">ì´ë¦„/ë¼ë²¨</label>
        <input type="text" id="labelInput" placeholder="ì„ íƒí•œ ìš”ì†Œì˜ ì´ë¦„" disabled>
        
        <div id="colorControl" style="display:none;">
            <label style="font-weight: bold; color: #333; margin-top: 10px;">ë…¸ë“œ ìƒ‰ìƒ</label>
            <input type="color" id="colorInput" value="#667eea" style="height: 40px; padding: 0;">
        </div>
        <label style="font-weight: bold; color: #333; margin-top: 10px;">ğŸ“ ë©”ëª¨</label>
        <textarea class="notes-textarea" id="notesTextarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <button class="btn-success" onclick="saveNotes()">ğŸ’¾ ì €ì¥</button>
            <button class="btn-danger" onclick="deleteSelected()">ğŸ—‘ï¸ ì‚­ì œ</button>
        </div>
        <div class="help-text">ğŸ’¡ ì„ íƒ í›„ Delete í‚¤ë¥¼ ëˆŒëŸ¬ë„ ì‚­ì œë©ë‹ˆë‹¤.</div>

        <div class="tts-controls">
          <h3>ğŸ”Š ì½ì–´ì£¼ê¸° (TTS)</h3>
          <select id="voiceSelect"><option value="ko-KR">í•œêµ­ì–´</option></select>
          <div class="speed-control">
            <input type="range" id="speedControl" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateSpeedValue()">
            <span class="speed-value" id="speedValue">1.0x</span>
          </div>
          <div class="tts-buttons">
            <button class="btn-primary" onclick="readNotes()">ğŸ”Š ì½ê¸°</button>
            <button class="btn-danger" onclick="stopReading()">â¹ï¸ ì •ì§€</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let initialData = [
      { data: { id: "ì£¼ì¸ê³µ", label: "ì£¼ì¸ê³µ", color: "#667eea", notes: "" } },
      { data: { id: "ì•„ë¦°", label: "ì•„ë¦°", color: "#f093fb", notes: "" } },
      { data: { id: "ev1", label: "ì‹œì‘ ì´ë²¤íŠ¸", color: "#4facfe", notes: "" } },
      { data: { id: "ì£¼ì¸ê³µ_ì•„ë¦°", source: "ì£¼ì¸ê³µ", target: "ì•„ë¦°", label: "ì¹œêµ¬", notes: "" } }, 
      { data: { id: "ev1_ì£¼ì¸ê³µ", source: "ev1", target: "ì£¼ì¸ê³µ", label: "TIMELINE", notes: "ìŠ¤í† ë¦¬ ì‹œì‘ì " }, classes: "timeline" } 
    ];

    let cy = cytoscape({
      container: document.getElementById('cy'),
      elements: JSON.parse(JSON.stringify(initialData)),
      style: [
        { selector: 'node', style: { 'label': 'data(label)', 'background-color': 'data(color)', 'shape': 'round-rectangle', 'width': 'label', 'height': 30, 'padding': '10px', 'border-width': 2, 'border-color': '#333', 'border-style': 'solid', 'text-valign': 'center', 'text-halign': 'center', 'color': '#fff', 'font-weight': 'bold', 'font-size': 14, 'text-outline-width': 2, 'text-outline-color': '#000' } },
        { selector: 'edge', style: { 'label': 'data(label)', 'curve-style': 'bezier', 'line-color': '#999', 'width': 1, 'target-arrow-shape': 'triangle', 'target-arrow-color': '#999', 'font-size': 12 } },
        { selector: 'edge.timeline', style: { 'line-color': '#ff0055', 'width': 3, 'target-arrow-color': '#ff0055' } },
        { selector: 'node:selected', style: { 'border-width': 4, 'border-color': '#FFD700', 'border-style': 'double' } },
        { selector: 'edge:selected', style: { 'width': 4, 'line-color': '#FFD700', 'target-arrow-color': '#FFD700' } }
      ],
      layout: { name: 'cose', animate: true },
      boxSelectionEnabled: false
    });

    let selected = null, speechSynthesis = window.speechSynthesis, currentUtterance = null;
    let edgeCreationMode = false, edgeSourceNode = null, isDragMode = false, tremorInterval = null, currentLayout = null;

    const notesInfo = document.getElementById('notesInfo');
    const labelInput = document.getElementById('labelInput');
    const colorControl = document.getElementById('colorControl');
    const colorInput = document.getElementById('colorInput');
    const notesTextarea = document.getElementById('notesTextarea');
    const edgeSrcInput = document.getElementById('edgeSrc');
    const edgeTgtInput = document.getElementById('edgeTgt');

    window.addEventListener('load', function () {
      const hash = window.location.hash.substring(1);
      if (hash) { try { cy.elements().remove(); cy.add(JSON.parse(LZString.decompressFromEncodedURIComponent(hash))); runLayout('cose'); } catch (e) {} }
      else runLayout('cose');
      resetRightPanel();
    });

    // ------------------- â–¼ í•µì‹¬: ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ â–¼ -------------------
    
    // 1. ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜
    function deleteSelected() {
      if (!selected) { alert('ì‚­ì œí•  ìš”ì†Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      
      const element = cy.getElementById(selected.id);
      if (element.length === 0) return;

      const confirmMsg = selected.type === 'node' 
        ? `'${element.data('label')}' ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ê²°ëœ ëª¨ë“  ì„ ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)` 
        : `'${element.data('label') || 'ê´€ê³„'}' ì„ ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

      if (confirm(confirmMsg)) {
        cy.remove(element);
        resetRightPanel(); // íŒ¨ë„ ì´ˆê¸°í™”
        // ì—°ê²° ì…ë ¥ì°½ì— ì‚­ì œëœ ë…¸ë“œê°€ ìˆë‹¤ë©´ ì´ˆê¸°í™”
        if (edgeSrcInput.value === selected.id || edgeTgtInput.value === selected.id) {
            clearEdgeInputs();
        }
        selected = null;
      }
    }

    // 2. í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (Delete, Backspace) ë¦¬ìŠ¤ë„ˆ
    document.addEventListener('keydown', function(event) {
        // ì…ë ¥ì°½(input, textarea)ì—ì„œ íƒ€ì´í•‘ ì¤‘ì¼ ë•ŒëŠ” ì‚­ì œ í‚¤ ë™ì‘ ì•ˆ í•¨ (ê¸€ì ì§€ì›Œì•¼ í•˜ë‹ˆê¹Œ)
        const tag = document.activeElement.tagName.toUpperCase();
        if (tag === 'INPUT' || tag === 'TEXTAREA') return;

        if (event.key === 'Delete' || event.key === 'Backspace') {
            if (selected) {
                deleteSelected();
            }
        }
    });

    // ------------------- â–² í•µì‹¬: ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ â–² -------------------


    function toggleDragMode() {
        isDragMode = !isDragMode;
        const btn = document.getElementById('btnDragMode');
        if (isDragMode) {
            btn.classList.add('drag-mode-active');
            btn.innerText = "ğŸ–±ï¸ ë“œë˜ê·¸ ëª¨ë“œ ON (ë…¸ë“œë¥¼ ì¡ê³  ë„ì„¸ìš”)";
            cy.userZoomingEnabled(false); cy.userPanningEnabled(false);
        } else {
            btn.classList.remove('drag-mode-active');
            btn.innerText = "ğŸ–±ï¸ ë“œë˜ê·¸ ì—°ê²° ëª¨ë“œ (ì¼œê¸°/ë„ê¸°)";
            cy.userZoomingEnabled(true); cy.userPanningEnabled(true);
        }
    }

    function resetRightPanel() {
        selected = null;
        notesInfo.innerText = "ë…¸ë“œ/ì—£ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”";
        labelInput.value = ''; notesTextarea.value = '';
        labelInput.disabled = true; notesTextarea.disabled = true;
        colorControl.style.display = 'none';
    }

    cy.on('tap', 'node', function (evt) {
      const node = evt.target; const nodeId = node.id();
      if (!isDragMode) {
          if (edgeSrcInput.value === '') { edgeSrcInput.value = nodeId; node.animate({ style: { 'border-color': '#4facfe', 'border-width': 4 } }, { duration: 200 }); }
          else if (edgeTgtInput.value === '' && edgeSrcInput.value !== nodeId) { edgeTgtInput.value = nodeId; node.animate({ style: { 'border-color': '#ff0055', 'border-width': 4 } }, { duration: 200 }); }
      }
      selected = { type: 'node', id: nodeId };
      notesInfo.innerText = "ë…¸ë“œ: " + nodeId;
      labelInput.value = node.data('label') || ''; notesTextarea.value = node.data('notes') || '';
      labelInput.disabled = false; notesTextarea.disabled = false;
      colorControl.style.display = 'block'; colorInput.value = node.data('color') || '#667eea';
    });

    cy.on('tap', 'edge', function (evt) {
      const edge = evt.target;
      selected = { type: 'edge', id: edge.id() };
      notesInfo.innerText = "ê´€ê³„: " + edge.data('source') + " â†’ " + edge.data('target');
      labelInput.value = edge.data('label') || ''; notesTextarea.value = edge.data('notes') || '';
      labelInput.disabled = false; notesTextarea.disabled = false;
      colorControl.style.display = 'none';
    });

    cy.on('tap', function(evt){ if(evt.target === cy){ resetRightPanel(); } });

    cy.on('dbltap', function (evt) {
      if (evt.target === cy) {
        const pos = evt.position, nodeName = prompt("ìƒˆ ë…¸ë“œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "ìƒˆ ë…¸ë“œ");
        if (nodeName && nodeName.trim()) {
          const id = nodeName.trim();
          if (cy.getElementById(id).length > 0) { alert("ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤!"); return; }
          const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
          cy.add({ data: { id: id, label: id, color: colors[Math.floor(Math.random() * colors.length)], notes: "" }, position: { x: pos.x, y: pos.y } });
          stopObsidianTremor(); startObsidianTremor();
        }
      }
    });

    cy.on('mousedown', 'node', function (evt) {
      if (evt.originalEvent.ctrlKey || evt.originalEvent.metaKey || isDragMode) {
        edgeCreationMode = true; edgeSourceNode = evt.target;
        evt.target.style({ 'border-width': '4px', 'border-color': '#43e97b', 'border-style': 'dashed' });
      }
    });
    cy.on('mouseover', 'node', function (evt) { if (edgeCreationMode && edgeSourceNode && evt.target.id() !== edgeSourceNode.id()) evt.target.style({ 'border-width': '4px', 'border-color': '#4facfe' }); });
    cy.on('mouseout', 'node', function (evt) { if (edgeCreationMode && edgeSourceNode && evt.target.id() !== edgeSourceNode.id()) evt.target.style('border-width', '2px'); });
    cy.on('mouseup', 'node', function (evt) {
      if (edgeCreationMode && edgeSourceNode && evt.target.id() !== edgeSourceNode.id()) {
        const label = prompt("ê´€ê³„ ë¼ë²¨ ì…ë ¥:", "");
        if (label !== null) {
          let classes = (label && (label.toUpperCase() === "TIMELINE" || label.toUpperCase() === "íƒ€ì„ë¼ì¸")) ? "timeline" : "";
          cy.add({ data: { id: edgeSourceNode.id() + "_" + evt.target.id() + "_" + Date.now(), source: edgeSourceNode.id(), target: evt.target.id(), label: label || "", notes: "" }, classes: classes });
          stopObsidianTremor(); startObsidianTremor();
        }
        edgeSourceNode.style('border-width', '2px'); edgeCreationMode = false; edgeSourceNode = null;
      }
    });
    cy.on('mouseup', function (evt) { if (edgeCreationMode && evt.target === cy) { if (edgeSourceNode) edgeSourceNode.style('border-width', '2px'); edgeCreationMode = false; edgeSourceNode = null; } });

    function clearEdgeInputs() { edgeSrcInput.value = ''; edgeTgtInput.value = ''; document.getElementById('edgeLbl').value = ''; }
    function swapEdgeInputs() { const temp = edgeSrcInput.value; edgeSrcInput.value = edgeTgtInput.value; edgeTgtInput.value = temp; }
    function addEdge() {
      const src = edgeSrcInput.value.trim(), tgt = edgeTgtInput.value.trim(), lbl = document.getElementById('edgeLbl').value.trim();
      if (!src || !tgt) { alert('ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”!'); return; }
      if (cy.getElementById(src).length === 0 || cy.getElementById(tgt).length === 0) { alert('ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤!'); return; }
      let classes = (lbl && (lbl.toUpperCase() === "TIMELINE" || lbl.toUpperCase() === "íƒ€ì„ë¼ì¸")) ? "timeline" : "";
      cy.add({ data: { id: src + "_" + tgt + "_" + Date.now(), source: src, target: tgt, label: lbl || "", notes: "" }, classes: classes });
      runLayout('cose'); document.getElementById('edgeLbl').value = '';
    }

    function addNode() {
      const id = document.getElementById('newNode').value.trim();
      if (!id) { alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!'); return; }
      if (cy.getElementById(id).length > 0) { alert('ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤!'); return; }
      const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
      cy.add({ data: { id: id, label: id, color: colors[Math.floor(Math.random() * colors.length)], notes: "" } });
      runLayout('cose'); document.getElementById('newNode').value = '';
    }

    function startObsidianTremor() {
      if (tremorInterval) return;
      tremorInterval = setInterval(() => {
        cy.nodes().forEach(node => {
            if(node.selected()) return;
            const degree = node.degree(); const tremorStrength = 5.0 / (1 + degree);
            node.position({ x: node.position('x') + (Math.random()-0.5)*tremorStrength, y: node.position('y') + (Math.random()-0.5)*tremorStrength });
        });
      }, 50); 
    }
    function stopObsidianTremor() { if (tremorInterval) { clearInterval(tremorInterval); tremorInterval = null; } }
    function runLayout(layoutName) {
      stopObsidianTremor(); if (currentLayout) { currentLayout.stop(); currentLayout = null; }
      let opts = layoutName === 'cose' ? { name: 'cose', animate: true, animationDuration: 500, fit: true, padding: 10, nodeRepulsion: 20000, idealEdgeLength: 150, gravity: 0.05 } : { name: 'dagre', rankDir: 'TB', padding: 10, animate: true };
      if(layoutName==='dagre') cy.nodes().unlock();
      const layout = cy.layout(opts); layout.run(); setTimeout(startObsidianTremor, 500); 
    }

    function saveNotes() {
      if (!selected) { alert('ì„ íƒëœ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const element = cy.getElementById(selected.id);
      if (element.length === 0) { alert('ì´ë¯¸ ì‚­ì œëœ ìš”ì†Œì…ë‹ˆë‹¤.'); resetRightPanel(); return; }
      
      const newLabel = labelInput.value.trim();
      if (!newLabel) { alert('ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
      element.data('label', newLabel); element.data('notes', notesTextarea.value);
      if (selected.type === 'node') element.data('color', colorInput.value);
      if (selected.type === 'edge') {
        if (newLabel.toUpperCase() === "TIMELINE" || newLabel.toUpperCase() === "íƒ€ì„ë¼ì¸") element.addClass('timeline'); else element.removeClass('timeline');
      }
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function saveToLocalStorage() { localStorage.setItem("graphData", JSON.stringify(cy.json().elements)); alert('ì €ì¥ ì™„ë£Œ!'); }
    function loadFromLocalStorage() {
      const data = localStorage.getItem("graphData");
      if (data) { cy.elements().remove(); cy.add(JSON.parse(data)); runLayout('cose'); alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!'); } else alert('ë°ì´í„° ì—†ìŒ');
    }
    function saveToURL() { window.location.hash = LZString.compressToEncodedURIComponent(JSON.stringify(cy.json().elements)); alert('URL ì €ì¥ ì™„ë£Œ!'); }
    function downloadJSON() {
      const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cy.json().elements, null, 2));
      a.download = "graph_" + new Date().toISOString().slice(0, 10) + ".json"; document.body.appendChild(a); a.click(); a.remove();
    }
    function extractElementsFromJSON(data) {
        let elements = [];
        if (data.graphData) {
            const gd = data.graphData;
            if (gd.nodes || gd.edges) elements = [...(gd.nodes||[]), ...(gd.edges||[])];
            else if (gd.elements) elements = gd.elements;
        }
        if (elements.length === 0) {
            if (Array.isArray(data)) elements = data;
            else if (data.nodes || data.edges) elements = [...(data.nodes||[]), ...(data.edges||[])];
            else if (data.elements) elements = Array.isArray(data.elements) ? data.elements : [...(data.elements.nodes||[]), ...(data.elements.edges||[])];
        }
        return elements;
    }
    function uploadJSON(event) {
      const file = event.target.files[0]; if (!file) return;
      const reader = new FileReader(); reader.onload = function (e) { try { const els = extractElementsFromJSON(JSON.parse(e.target.result)); if(els.length){ cy.elements().remove(); cy.add(els); runLayout('cose'); alert('ì„±ê³µ!'); } else alert('ë°ì´í„° ì—†ìŒ'); } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); } }; reader.readAsText(file);
    }
    function appendJSON(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = function (e) {
            try {
                const els = extractElementsFromJSON(JSON.parse(e.target.result)); if (!els.length) { alert('ë°ì´í„° ì—†ìŒ'); return; }
                const suffix = "_COPY_" + Date.now(), idMap = {}, newEls = [], offset = 500;
                els.forEach(el => { if (el.data && el.data.id && !el.data.source) { const old = el.data.id, nid = old + suffix; if (cy.getElementById(nid).length) return; const n = JSON.parse(JSON.stringify(el)); n.data.id = nid; n.position = n.position ? {x:n.position.x+offset,y:n.position.y+offset} : {x:cy.width()/2+offset,y:cy.height()/2+offset}; idMap[old] = nid; newEls.push(n); } });
                els.forEach(el => { if (el.data && el.data.source) { if (idMap[el.data.source] && idMap[el.data.target]) { const n = JSON.parse(JSON.stringify(el)); n.data.id = (n.data.id||"EDGE")+suffix; n.data.source = idMap[el.data.source]; n.data.target = idMap[el.data.target]; newEls.push(n); } } });
                if(newEls.length){ cy.add(newEls); runLayout('cose'); alert('ì¶”ê°€ ì™„ë£Œ!'); }
            } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); }
        }; reader.readAsText(file);
    }

    function loadVoices() {
      const vs = speechSynthesis.getVoices(), sel = document.getElementById('voiceSelect'); sel.innerHTML = '';
      const ko = vs.filter(v => v.lang.startsWith('ko'));
      if (ko.length) ko.forEach(v => sel.add(new Option(v.name, v.name))); else sel.add(new Option("ê¸°ë³¸ í•œêµ­ì–´", "default"));
    }
    if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices; loadVoices();
    function updateSpeedValue() { document.getElementById('speedValue').textContent = document.getElementById('speedControl').value + 'x'; }
    function readNotes() {
      const text = notesTextarea.value.trim(); if (!text) return; stopReading();
      currentUtterance = new SpeechSynthesisUtterance(text.replace(/[#*_~`\[\]{}()\-+=|\\<>]/g, ' '));
      const v = speechSynthesis.getVoices().find(v => v.name === document.getElementById('voiceSelect').value);
      if (v) currentUtterance.voice = v; currentUtterance.rate = parseFloat(document.getElementById('speedControl').value);
      speechSynthesis.speak(currentUtterance);
    }
    function stopReading() { if (speechSynthesis.speaking) speechSynthesis.cancel(); }

    // ====================================================================
    // âœ¨ Gemini í”„ë¡¬í”„íŠ¸ ë³µì‚¬ ë° ì±„íŒ… ì—´ê¸° í•¨ìˆ˜ (NEW)
    // ====================================================================
    function copyPromptAndOpenGemini() {
        const promptTextarea = document.getElementById('geminiPromptTemplate');
        const promptText = promptTextarea.value.trim();

        // 1. í…ìŠ¤íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
        const tempTextarea = document.createElement('textarea');
        tempTextarea.value = promptText;
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                alert("âœ… Gemini ìš”ì²­ í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ì œ ìƒˆ ì°½ì—ì„œ 'ë¶„ì„í•  í…ìŠ¤íŠ¸' ë¶€ë¶„ë§Œ ìˆ˜ì • í›„ Geminiì—ê²Œ ìš”ì²­í•˜ì„¸ìš”.");
            } else {
                alert("âŒ í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
            }
        } catch (err) {
            alert("âŒ í´ë¦½ë³´ë“œ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err);
        } finally {
            document.body.removeChild(tempTextarea);
        }
        
        // 2. Gemini ì±„íŒ… ì°½ì„ ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¸°
        const geminiUrl = "https://gemini.google.com/app";
        window.open(geminiUrl, "_blank"); 
    }

    // ====================================================================
    // ğŸ¤– JSON í…ìŠ¤íŠ¸ ë³€í™˜ ë° ì¶”ê°€ ê´€ë ¨ í•¨ìˆ˜ (NEW)
    // ====================================================================

    // í…ìŠ¤íŠ¸ ì˜ì—­ì—ì„œ JSON ë°ì´í„°ë¥¼ ì½ì–´ ê·¸ë˜í”„ì— ì¶”ê°€í•˜ê±°ë‚˜ ë®ì–´ì“°ëŠ” í•¨ìˆ˜
    function loadJSONFromTextarea(isAppend) {
        const jsonText = document.getElementById('jsonInputTextarea').value.trim();
        if (!jsonText) {
            alert('JSON í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            const data = JSON.parse(jsonText);
            // ê¸°ì¡´ì— ì •ì˜ëœ extractElementsFromJSON í•¨ìˆ˜ë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
            const els = extractElementsFromJSON(data);

            if (!els.length) {
                alert('ìœ íš¨í•œ ë…¸ë“œ/ì—£ì§€ ë°ì´í„°ê°€ JSONì—ì„œ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            if (isAppend) {
                // ì¶”ê°€ ë¡œì§ (ê¸°ì¡´ appendJSON ë¡œì§ê³¼ ìœ ì‚¬í•˜ê²Œ ID ì¤‘ë³µ ë°©ì§€ ë° ìœ„ì¹˜ ì¡°ì •)
                const suffix = "_COPY_" + Date.now(), idMap = {}, newEls = [], offset = 500;
                
                // ë…¸ë“œì˜ ID ë³€ê²½ ë° ìœ„ì¹˜ ì¡°ì •
                els.forEach(el => {
                    if (el.data && el.data.id && !el.data.source) { // Node
                        const old = el.data.id, nid = old + suffix;
                        if (cy.getElementById(nid).length) return; // Skip if ID collision still occurs (unlikely)
                        const n = JSON.parse(JSON.stringify(el));
                        n.data.id = nid;
                        // ìœ„ì¹˜ ì¡°ì •
                        n.position = n.position ? { x: n.position.x + offset, y: n.position.y + offset } : { x: cy.width() / 2 + offset, y: cy.height() / 2 + offset };
                        idMap[old] = nid;
                        newEls.push(n);
                    }
                });
                
                // ì—£ì§€ì˜ ID ë³€ê²½ ë° ì—°ê²° ë…¸ë“œ ID ì—…ë°ì´íŠ¸
                els.forEach(el => {
                    if (el.data && el.data.source) { // Edge
                        // ë§µí•‘ëœ ìƒˆ IDê°€ ì¡´ì¬í•˜ëŠ” ì—£ì§€ë§Œ ì¶”ê°€
                        if (idMap[el.data.source] && idMap[el.data.target]) {
                            const n = JSON.parse(JSON.stringify(el));
                            n.data.id = (n.data.id || "EDGE_TEXT") + suffix; // ì—£ì§€ IDë„ ê³ ìœ í•˜ê²Œ ë³€ê²½
                            n.data.source = idMap[el.data.source];
                            n.data.target = idMap[el.data.target];
                            newEls.push(n);
                        }
                    }
                });

                if (newEls.length) {
                    cy.add(newEls);
                    runLayout('cose');
                    alert(`JSON í…ìŠ¤íŠ¸ì—ì„œ ${newEls.length}ê°œì˜ ìš”ì†Œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
                } else {
                    alert('ì¶”ê°€í•  ìƒˆë¡œìš´ ë…¸ë“œ/ì—£ì§€ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

            } else {
                // ë®ì–´ì“°ê¸° ë¡œì§
                cy.elements().remove();
                cy.add(els);
                runLayout('cose');
                alert('JSON í…ìŠ¤íŠ¸ë¡œ ê·¸ë˜í”„ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë®ì–´ì¼ìŠµë‹ˆë‹¤!');
            }

        } catch (err) {
            alert('JSON íŒŒì‹± ì˜¤ë¥˜! ìœ íš¨í•œ JSON í˜•ì‹ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.\nì˜¤ë¥˜: ' + err.message);
        }
    }
  </script>
</body>
</html>