<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„¸ê³„ê´€ ê·¸ë˜í”„ í¸ì§‘ê¸° (Complete Ver)</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <!-- Transformers.js v3 for Supertonic 2 -->
  <script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@latest';
    window.transformers = { pipeline, env };
  </script>
  <!-- lamejs for MP3 encoding -->
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Malgun Gothic', sans-serif;
      background: #f0f0f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      font-size: 1.5em;
      margin-bottom: 5px;
      text-shadow: 1px 1px 0 #000;
    }

    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .left-panel {
      width: 25%;
      background: white;
      padding: 15px;
      overflow-y: auto;
      border-right: 2px solid #ddd;
    }

    .graph-area {
      width: 50%;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .right-panel {
      width: 25%;
      background: white;
      padding: 15px;
      overflow-y: auto;
      border-left: 2px solid #ddd;
      display: flex;
      flex-direction: column;
    }

    #cy {
      flex: 1;
      /* border/radius/bg moved to .cy-wrapper */
    }

    .panel-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .panel-section h3 {
      font-size: 1em;
      margin-bottom: 10px;
      color: #667eea;
      border-bottom: 2px solid #667eea;
      padding-bottom: 5px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9em;
    }

    input[readonly] {
      background-color: #e9ecef;
      color: #495057;
      cursor: not-allowed;
    }

    button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 4px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.1s;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 0 #000;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .btn-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff5f6d 0%, #ffc371 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      color: white;
    }

    button:active {
      transform: scale(0.98);
    }

    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Malgun Gothic', monospace;
      font-size: 0.9em;
      resize: vertical;
      min-height: 150px;
    }

    .notes-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .notes-textarea {
      flex: 1;
      min-height: 200px;
      line-height: 1.6;
    }

    .tts-controls {
      padding: 10px;
      background: #f0f7ff;
      border-radius: 6px;
      border: 1px solid #d0e7ff;
    }

    .tts-loading {
      font-size: 0.8em;
      color: #764ba2;
      font-weight: bold;
      margin-top: 5px;
      display: none;
    }

    .speed-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .speed-control input[type="range"] {
      flex: 1;
    }

    .tts-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .info-badge {
      display: inline-block;
      padding: 6px 12px;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 0.85em;
      margin-bottom: 10px;
      text-shadow: 1px 1px 0 #000;
    }

    .help-text {
      font-size: 0.8em;
      color: #888;
      margin-top: 5px;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .connection-tools {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
    }

    .connection-tools button {
      padding: 5px;
      font-size: 0.8em;
      margin: 0;
    }

    .drag-mode-active {
      background: #ff0055 !important;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.7);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(255, 0, 85, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(255, 0, 85, 0);
      }
    }

    /* === NEW STYLES for Gemini Shortcut and Help Text === */
    .btn-gemini {
      background-color: #5555ff;
      /* Geminië¥¼ ìƒì§•í•˜ëŠ” íŒŒë€ìƒ‰ ê³„ì—´ */
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      font-weight: bold;
      transition: background-color 0.2s;
      text-shadow: 1px 1px 0 #000;
      /* ê¸°ì¡´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ê³¼ í†µì¼ */
    }

    .btn-gemini:hover {
      background-color: #4444cc;
    }

    .help-text-api {
      font-size: 0.85em;
      color: #333;
      margin-top: 8px;
      padding: 8px;
      border: 1px dashed #5555ff;
      /* Gemini ìƒ‰ìƒì— ë§ì¶˜ ì ì„  í…Œë‘ë¦¬ */
      border-radius: 4px;
      background: #e6e6ff;
      /* ì—°í•œ ë°°ê²½ìƒ‰ */
      margin-bottom: 10px;
    }

    /* === NEW STYLES for Floating Image Windows === */
    .node-image-toggle {
      position: absolute;
      z-index: 999;
      width: 24px;
      height: 24px;
      background: #fff;
      border: 2px solid #333;
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
      transition: transform 0.1s;
    }

    .node-image-toggle:hover {
      transform: scale(1.1);
      background: #f0f0f0;
    }

    .node-image-popup {
      position: absolute;
      z-index: 9999;
      background: white;
      border: 1px solid #ccc;
      padding: 5px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      /* min-width, max-width ì œê±°: JSì—ì„œ ë…¸ë“œ í¬ê¸°ì— ë§ì¶¤ */
      display: none;
      pointer-events: auto;
      resize: both;
      overflow: auto;
      min-width: 200px;
      min-height: 150px;
    }

    /* Content Types Styles */
    .node-content-text {
      font-size: 0.9em;
      line-height: 1.4;
      color: #333;
      white-space: pre-wrap;
      /* ì¤„ë°”ê¿ˆ ë³´ì¡´ */
      background: #f9f9f9;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #eee;
      width: 100%;
      height: 100%;
    }

    .node-content-iframe {
      width: 100%;
      height: 200px;
      /* ê¸°ë³¸ ë†’ì´ */
      border: none;
      border-radius: 4px;
    }

    .node-content-video {
      width: 100%;
      border-radius: 4px;
    }

    .node-content-link-card {
      padding: 10px;
      background: #f0f7ff;
      border: 1px solid #d0e7ff;
      border-radius: 4px;
      text-align: center;
      margin-bottom: 5px;
    }

    .node-content-link-card a {
      color: #0066cc;
      font-weight: bold;
      text-decoration: none;
    }

    .node-content-link-card a:hover {
      text-decoration: underline;
    }

    .node-image-popup img {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
    }

    .node-image-popup .close-btn {
      display: block;
      text-align: center;
      background: #ff5f6d;
      color: white;
      font-size: 0.8em;
      padding: 2px;
      cursor: pointer;
      margin-top: 5px;
      border-radius: 4px;
      font-weight: bold;
    }

    /* Wrapper for overlay positioning */
    .cy-wrapper {
      position: relative;
      flex: 1;
      width: 100%;
      height: 100%;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
      /* overflow: hidden;  <-- ì ì‹œ í•´ì œí•˜ì—¬ ì˜ë¦¼ ë¬¸ì œ í™•ì¸ */
    }

    #cy {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      /* ë°°ê²½ì€ wrapperê°€ ë‹´ë‹¹ */
      border: none;
      /* wrapperì— í…Œë‘ë¦¬ */
    }

    #overlays {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      /* í´ë¦­ í†µê³¼ */
      z-index: 10;
      overflow: hidden;
      /* ì¤‘ìš” */
    }

    .node-image-toggle {
      pointer-events: auto;
      /* ì¤‘ìš”: ë²„íŠ¼ì€ í´ë¦­ ê°€ëŠ¥í•´ì•¼ í•¨ */
      /* ... existing styles ... */
    }
  </style>
</head>

<body>
  <header>
    <h1>ğŸŒ ì„¸ê³„ê´€ ê·¸ë˜í”„ í¸ì§‘ê¸° (ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)</h1>
    <p>í´ë¦­ ì—°ê²° + ë“œë˜ê·¸ ì—°ê²° + ì„ íƒ ì‚­ì œ ê¸°ëŠ¥ í†µí•© ë²„ì „</p>
  </header>

  <div class="main-container">
    <div class="left-panel">
      <div class="panel-section">
        <h3>â• ë…¸ë“œ ì¶”ê°€</h3>
        <input type="text" id="newNode" placeholder="ë…¸ë“œ ì´ë¦„ (ì˜ˆ: ì² ìˆ˜)">
        <button class="btn-primary" onclick="addNode()">ë…¸ë“œ ì¶”ê°€</button>
        <div class="help-text">ğŸ’¡ ë¹ˆ ê³µê°„ ë”ë¸”í´ë¦­ìœ¼ë¡œë„ ì¶”ê°€ ê°€ëŠ¥</div>
      </div>

      <div class="panel-section">
        <h3>ğŸ”— ê´€ê³„ ì—°ê²°</h3>
        <div class="connection-tools">
          <button class="btn-info" onclick="clearEdgeInputs()" title="ì…ë ¥ ì´ˆê¸°í™”">ğŸ”„ ì´ˆê¸°í™”</button>
          <button class="btn-info" onclick="swapEdgeInputs()" title="ì¶œë°œ/ë„ì°© ë°”ê¾¸ê¸°">â†”ï¸ êµì²´</button>
        </div>
        <input type="text" id="edgeSrc" placeholder="1. ì¶œë°œ ë…¸ë“œ í´ë¦­" readonly
          style="background-color: #e3f2fd; cursor: pointer;">
        <input type="text" id="edgeTgt" placeholder="2. ë„ì°© ë…¸ë“œ í´ë¦­" readonly
          style="background-color: #ffebee; cursor: pointer;">
        <input type="text" id="edgeLbl" placeholder="ê´€ê³„ ë¼ë²¨ (ì˜ˆ: ì¹œêµ¬, ì )">
        <button class="btn-primary" onclick="addEdge()">ì—°ê²° ì¶”ê°€</button>
        <div class="help-text">ğŸ’¡ ê·¸ë˜í”„ì—ì„œ ë…¸ë“œë¥¼ <b>í´ë¦­</b>í•˜ë©´ ìœ„ ì¹¸ì— ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.</div>
      </div>

      <div class="panel-section">
        <h3>ğŸ“‚ ë°ì´í„° ê´€ë¦¬</h3>
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="uploadJSON(event)">
        <button class="btn-info" onclick="document.getElementById('fileInput').click()">â¬†ï¸ JSON ì—…ë¡œë“œ</button>
        <input type="file" id="appendFileInput" accept=".json" style="display:none" onchange="appendJSON(event)">
        <button class="btn-primary" onclick="document.getElementById('appendFileInput').click()">â• JSON ì¶”ê°€ ì—…ë¡œë“œ</button>
        <button class="btn-success" onclick="downloadJSON()" style="margin-top: 5px;">ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ(ì €ì¥)</button>

        <div class="panel-section">
          <h3>ğŸ“ ë¶„ì„ ëŒ€ìƒ í…ìŠ¤íŠ¸ ì…ë ¥</h3>
          <textarea id="sourceTextInput" placeholder="ì—¬ê¸°ì— ì†Œì„¤/ì‹œë‚˜ë¦¬ì˜¤ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." style="height: 120px;"></textarea>
        </div>

        <div class="panel-section">
          <h3>ğŸ¤– AI ë¶„ì„ (Gemini)</h3>

          <!-- Tab-like or Toggle for Settings -->
          <h4 style="margin: 10px 0 5px 0; font-size: 0.9em; color: #555;">âš™ï¸ API ì„¤ì • (ìë™ ë¶„ì„ìš©)</h4>
          <div style="background: #f0f0f0; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
            <input type="password" id="geminiApiKey" placeholder="Gemini API Key" onchange="saveApiKeys()">
            <input type="password" id="googleSearchKey" placeholder="Google Search API Key (Image)"
              onchange="saveApiKeys()">
            <input type="text" id="googleCxId" placeholder="Custom Search CX ID" onchange="saveApiKeys()">
            <div style="font-size: 0.75em; color: #888; margin-top: 5px;">* í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.</div>
          </div>

          <h4 style="margin: 10px 0 5px 0; font-size: 0.9em; color: #555;">ğŸš€ ì‹¤í–‰ ëª¨ë“œ</h4>

          <!-- Button 1: Manual -->
          <button class="btn-gemini" onclick="copyPromptAndOpenGemini()">ğŸ“‹ 1. [ìˆ˜ë™] í”„ë¡¬í”„íŠ¸ ë³µì‚¬ & ì±„íŒ…</button>
          <div class="help-text" style="margin-bottom: 10px;">í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ Gemini ì›¹ì‚¬ì´íŠ¸ì— ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤. (ì´ë¯¸ì§€ ìˆ˜ë™ ì²¨ë¶€ ê°€ëŠ¥)</div>

          <!-- Button 2: Auto -->
          <button class="btn-primary" onclick="runAutoAnalysis()"
            style="background: linear-gradient(135deg, #FF6B6B 0%, #556270 100%);">ğŸš€ 2. [ìë™] ì›í´ë¦­ ë¶„ì„ + ì´ë¯¸ì§€</button>
          <div class="help-text">APIë¥¼ ì‚¬ìš©í•´ ê·¸ë˜í”„ë¥¼ ìƒì„±í•˜ê³  ìºë¦­í„° ì´ë¯¸ì§€ë¥¼ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.</div>

          <!-- Hidden Template -->
          <textarea id="geminiPromptTemplate" style="display:none;">
**ì£¼ì˜: ì´ ìš”ì²­ì— ëŒ€í•´ JSON ì½”ë“œ ë¸”ë¡ ì™¸ì˜ ì–´ë– í•œ ì„¤ëª…, ì¸ì‚¬ë§, ì¶”ê°€ í…ìŠ¤íŠ¸ë„ ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”. ì˜¤ì§ JSON ì½”ë“œ ë¸”ë¡ë§Œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.**

ë‹¹ì‹ ì€ í…ìŠ¤íŠ¸(ë˜ëŠ” ì´ë¯¸ì§€)ë¥¼ ë¶„ì„í•˜ì—¬ ê´€ê³„í˜• ë°ì´í„°(ë…¸ë“œì™€ ì—£ì§€)ë¥¼ Cytoscape.js ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì í•©í•œ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤.

ë‹¤ìŒ [ë¶„ì„ ëŒ€ìƒ í…ìŠ¤íŠ¸]ë¥¼ ë¶„ì„í•˜ì—¬ ë“±ì¥ì¸ë¬¼(ë…¸ë“œ)ê³¼ ê´€ê³„(ì—£ì§€)ë¥¼ ì¶”ì¶œí•˜ê³ , ìš”ì²­ëœ í˜•ì‹ì— ë§ì¶° **JSON ì½”ë“œ ë¸”ë¡**ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.
**ë˜í•œ, ë¶„ì„ëœ ë‚´ìš©ê³¼ ì–´ìš¸ë¦¬ëŠ” ì´ë¯¸ì§€ URLì´ ìˆë‹¤ë©´ 'image' í•„ë“œì— ì¶”ê°€í•´ì£¼ì„¸ìš”.**

### ë¶„ì„ ëŒ€ìƒ í…ìŠ¤íŠ¸ ###
{{SOURCE_TEXT}}

### ì¶œë ¥ í˜•ì‹ (JSON Only) ###
```json
{
  "elements": [
    {"data": {"id": "ì² ìˆ˜", "label": "ì² ìˆ˜", "color": "#667eea", "image": "https://example.com/chulsu.jpg"}},
    {"data": {"id": "ì˜í¬", "label": "ì˜í¬", "color": "#f093fb", "image": ""}},
    {"data": {"source": "ì² ìˆ˜", "target": "ì˜í¬", "label": "ì¹œêµ¬"}}
  ]
}
```
</textarea>
        </div>
      </div>

      <div class="panel-section">
        <h3>ğŸ¤– JSON í…ìŠ¤íŠ¸ ë³€í™˜ (ìˆ˜ë™)</h3>
        <textarea id="jsonInputTextarea" placeholder="ì—¬ê¸°ì— JSON í˜•ì‹ì˜ ë…¸ë“œ/ì—£ì§€ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ìì—°ì–´ ì²˜ë¦¬ ì•„ë‹˜)" rows="8"></textarea>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
          <button class="btn-primary" onclick="loadJSONFromTextarea(false)">âœ”ï¸ JSONìœ¼ë¡œ ë®ì–´ì“°ê¸°</button>
          <button class="btn-success" onclick="loadJSONFromTextarea(true)">â• JSON ì¶”ê°€í•˜ê¸°</button>
        </div>
        <div class="help-text">âš ï¸ **ì£¼ì˜:** ì´ ê¸°ëŠ¥ì€ ìì—°ì–´ ì²˜ë¦¬ê°€ ì•„ë‹Œ, **ìœ íš¨í•œ JSON í…ìŠ¤íŠ¸**ë¥¼ ì½ì–´ ê·¸ë˜í”„ì— ë°˜ì˜í•©ë‹ˆë‹¤.</div>
      </div>

      <div class="panel-section">
        <h3>âœ¨ ë ˆì´ì•„ì›ƒ ë° ë„êµ¬</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px;">
          <button class="btn-info" onclick="runLayout('cose')"> ê¸°ë³¸ ì •ë ¬</button>
          <button class="btn-info" onclick="runLayout('dagre')">ğŸŒ² íŠ¸ë¦¬(ì„¸ë¡œ)</button>
          <button class="btn-info" onclick="runLayout('mindmap')">ğŸ§  ë§ˆì¸ë“œë§µ(ê°€ë¡œ)</button>
          <button class="btn-info" id="btnDragMode" onclick="toggleDragMode()">ğŸ–±ï¸ ë“œë˜ê·¸ ëª¨ë“œ</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px;">
          <button class="btn-info" id="btnTremorMode" onclick="toggleTremor()">ğŸŒŠ ìˆ¨ì‰¬ê¸° ëª¨ë“œ ON</button>
          <button class="btn-danger" onclick="deleteSelected()">ğŸ—‘ï¸ ì‚­ì œ (Del)</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr; gap: 5px;">
          <button class="btn-success" onclick="saveToUrl()">ğŸ”— URL ê³µìœ </button>
        </div>
      </div>
    </div>

    <div class="graph-area">
      <!-- Wrapper div added for correct positioning -->
      <div class="cy-wrapper">
        <div id="cy"></div>
        <div id="overlays"></div>
      </div>
    </div>

    <div class="right-panel">
      <div class="panel-section notes-area">
        <h3>âœï¸ ì†ì„± í¸ì§‘ / ì‚­ì œ</h3>
        <div class="info-badge" id="notesInfo">ë…¸ë“œ/ì—£ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>

        <label style="font-weight: bold; color: #333;">ì´ë¦„/ë¼ë²¨</label>
        <input type="text" id="labelInput" placeholder="ì„ íƒí•œ ìš”ì†Œì˜ ì´ë¦„" disabled>

        <div id="colorControl" style="display:none;">
          <label style="font-weight: bold; color: #333; margin-top: 10px;">ë…¸ë“œ ìƒ‰ìƒ</label>
          <input type="color" id="colorInput" value="#667eea" style="height: 40px; padding: 0;">

          <label style="font-weight: bold; color: #333; margin-top: 10px;">ğŸ“ ì²¨ë¶€ (ì´ë¯¸ì§€/ì˜ìƒ/ë§í¬/í…ìŠ¤íŠ¸)</label>
          <div style="display: flex; gap: 5px;">
            <input type="text" id="imageInput" placeholder="URL, ìœ íŠœë¸Œì£¼ì†Œ, í…ìŠ¤íŠ¸, ë˜ëŠ” íŒŒì¼ì„ íƒ" style="flex:1;">
            <input type="file" id="hiddenFileInput" style="display:none;" onchange="handleFileUpload(this)">
            <button class="btn-info" onclick="document.getElementById('hiddenFileInput').click()"
              style="width: auto; padding: 0 10px;">ğŸ“‚ ì„ íƒ</button>
          </div>
          <label style="font-weight: bold; color: #333; margin-top: 10px;">ğŸ“ ë©”ëª¨</label>
          <textarea class="notes-textarea" id="notesTextarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <button class="btn-success" onclick="saveNotes()">ğŸ’¾ ì €ì¥</button>
            <button class="btn-danger" onclick="deleteSelected()">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
          <div class="help-text">ğŸ’¡ ì„ íƒ í›„ Delete í‚¤ë¥¼ ëˆŒëŸ¬ë„ ì‚­ì œë©ë‹ˆë‹¤.</div>

          <div class="tts-controls">
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
              <span>AI ìŒì„± ì—ë””ì…˜ v1.1</span>
              <button id="btnClearCache" class="btn-secondary" onclick="clearTransformersCache()"
                style="padding: 2px 8px; font-size: 11px;">ìºì‹œ ì´ˆê¸°í™”</button>
            </div>
            <h3>ğŸ”Š ì½ì–´ì£¼ê¸° (TTS)</h3>

            <div style="margin-bottom: 8px;">
              <label style="font-size: 0.85em; font-weight: bold; display: block; margin-bottom: 3px;">TTS ì—”ì§„ ì„ íƒ</label>
              <select id="ttsProvider" onchange="updateVoiceList()">
                <option value="system">ì‹œìŠ¤í…œ ê¸°ë³¸ (Web Speech)</option>
                <option value="supertonic">ìŠˆí¼í† ë‹‰ 2 (ê³ í’ˆì§ˆ ì˜¤í”ˆì†ŒìŠ¤)</option>
              </select>
            </div>

            <label style="font-size: 0.85em; font-weight: bold; display: block; margin-bottom: 3px;">ëª©ì†Œë¦¬ ì„ íƒ</label>
            <select id="voiceSelect">
              <option value="ko-KR">í•œêµ­ì–´</option>
            </select>

            <div id="ttsLoadingStatus" class="tts-loading">â³ ìŠˆí¼í† ë‹‰ ëª¨ë¸ ë¡œë”© ì¤‘... (ì´ˆê¸° 1íšŒ ë°œìƒ)</div>

            <div class="speed-control">
              <input type="range" id="speedControl" min="0.5" max="2.0" step="0.1" value="1.0"
                oninput="updateSpeedValue()">
              <span class="speed-value" id="speedValue">1.0x</span>
            </div>
            <div class="tts-buttons">
              <button class="btn-primary" id="btnTtsRead" onclick="readNotes()">ğŸ”Š ì½ê¸°</button>
              <button class="btn-danger" onclick="stopReading()">â¹ï¸ ì •ì§€</button>
            </div>
            <button class="btn-success" id="btnDownloadMp3" onclick="downloadMp3()"
              style="margin-top: 5px; display: none;">ğŸ’¾ MP3 ì €ì¥</button>
            <div class="help-text" style="font-size: 0.75em;">ğŸ’¡ <code>[Sarah] ì•ˆë…•! [Alex] ë°˜ê°€ì›Œ</code> ì²˜ëŸ¼ ì´ë¦„ì„ ëŒ€ê´„í˜¸ ì•ˆì— ë„£ìœ¼ë©´
              ëª©ì†Œë¦¬ê°€ ìë™ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ğŸ›¡ï¸ ê¸€ë¡œë²Œ ì—ëŸ¬ í•¸ë“¤ëŸ¬ (ë””ë²„ê¹…ìš©)
      window.onerror = function (msg, url, line, col, error) {
        alert("ì˜¤ë¥˜ ë°œìƒ: " + msg + "\në¼ì¸: " + line);
        return false;
      };

      let initialData = [
        { "data": { "id": "STC_01", "label": "STC 01 ì˜¤í”„ë‹ ì´ë¯¸ì§€", "color": "#ffaa00", "image": "", "notes": "ì´ì•¼ê¸°ì˜ ì‹œì‘ì„ ì•Œë¦¬ëŠ” ê°•ë ¬í•œ ì²«ì¸ìƒ. ì£¼ì¸ê³µì˜ í˜„ì¬ ìƒí™©ê³¼ ì„¸ê³„ì˜ í†¤ì„ ì‹œê°ì ìœ¼ë¡œ ì••ì¶•í•´ ë³´ì—¬ì¤ë‹ˆë‹¤." }, "position": { "x": 1056.12, "y": 299.83 }, "group": "nodes" },
        { "data": { "id": "STC_02", "label": "STC 02 í…Œë§ˆ ì œì‹œ", "color": "#ffaa00", "image": "", "notes": "ì£¼ì¸ê³µì´ ì—¬ì •ì„ í†µí•´ ê¹¨ë‹¬ì•„ì•¼ í•  í•µì‹¬ êµí›ˆì´ë‚˜ ì² í•™ì  ì£¼ì œê°€ ëŒ€ì‚¬ í˜¹ì€ ì•”ì‹œë¥¼ í†µí•´ ë“œëŸ¬ë‚©ë‹ˆë‹¤." }, "position": { "x": 1055.5, "y": 667.61 }, "group": "nodes" },
        { "data": { "id": "STC_03", "label": "STC 03 ì„¸íŠ¸ì—…", "color": "#ffaa00", "image": "", "notes": "ì£¼ì¸ê³µì˜ ê²°í•(ì•½ì )ê³¼ ê³ ì³ì•¼ í•  ì¼ìƒì„ ì†Œê°œí•©ë‹ˆë‹¤. ë“±ì¥ì¸ë¬¼ì˜ ê´€ê³„ë§ì´ í˜•ì„±ë˜ëŠ” ì§€ì ì…ë‹ˆë‹¤." }, "position": { "x": 934.09, "y": 1050.29 }, "group": "nodes" },
        { "data": { "id": "STC_04", "label": "STC 04 ì´‰ë§¤ ì‚¬ê±´", "color": "#ffaa00", "image": "", "notes": "ì¼ìƒì„ ë’¤í”ë“œëŠ” ê²°ì •ì  ì‚¬ê±´. ì£¼ì¸ê³µì´ ë³€í™”ë¥¼ ê±°ë¶€í•  ìˆ˜ ì—†ê²Œ ë§Œë“œëŠ” ì™¸ë¶€ì  ì¶©ê²©ì…ë‹ˆë‹¤." }, "position": { "x": 990.38, "y": 1282.07 }, "group": "nodes" },
        { "data": { "id": "STC_05", "label": "STC 05 ê³ ë¯¼/ì €í•­", "color": "#ffaa00", "image": "", "notes": "ìƒˆë¡œìš´ ì„¸ê³„ë¡œ ë‚˜ì•„ê°€ê¸° ì „ì˜ ë‘ë ¤ì›€ê³¼ ì£¼ì €í•¨. ì£¼ì¸ê³µì´ ì„ íƒì˜ ê¸°ë¡œì—ì„œ ê²ªëŠ” ë‚´ë¶€ì  ê°ˆë“±ì…ë‹ˆë‹¤." }, "position": { "x": 917.59, "y": 1429.27 }, "group": "nodes" },
        { "data": { "id": "STC_06", "label": "STC 06 2ë§‰ ì§„ì…", "color": "#ffaa00", "image": "", "notes": "ì£¼ì¸ê³µì´ ëŠ¥ë™ì ìœ¼ë¡œ êµ¬ì„¸ê³„ë¥¼ ë– ë‚˜ ì‹ ì„¸ê³„ë¥¼ ì„ íƒí•˜ëŠ” ì§€ì . ë˜ëŒì•„ê°ˆ ìˆ˜ ì—†ëŠ” ê°•ì„ ê±´ë„ˆëŠ” ìˆœê°„ì…ë‹ˆë‹¤." }, "position": { "x": 1023.06, "y": 1621.07 }, "group": "nodes" },
        { "data": { "id": "STC_07", "label": "STC 07 BìŠ¤í† ë¦¬", "color": "#ffaa00", "image": "", "notes": "ì£¼ë¡œ ë¡œë§¨ìŠ¤ë‚˜ ìš°ì •ì„ í†µí•´ í…Œë§ˆë¥¼ í•™ìŠµí•˜ëŠ” ë¶€ì°¨ì  ì´ì•¼ê¸°. ì£¼ì¸ê³µì˜ ì •ì„œì  ì„±ì¥ì„ ë•ëŠ” ê´€ê³„ì…ë‹ˆë‹¤." }, "position": { "x": 990.38, "y": 1805.23 }, "group": "nodes" },
        { "data": { "id": "STC_08", "label": "STC 08 ì¦ê±°ì›€ê³¼ ê²Œì„", "color": "#ffaa00", "image": "", "notes": "ì‘í’ˆì˜ í•µì‹¬ ì¬ë¯¸(ì¥ë¥´ì  ì¾Œê°)ê°€ ë°œíœ˜ë˜ëŠ” êµ¬ê°„. ì£¼ì¸ê³µì´ ìƒˆë¡œìš´ í™˜ê²½ì„ íƒí—˜í•˜ê±°ë‚˜ ì†Œì†Œí•œ ìŠ¹ë¦¬ë¥¼ ì–»ìŠµë‹ˆë‹¤." }, "position": { "x": 1065.25, "y": 2106.49 }, "group": "nodes" },
        { "data": { "id": "STC_09", "label": "STC 09 ë¯¸ë“œí¬ì¸íŠ¸", "color": "#ffaa00", "image": "", "notes": "ì´ì•¼ê¸°ì˜ ì •ì¤‘ì•™. ì„±ê³µì´ ìµœê³ ì¡°ì— ë‹¬í•˜ê±°ë‚˜(ê°€ì§œ ìŠ¹ë¦¬) ì™„ì „í•œ ì ˆë§(ê°€ì§œ íŒ¨ë°°)ì„ ë§›ë³´ë©° ë°©í–¥ì´ ê¸‰ì„ íšŒí•©ë‹ˆë‹¤." }, "position": { "x": 879.8, "y": 2338.5 }, "group": "nodes" },
        { "data": { "id": "STC_10", "label": "STC 10 ì•…ë‹¹ì˜ ì••ë°•", "color": "#ffaa00", "image": "", "notes": "ì•…ë‹¹ ì„¸ë ¥ì´ ë°˜ê²©ì„ ì‹œì‘í•˜ë©° ì£¼ì¸ê³µì˜ ì•½ì ì„ íŒŒê³ ë“­ë‹ˆë‹¤. ì£¼ì¸ê³µì˜ ìì›ì´ ë°”ë‹¥ë‚˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤." }, "position": { "x": 795.68, "y": 2282.88 }, "group": "nodes" },
        { "data": { "id": "STC_11", "label": "STC 11 ëª¨ë‘ ìƒì—ˆë‹¤", "color": "#ffaa00", "image": "", "notes": "ì£¼ì¸ê³µì´ ê°€ì¥ ì†Œì¤‘í•œ ê²ƒì„ ìƒê±°ë‚˜ í¬ë§ì„ ì™„ì „íˆ ìƒì‹¤í•˜ëŠ” ì§€ì . ì£½ìŒì˜ í–¥ê¸°ê°€ ê°€ì¥ ì§™ì€ ìˆœê°„ì…ë‹ˆë‹¤." }, "position": { "x": 580.87, "y": 2193.38 }, "group": "nodes" },
        { "data": { "id": "STC_12", "label": "STC 12 ì˜í˜¼ì˜ ì•”í‘ê¸°", "color": "#ffaa00", "image": "", "notes": "ì ˆë§ì˜ ì‹¬ì—°ì—ì„œ ìì‹ ì„ ë˜ëŒì•„ë³´ëŠ” ì‹œê°„. ì´ì „ì˜ ë°©ì‹ì„ ë²„ë¦¬ê³  ìƒˆë¡œìš´ ì¡´ì¬ë¡œ ê±°ë“­ë‚˜ê¸° ìœ„í•œ ë‚´ì  ì‚°í†µì…ë‹ˆë‹¤." }, "position": { "x": 383.52, "y": 2190.41 }, "group": "nodes" },
        { "data": { "id": "STC_13", "label": "STC 13 3ë§‰ ì§„ì…", "color": "#ffaa00", "image": "", "notes": "ë“œë””ì–´ í•´ê²°ì±…(AìŠ¤í† ë¦¬ì™€ BìŠ¤í† ë¦¬ì˜ ê²°í•©)ì„ ì°¾ì•„ë‚´ê³ , ë§ˆì§€ë§‰ ëŒ€ê²°ì„ í–¥í•´ ë‹¹ë‹¹íˆ ë‚˜ì•„ê°‘ë‹ˆë‹¤." }, "position": { "x": 341.38, "y": 2477.07 }, "group": "nodes" },
        { "data": { "id": "STC_14", "label": "STC 14 í”¼ë‚ ë ˆ", "color": "#ffaa00", "image": "", "notes": "ìµœì¢… ê²°ì „. ì£¼ì¸ê³µì€ ìƒˆë¡œìš´ í†µì°°ì„ ì´ìš©í•´ êµ¬ì„¸ê³„ë¥¼ ì •í™”í•˜ê³  ë¹ŒëŸ°ì„ ë¬¼ë¦¬ì¹©ë‹ˆë‹¤." }, "position": { "x": 232.56, "y": 2719.57 }, "group": "nodes" },
        { "data": { "id": "STC_15", "label": "STC 15 ì—”ë”© ì´ë¯¸ì§€", "color": "#ffaa00", "image": "", "notes": "ì˜¤í”„ë‹ê³¼ ì™„ë²½íˆ ëŒ€ë¹„ë˜ëŠ” ë§ˆë¬´ë¦¬ ì¥ë©´. ì£¼ì¸ê³µì˜ ì‚¶ì´ ì–´ë–»ê²Œ ì§„í™”í–ˆëŠ”ì§€ë¥¼ ì‹œê°ì ìœ¼ë¡œ ì¦ëª…í•©ë‹ˆë‹¤." }, "position": { "x": -92.22, "y": 2587.07 }, "group": "nodes" },

        { "data": { "id": "TRB_01", "label": "TRB 01 ìê¸°ì¸ì‹Â·í•„ìš”Â·ìš•ë§", "color": "#4facfe", "image": "", "notes": "ì£¼ì¸ê³µì˜ ê²°í•(í•„ìš”)ê³¼ ê²‰ìœ¼ë¡œ ë“œëŸ¬ë‚œ ëª©í‘œ(ìš•ë§)ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì´ì•¼ê¸°ì˜ ì›ë™ë ¥ì´ ì •ì˜ë©ë‹ˆë‹¤." }, "position": { "x": 543.11, "y": 1307.29 }, "group": "nodes" },
        { "data": { "id": "TRB_02", "label": "TRB 02 ìœ ë ¹ê³¼ ìŠ¤í† ë¦¬ ì„¸ê³„", "color": "#4facfe", "image": "", "notes": "ì£¼ì¸ê³µì˜ ë°œëª©ì„ ì¡ëŠ” ê³¼ê±°ì˜ ìƒì²˜(ìœ ë ¹)ì™€ ê·¸ê²ƒì´ ì§€ë°°í•˜ëŠ” ê³µê°„ì  ë°°ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤." }, "position": { "x": 1057.7, "y": 48.06 }, "group": "nodes" },
        { "data": { "id": "TRB_03", "label": "TRB 03 ì•½ì ê³¼ í•„ìš”", "color": "#4facfe", "image": "", "notes": "ì£¼ì¸ê³µì´ ì¸ê°„ìœ¼ë¡œì„œ ê°€ì§„ ë„ë•ì /ì‹¬ë¦¬ì  ë§¹ì . ì„±ê³µì„ ìœ„í•´ ë°˜ë“œì‹œ ê·¹ë³µí•´ì•¼ í•˜ëŠ” ìˆ™ì œì…ë‹ˆë‹¤." }, "position": { "x": 761.24, "y": 629.34 }, "group": "nodes" },
        { "data": { "id": "TRB_04", "label": "TRB 04 ë°œë‹¨ ì‚¬ê±´", "color": "#4facfe", "image": "", "notes": "ì£¼ì¸ê³µì„ ìˆ˜ë™ì ì¸ ìƒíƒœì—ì„œ ëŠ¥ë™ì ì¸ ìš•ë§ì˜ ì¶”êµ¬ìë¡œ ë°”ê¾¸ëŠ” ì™¸ë¶€ì  ìê·¹ì…ë‹ˆë‹¤." }, "position": { "x": 804.63, "y": 1231.58 }, "group": "nodes" },
        { "data": { "id": "TRB_05", "label": "TRB 05 ìš•ë§ êµ¬ì²´í™”", "color": "#4facfe", "image": "", "notes": "ì—¬ì •ì„ í†µí•´ ì–»ê³ ì í•˜ëŠ” êµ¬ì²´ì ì¸ ìƒ(è³)ì´ ëšœë ·í•´ì§€ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤." }, "position": { "x": 1266.48, "y": 1236.47 }, "group": "nodes" },
        { "data": { "id": "TRB_06", "label": "TRB 06 ì¡°ë ¥ì ë“±ì¥", "color": "#4facfe", "image": "", "notes": "ì£¼ì¸ê³µì˜ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ì±„ì›Œì£¼ê±°ë‚˜, ì •ì‹ ì ì¸ ì„±ì¥ì„ ìê·¹í•˜ëŠ” ì¡°ì–¸ìì˜ ì¶œí˜„ì…ë‹ˆë‹¤." }, "position": { "x": 1256.67, "y": 1688.02 }, "group": "nodes" },
        { "data": { "id": "TRB_07", "label": "TRB 07 ì ëŒ€ì/ë¯¸ìŠ¤í„°ë¦¬", "color": "#4facfe", "image": "", "notes": "ë‹¨ìˆœí•œ ë¹ŒëŸ°ì„ ë„˜ì–´ ì£¼ì¸ê³µê³¼ ì •ë°˜ëŒ€ì˜ ê°€ì¹˜ë¥¼ ìƒì§•í•˜ë©° ê²½ìŸí•˜ëŠ” ì ì˜ ì‹¤ì²´ì…ë‹ˆë‹¤." }, "position": { "x": 784.97, "y": 1672.85 }, "group": "nodes" },
        { "data": { "id": "TRB_08", "label": "TRB 08 ê°€ì§œ ì•„êµ°", "color": "#4facfe", "image": "", "notes": "ë„ì™€ì£¼ëŠ” ë“¯ ë³´ì´ì§€ë§Œ ì‚¬ì‹¤ì€ ìì‹ ì˜ ì´ìµì„ ì«“ê±°ë‚˜ ì£¼ì¸ê³µì„ íŒŒë©¸ë¡œ ì´ë„ëŠ” ì¸ë¬¼ì…ë‹ˆë‹¤." }, "position": { "x": 1595.85, "y": -38.07 }, "group": "nodes" },
        { "data": { "id": "TRB_09", "label": "TRB 09 ì²« ê¹¨ë‹¬ìŒê³¼ ê²°ì •", "color": "#4facfe", "image": "", "notes": "ì§„í–‰ ì¤‘ì¸ ì—¬ì •ì˜ ë³¸ì§ˆì„ íŒŒì•…í•˜ê³ , ìì‹ ì˜ ë°©ì‹ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì˜ì§€ë¥¼ ë‹¤ì§€ëŠ” ì§€ì ì…ë‹ˆë‹¤." }, "position": { "x": 1115.31, "y": 2405.28 }, "group": "nodes" },
        { "data": { "id": "TRB_10", "label": "TRB 10 ê³„íš ìˆ˜ë¦½", "color": "#4facfe", "image": "", "notes": "ì ì„ ì´ê¸°ê¸° ìœ„í•œ ì‹¤ì§ˆì ì¸ í–‰ë™ ì „ëµì„ ì§œëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤." }, "position": { "x": 989.71, "y": 2527.6 }, "group": "nodes" },
        { "data": { "id": "TRB_11", "label": "TRB 11 ì ì˜ ê³„íš/ë°˜ê²©", "color": "#4facfe", "image": "", "notes": "ì ì´ ì£¼ì¸ê³µì˜ ì „ëµì„ ê°„íŒŒí•˜ê³  ë” ê°•ë ¥í•œ ì••ë°•ì„ ê°€í•´ì˜¤ëŠ” ìˆœê°„ì…ë‹ˆë‹¤." }, "position": { "x": 653.96, "y": 2595.52 }, "group": "nodes" },
        { "data": { "id": "TRB_12", "label": "TRB 12 ì¶”ì§„", "color": "#4facfe", "image": "", "notes": "ê°ˆë“±ì´ ê²©ë ¬í•´ì§ì— ë”°ë¼ ì£¼ì¸ê³µì´ ë„ë•ì  ì„ ì„ ë„˜ì–´ì„œê¹Œì§€ ëª©í‘œë¥¼ ì«“ëŠ” êµ¬ê°„ì…ë‹ˆë‹¤." }, "position": { "x": 896.83, "y": 2499.17 }, "group": "nodes" },
        { "data": { "id": "TRB_13", "label": "TRB 13 ì•„êµ° ë¹„íŒ/ì¶©ëŒ", "color": "#4facfe", "image": "", "notes": "ë³€í•´ê°€ëŠ” ì£¼ì¸ê³µì˜ ë°©ì‹ì— ì‹¤ë§í•œ ë™ë£Œë“¤ì´ ë“±ì„ ëŒë¦¬ê±°ë‚˜ ì¶©ëŒí•˜ëŠ” ë‚´ì  ìœ„ê¸°ì…ë‹ˆë‹¤." }, "position": { "x": 1423.21, "y": 42.71 }, "group": "nodes" },
        { "data": { "id": "TRB_14", "label": "TRB 14 ê²‰ë³´ê¸° íŒ¨ë°°", "color": "#4facfe", "image": "", "notes": "ì£¼ì¸ê³µì˜ ê³„íšì´ ì™„ì „íˆ ì‹¤íŒ¨í•œ ê²ƒì²˜ëŸ¼ ë³´ì´ë©° ì‚¬íšŒì /ë¬¼ë¦¬ì  ê¸°ë°˜ì´ ë¬´ë„ˆì§€ëŠ” ì§€ì ì…ë‹ˆë‹¤." }, "position": { "x": 432.36, "y": 1810.71 }, "group": "nodes" },
        { "data": { "id": "TRB_15", "label": "TRB 15 ë‘ ë²ˆì§¸ ê¹¨ë‹¬ìŒ", "color": "#4facfe", "image": "", "notes": "íŒ¨ë°°ë¥¼ í†µí•´ ìì‹ ì˜ ì˜ëª»ëœ ë°©ì‹ì„ ì§ë©´í•˜ê³ , ì§„ì •í•œ ì„±ì¥ì„ ìœ„í•œ ì‹¤ë§ˆë¦¬ë¥¼ ì°¾ìŠµë‹ˆë‹¤." }, "position": { "x": 218.92, "y": 2013.29 }, "group": "nodes" },
        { "data": { "id": "TRB_16", "label": "TRB 16 ì£½ìŒì˜ ë¬¸í„±", "color": "#4facfe", "image": "", "notes": "ëª©ìˆ¨ì´ ìœ„í—˜í•˜ê±°ë‚˜ ìì•„ê°€ ì™„ì „íˆ ë¶•ê´´ë˜ëŠ” ê·¹í•œì˜ ìƒí™©ì— ì§ë©´í•©ë‹ˆë‹¤." }, "position": { "x": 1435.74, "y": -192.58 }, "group": "nodes" },
        { "data": { "id": "TRB_17", "label": "TRB 17 ì„¸ ë²ˆì§¸ ê¹¨ë‹¬ìŒ", "color": "#4facfe", "image": "", "notes": "ìì‹ ê³¼ ì , ì„¸ìƒì— ëŒ€í•œ ê¶ê·¹ì ì¸ ì§„ì‹¤ì„ ê¹¨ë‹«ê³  ë„ë•ì ìœ¼ë¡œ ì™„ì„±ë˜ëŠ” ì§€ì ì…ë‹ˆë‹¤." }, "position": { "x": 1435.43, "y": 130.61 }, "group": "nodes" },
        { "data": { "id": "TRB_18", "label": "TRB 18 ê´€ë¬¸ê³¼ ì‹œë ¨", "color": "#4facfe", "image": "", "notes": "ê²°ì „ì— ë„ë‹¬í•˜ê¸° ìœ„í•´ ëŒíŒŒí•´ì•¼ í•˜ëŠ” ìµœì¢…ì ì¸ ì¥ë²½ë“¤ì„ ì˜ë¯¸í•©ë‹ˆë‹¤." }, "position": { "x": 578.56, "y": 2435.24 }, "group": "nodes" },
        { "data": { "id": "TRB_19", "label": "TRB 19 ê²°ì „", "color": "#4facfe", "image": "", "notes": "ì ëŒ€ìì™€ì˜ ë§ˆì§€ë§‰ ìŠ¹ë¶€. ì£¼ì¸ê³µì€ ê¹¨ë‹¬ì€ ê°€ì¹˜ë¥¼ ì¦ëª…í•˜ë©° ì‹¸ì›ë‹ˆë‹¤." }, "position": { "x": 62.46, "y": 2833.34 }, "group": "nodes" },
        { "data": { "id": "TRB_20", "label": "TRB 20 ìµœì¢… ìê¸°ì¸ì‹", "color": "#4facfe", "image": "", "notes": "í­í’ì´ ì§€ë‚˜ê°„ í›„, ì£¼ì¸ê³µì´ ìì‹ ì´ ëˆ„êµ¬ì¸ì§€ ì–´ë–¤ ì¡´ì¬ê°€ ë˜ì—ˆëŠ”ì§€ í™•ì‹ í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤." }, "position": { "x": 480.97, "y": 2583.87 }, "group": "nodes" },
        { "data": { "id": "TRB_21", "label": "TRB 21 ë„ë•ì  ì„ íƒ", "color": "#4facfe", "image": "", "notes": "ê°œì¸ì˜ ìš•ë§ì´ ì•„ë‹Œ ëŒ€ì˜ë‚˜ ì˜¬ë°”ë¥¸ ê°€ì¹˜ë¥¼ ì„ íƒí•˜ë©° ì¸ë¬¼ì˜ í’ˆê²©ì„ ì™„ì„±í•©ë‹ˆë‹¤." }, "position": { "x": 346.96, "y": 3029.99 }, "group": "nodes" },
        { "data": { "id": "TRB_22", "label": "TRB 22 ìƒˆë¡œìš´ ê· í˜•", "color": "#4facfe", "image": "", "notes": "ì‚¬ê±´ì´ í•´ê²°ë˜ê³  ì£¼ì¸ê³µì´ ì–»ì€ ê¹¨ë‹¬ìŒì´ ì‚¶ì— ë…¹ì•„ë“  ìƒˆë¡œìš´ ì¼ìƒì˜ ì‹œì‘ì…ë‹ˆë‹¤." }, "position": { "x": -139.86, "y": 2439.62 }, "group": "nodes" },

        { "data": { "id": "PRP_01", "label": "PRP 01 ë¶€ì¬", "color": "#667eea", "image": "", "notes": "ê°€ì¡±ì˜ ì¼ì›ì´ ì§‘ì„ ë– ë‚˜ê±°ë‚˜, ê¸°ì¡´ì˜ ì§ˆì„œë¥¼ ìœ ì§€í•˜ë˜ ì¡´ì¬ê°€ ì‚¬ë¼ì§€ëŠ” ê²°í•ì˜ ì‹œì‘ì…ë‹ˆë‹¤." }, "position": { "x": 580.12, "y": 946.78 }, "group": "nodes" },
        { "data": { "id": "PRP_08", "label": "PRP 08 ì•…í–‰/ê²°í•", "color": "#667eea", "image": "", "notes": "ì•…ë‹¹ì— ì˜í•´ í”¼í•´ê°€ ë°œìƒí•˜ê±°ë‚˜ ë¬´ì–¸ê°€ ê²°ì •ì ìœ¼ë¡œ ë¶€ì¡±í•´ì ¸ ì—¬ì •ì´ ë¶ˆê°€í”¼í•´ì§‘ë‹ˆë‹¤." }, "position": { "x": 647.46, "y": 807.56 }, "group": "nodes" },
        { "data": { "id": "PRP_09", "label": "PRP 09 ë§¤ê°œ", "color": "#667eea", "image": "", "notes": "ì‚¬ê±´ì˜ ì „ë§ì´ ì•Œë ¤ì§€ê³  ì£¼ì¸ê³µì—ê²Œ ë„ì›€ì˜ ìš”ì²­ì´ ì˜¤ê±°ë‚˜ ì„ë¬´ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤." }, "position": { "x": 1345.11, "y": 1065.11 }, "group": "nodes" },
        { "data": { "id": "PRP_10", "label": "PRP 10 ëŒ€ì‘ ì‹œì‘", "color": "#667eea", "image": "", "notes": "ì£¼ì¸ê³µì´ ì„ë¬´ë¥¼ ë°›ì•„ë“¤ì´ê³  ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ í–‰ë™ì„ ê°œì‹œí•˜ëŠ” ë™ì˜ì˜ ìˆœê°„ì…ë‹ˆë‹¤." }, "position": { "x": 1183.53, "y": 907.84 }, "group": "nodes" },
        { "data": { "id": "PRP_11", "label": "PRP 11 ì¶œë°œ", "color": "#667eea", "image": "", "notes": "ì•ˆì „í•œ ê³ í–¥ì„ ë– ë‚˜ ë¯¸ì§€ì˜ ì˜ì—­ í˜¹ì€ ì ì˜ ë³¸ê±°ì§€ë¥¼ í–¥í•´ ì´ë™í•©ë‹ˆë‹¤." }, "position": { "x": 768.39, "y": 1438.34 }, "group": "nodes" },
        { "data": { "id": "PRP_12", "label": "PRP 12 ì¦ì—¬ì ì‹œí—˜", "color": "#667eea", "image": "", "notes": "ë§ˆë²•ì  ìˆ˜ë‹¨ì´ë‚˜ ë„êµ¬ë¥¼ ì–»ê¸° ì „, ì£¼ì¸ê³µì˜ ìê²©ì„ ë¬»ëŠ” ì²« ë²ˆì§¸ ê´€ë¬¸ì…ë‹ˆë‹¤." }, "position": { "x": 1364.83, "y": 1385.66 }, "group": "nodes" },
        { "data": { "id": "PRP_14", "label": "PRP 14 ì¡°ë ¥ íšë“", "color": "#667eea", "image": "", "notes": "ì‹œí—˜ì„ í†µê³¼í•œ ëŒ€ê°€ë¡œ ì‹ ë¹„ë¡œìš´ í˜ì´ë‚˜ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë„êµ¬ë¥¼ ì†ì— ë„£ìŠµë‹ˆë‹¤." }, "position": { "x": 1288.29, "y": 2171.63 }, "group": "nodes" },
        { "data": { "id": "PRP_15", "label": "PRP 15 ì•ˆë‚´", "color": "#667eea", "image": "", "notes": "ëª©ì ì§€ê¹Œì§€ ì•ˆë‚´ë¥¼ ë°›ê±°ë‚˜ ì‹ ë¹„ë¡œìš´ ì¡°ë ¥ìë¥¼ ë”°ë¼ ì ì—ê²Œ ì ‘ê·¼í•©ë‹ˆë‹¤." }, "position": { "x": 1164.62, "y": 1961.59 }, "group": "nodes" },
        { "data": { "id": "PRP_16", "label": "PRP 16 íˆ¬ìŸ", "color": "#667eea", "image": "", "notes": "ì ê³¼ ì§ì ‘ ë§ë¶™ëŠ” ê²©ë ¬í•œ ë¬¼ë¦¬ì  í˜¹ì€ ë…¼ë¦¬ì  ì „íˆ¬ êµ¬ê°„ì…ë‹ˆë‹¤." }, "position": { "x": 934.55, "y": 1985.21 }, "group": "nodes" },
        { "data": { "id": "PRP_18", "label": "PRP 18 ìŠ¹ë¦¬", "color": "#667eea", "image": "", "notes": "ì „íˆ¬ì—ì„œ ì ì„ ë¬¼ë¦¬ì¹˜ê±°ë‚˜ ë¬´ë ¥í™”ì‹œí‚¤ëŠ” ì¼ì°¨ì  ì„±ê³µì…ë‹ˆë‹¤." }, "position": { "x": 1854.52, "y": 136.6 }, "group": "nodes" },
        { "data": { "id": "PRP_19", "label": "PRP 19 ê²°í• í•´ì†Œ", "color": "#667eea", "image": "", "notes": "ì´ˆë°˜ì— ë°œìƒí–ˆë˜ ì•…í–‰ì˜ í”ì ì´ ì§€ì›Œì§€ê±°ë‚˜ ìƒì—ˆë˜ ê²ƒì„ ë˜ì°¾ëŠ” ìˆ˜ìŠµ ë‹¨ê³„ì…ë‹ˆë‹¤." }, "position": { "x": 1613.89, "y": 244.32 }, "group": "nodes" },
        { "data": { "id": "PRP_20", "label": "PRP 20 ê·€í™˜", "color": "#667eea", "image": "", "notes": "ì„ë¬´ë¥¼ ë§ˆì¹œ ì£¼ì¸ê³µì´ ì˜ê´‘ìŠ¤ëŸ½ê²Œ í˜¹ì€ ë¹„ë°€ìŠ¤ëŸ½ê²Œ ìì‹ ì˜ ì¥ì†Œë¡œ ëŒì•„ì˜µë‹ˆë‹¤." }, "position": { "x": 1648.33, "y": 99.85 }, "group": "nodes" },
        { "data": { "id": "PRP_21", "label": "PRP 21 ì¶”ê²©", "color": "#667eea", "image": "", "notes": "íŒ¨ë°°í•œ ì ì˜ ì”ë‹¹ì´ ì¶”ê²©í•´ì˜¤ê±°ë‚˜ ì˜ˆê¸°ì¹˜ ëª»í•œ ë§ˆì§€ë§‰ ë°©í•´ê°€ ë’¤ë”°ë¦…ë‹ˆë‹¤." }, "position": { "x": 691.79, "y": 2060.3 }, "group": "nodes" },
        { "data": { "id": "PRP_25", "label": "PRP 25 ì–´ë ¤ìš´ ê³¼ì œ", "color": "#667eea", "image": "", "notes": "ìµœì¢…ì ì¸ ì •ë‹¹ì„±ì„ í™•ë³´í•˜ê¸° ìœ„í•´ ì£¼ì¸ê³µì—ê²Œ ì£¼ì–´ì§€ëŠ” ë¶ˆê°€ëŠ¥ì— ê°€ê¹Œìš´ ë¯¸ì…˜ì…ë‹ˆë‹¤." }, "position": { "x": 129.77, "y": 2445.19 }, "group": "nodes" },
        { "data": { "id": "PRP_26", "label": "PRP 26 ê³¼ì œ í•´ê²°", "color": "#667eea", "image": "", "notes": "ì£¼ì¸ê³µì˜ ìš©ê¸°ë‚˜ ì§€í˜œ, í˜¹ì€ ë¯¸ë¦¬ ì–»ì€ ì¡°ë ¥ ë•ë¶„ì— ê³¼ì œë¥¼ ì™„ìˆ˜í•©ë‹ˆë‹¤." }, "position": { "x": 175.63, "y": 2854.16 }, "group": "nodes" },
        { "data": { "id": "PRP_27", "label": "PRP 27 ì¸ì‹", "color": "#667eea", "image": "", "notes": "ì£¼ì¸ê³µì´ ì§„ì§œ ì˜ì›…ì„ì„ ì„¸ìƒì´ ì•Œì•„ë³´ê³  ì‹ ë¶„ì´ë‚˜ ìê²©ì„ ê³µì¸ë°›ëŠ” ì§€ì ì…ë‹ˆë‹¤." }, "position": { "x": 459.34, "y": 2730.76 }, "group": "nodes" },
        { "data": { "id": "PRP_30", "label": "PRP 30 ì²˜ë²Œ", "color": "#667eea", "image": "", "notes": "ëª¨ë“  ì •ì²´ê°€ ë“œëŸ¬ë‚œ ì•…ë‹¹ì´ë‚˜ ê°€ì§œ ì˜ì›…ì´ ì‘ë‹¹í•œ ë²Œì„ ë°›ëŠ” ì‚¬ë²•ì /ë„ë•ì  ë‹¨ì£„ì…ë‹ˆë‹¤." }, "position": { "x": 133.75, "y": 2578.46 }, "group": "nodes" },
        { "data": { "id": "PRP_31", "label": "PRP 31 ë³´ìƒ/ì—”ë”©", "color": "#667eea", "image": "", "notes": "ê²°í˜¼, ì™•ìœ„ ìŠ¹ê³„, í˜¹ì€ í‰í™”ì˜ ì•ˆì°© ë“± ì˜ì›…ì  ì—¬ì •ì— ëŒ€í•œ ìµœì¢…ì  ë³´ìƒì…ë‹ˆë‹¤." }, "position": { "x": -140.09, "y": 2835.95 }, "group": "nodes" },

        { "data": { "id": "STC_01_02", "source": "STC_01", "target": "STC_02", "label": "ì„¸ê³„ê´€ ì†ì—ì„œ ì ì¬ì  í…Œë§ˆ ì•”ì‹œ" }, "group": "edges" },
        { "data": { "id": "STC_02_03", "source": "STC_02", "target": "STC_03", "label": "ì¼ìƒì˜ ë¬¸ì œì ê³¼ ì¸ë¬¼ ê´€ê³„ êµ¬ì¶•" }, "group": "edges" },
        { "data": { "id": "STC_03_04", "source": "STC_03", "target": "STC_04", "label": "í˜„ìƒ ìœ ì§€ë¥¼ ê¹¨ëœ¨ë¦¬ëŠ” ì™¸ë¶€ì  ì¶©ê²©" }, "group": "edges" },
        { "data": { "id": "STC_04_05", "source": "STC_04", "target": "STC_05", "label": "ë³€í™”ì— ëŒ€í•œ ë‘ë ¤ì›€ê³¼ ë‚´ì  ê°ˆë“±" }, "group": "edges" },
        { "data": { "id": "STC_05_06", "source": "STC_05", "target": "STC_06", "label": "ê²°ë‹¨ê³¼ í•¨ê»˜ ìƒˆë¡œìš´ ì„¸ê³„ë¡œì˜ ë„ì•½" }, "group": "edges" },
        { "data": { "id": "STC_06_07", "source": "STC_06", "target": "STC_07", "label": "ì •ì„œì  ìœ ëŒ€ì™€ ì„œë¸Œí”Œë¡¯ì˜ ì‹œì‘" }, "group": "edges" },
        { "data": { "id": "STC_07_08", "source": "STC_07", "target": "STC_08", "label": "ë³¸ê²©ì ì¸ ëª¨í—˜ê³¼ ê°œë…ì  ì¬ë¯¸ íƒìƒ‰" }, "group": "edges" },
        { "data": { "id": "STC_08_09", "source": "STC_08", "target": "STC_09", "label": "ì‚¬ê±´ì˜ ì „í™˜ì ê³¼ ìœ„í—˜ì˜ ê³ ì¡°" }, "group": "edges" },
        { "data": { "id": "STC_09_10", "source": "STC_09", "target": "STC_10", "label": "ì ëŒ€ ì„¸ë ¥ì˜ ë³¸ê²©ì ì¸ ë°˜ê²©ê³¼ ìœ„ê¸°" }, "group": "edges" },
        { "data": { "id": "STC_10_11", "source": "STC_10", "target": "STC_11", "label": "í†µì œ ë¶ˆëŠ¥ ìƒíƒœì™€ ì™„ì „í•œ ìƒì‹¤" }, "group": "edges" },
        { "data": { "id": "STC_11_12", "source": "STC_11", "target": "STC_12", "label": "ê¹Šì€ ì ˆë§ ì†ì—ì„œì˜ ìì•„ ì„±ì°°" }, "group": "edges" },
        { "data": { "id": "STC_12_13", "source": "STC_12", "target": "STC_13", "label": "ìƒˆë¡œìš´ í†µì°°ì„ í†µí•œ ì¬ê¸° ê²°ì‹¬" }, "group": "edges" },
        { "data": { "id": "STC_13_14", "source": "STC_13", "target": "STC_14", "label": "ëª¨ë“  ìì›ì„ ë™ì›í•œ ìµœì¢… ìŠ¹ë¶€" }, "group": "edges" },
        { "data": { "id": "STC_14_15", "source": "STC_14", "target": "STC_15", "label": "ë³€í™”ëœ ì„¸ê³„ì˜ í™•ì¦ê³¼ ë§ˆë¬´ë¦¬" }, "group": "edges" },
        { "data": { "id": "TRB_01_02", "source": "TRB_01", "target": "TRB_02", "label": "ë‚´ì  ìš•ë§ì„ ê°€ë¡œë§‰ëŠ” ê³¼ê±°ì˜ ìƒì²˜" }, "group": "edges" },
        { "data": { "id": "TRB_02_03", "source": "TRB_02", "target": "TRB_03", "label": "íŠ¸ë¼ìš°ë§ˆì—ì„œ ê¸°ì¸í•œ ì¸ê²©ì  ê²°í•¨" }, "group": "edges" },
        { "data": { "id": "TRB_03_04", "source": "TRB_03", "target": "TRB_04", "label": "ê²°í•¨ì´ ë…¸ì¶œë˜ëŠ” ìˆœê°„ì˜ ì™¸ë¶€ì  ìê·¹" }, "group": "edges" },
        { "data": { "id": "TRB_04_05", "source": "TRB_04", "target": "TRB_05", "label": "ë§‰ì—°í•œ ê²°í•ì—ì„œ êµ¬ì²´ì  ëª©í‘œë¡œì˜ ì „ì´" }, "group": "edges" },
        { "data": { "id": "TRB_05_06", "source": "TRB_05", "target": "TRB_06", "label": "ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì¡°ë ¥ìì™€ì˜ ë§Œë‚¨" }, "group": "edges" },
        { "data": { "id": "TRB_06_07", "source": "TRB_06", "target": "TRB_07", "label": "ì¡°ë ¥ê³¼ ë™ì‹œì— ì„ ëª…í•´ì§€ëŠ” ì ëŒ€ ê´€ê³„" }, "group": "edges" },
        { "data": { "id": "TRB_07_08", "source": "TRB_07", "target": "TRB_08", "label": "ì ê³¼ì˜ ëŒ€ë¦½ ì¤‘ ë°œìƒí•˜ëŠ” ì•„êµ°ì˜ ê¸°ë§Œ" }, "group": "edges" },
        { "data": { "id": "TRB_08_09", "source": "TRB_08", "target": "TRB_09", "label": "ë°°ì‹  í˜¹ì€ ì¶©ê²©ì„ í†µí•œ ìƒí™©ì˜ ì¬ì¸ì‹" }, "group": "edges" },
        { "data": { "id": "TRB_09_10", "source": "TRB_09", "target": "TRB_10", "label": "ìƒˆë¡œìš´ ê°ì˜¤ë¡œ ì •ë¦½í•œ ì‹¤ì „ ì „ëµ" }, "group": "edges" },
        { "data": { "id": "TRB_10_11", "source": "TRB_10", "target": "TRB_11", "label": "ì „ëµì— ë§ëŒ€ì‘í•˜ëŠ” ì ì˜ ì¹˜ëª…ì  ìˆ˜" }, "group": "edges" },
        { "data": { "id": "TRB_11_12", "source": "TRB_11", "target": "TRB_12", "label": "ì••ë°•ì— ëª» ì´ê²¨ ë¬´ë¦¬í•˜ê²Œ ì¶”ì§„ë˜ëŠ” ê³„íš" }, "group": "edges" },
        { "data": { "id": "TRB_12_13", "source": "TRB_12", "target": "TRB_13", "label": "ì£¼ì¸ê³µì˜ ì§‘ì°©ìœ¼ë¡œ ì¸í•œ ë™ë£Œì™€ì˜ ê· ì—´" }, "group": "edges" },
        { "data": { "id": "TRB_13_14", "source": "TRB_13", "target": "TRB_14", "label": "ë‚´ì™¸ë¶€ì  ë¬´ë„ˆì§ê³¼ ì‚¬íšŒì  ì¶”ë½" }, "group": "edges" },
        { "data": { "id": "TRB_14_15", "source": "TRB_14", "target": "TRB_15", "label": "ë°”ë‹¥ì—ì„œ ë°œê²¬í•œ ì§„ì •í•œ ìì•„ ì„±ì°°" }, "group": "edges" },
        { "data": { "id": "TRB_15_16", "source": "TRB_15", "target": "TRB_16", "label": "ì™„ì „í•œ ë³€í™”ë¥¼ ìœ„í•œ ê·¹í•œì˜ ìƒì¡´ ì‹œí—˜" }, "group": "edges" },
        { "data": { "id": "TRB_16_17", "source": "TRB_16", "target": "TRB_17", "label": "ìì•„ì˜ ì£½ìŒê³¼ ë„ë•ì  ì¬íƒ„ìƒ" }, "group": "edges" },
        { "data": { "id": "TRB_17_18", "source": "TRB_17", "target": "TRB_18", "label": "ë³€í™”ëœ ì‹ ë…ìœ¼ë¡œ ë§ˆì£¼í•˜ëŠ” ë§ˆì§€ë§‰ ê´€ë¬¸" }, "group": "edges" },
        { "data": { "id": "TRB_18_19", "source": "TRB_18", "target": "TRB_19", "label": "ì„±ì¥í•œ ë‚´ë©´ì˜ í˜ì„ ì¦ëª…í•˜ëŠ” ê²°ì „" }, "group": "edges" },
        { "data": { "id": "TRB_19_20", "source": "TRB_19", "target": "TRB_20", "label": "íˆ¬ìŸì„ í†µí•œ ì§„ì •í•œ ìì‹ ì˜ ì •ì²´ì„± í™•ë¦½" }, "group": "edges" },
        { "data": { "id": "TRB_20_21", "source": "TRB_20", "target": "TRB_21", "label": "ì„±ìˆ™í•œ ì¸ê²©ìœ¼ë¡œì„œì˜ ê°€ì¹˜ ì¤‘ì‹¬ì  ì„ íƒ" }, "group": "edges" },
        { "data": { "id": "TRB_21_22", "source": "TRB_21", "target": "TRB_22", "label": "ì•ˆì •ëœ ë‚´ë©´ê³¼ ì¡°í™”ë¡œìš´ ì‚¶ì˜ êµ¬ì¶•" }, "group": "edges" },
        { "data": { "id": "PRP_01_08", "source": "PRP_01", "target": "PRP_08", "label": "ë³´í˜¸ì˜ ë¶€ì¬ê°€ ê°€ì ¸ì˜¨ ì‹¤ì§ˆì  í”¼í•´" }, "group": "edges" },
        { "data": { "id": "PRP_08_09", "source": "PRP_08", "target": "PRP_09", "label": "í”¼í•´ë¥¼ ìˆ˜ìŠµí•˜ê¸° ìœ„í•œ ì™¸ë¶€ì˜ ê°œì…" }, "group": "edges" },
        { "data": { "id": "PRP_09_10", "source": "PRP_09", "target": "PRP_10", "label": "ì†Œëª…ì„ ë°›ì•„ë“¤ì´ëŠ” êµ¬ì›ìì˜ ê²°ë‹¨" }, "group": "edges" },
        { "data": { "id": "PRP_10_11", "source": "PRP_10", "target": "PRP_11", "label": "ê²°ì˜ë¥¼ ë‹¤ì§€ê³  ë‚¯ì„  ì„¸ê³„ë¡œ ì´ë™" }, "group": "edges" },
        { "data": { "id": "PRP_11_12", "source": "PRP_11", "target": "PRP_12", "label": "ëª¨í—˜ ì¤‘ ë§Œë‚œ ì´ˆì›”ì  ì¡´ì¬ì˜ ì‹œí—˜" }, "group": "edges" },
        { "data": { "id": "PRP_12_14", "source": "PRP_12", "target": "PRP_14", "label": "ì‹œí—˜ í†µê³¼ í›„ ì–»ê²Œ ëœ ê°•ë ¥í•œ ë§ˆë²• ë„êµ¬" }, "group": "edges" },
        { "data": { "id": "PRP_14_15", "source": "PRP_14", "target": "PRP_15", "label": "ë„êµ¬ì˜ í˜ìœ¼ë¡œ ì ì§„ê¹Œì§€ì˜ ì•ˆì „í•œ ì•ˆë‚´" }, "group": "edges" },
        { "data": { "id": "PRP_15_16", "source": "PRP_15", "target": "PRP_16", "label": "ì ê³¼ì˜ ì •ë©´ ì¶©ëŒê³¼ ë¬¼ë¦¬ì  ëŒ€ê²°" }, "group": "edges" },
        { "data": { "id": "PRP_16_18", "source": "PRP_16", "target": "PRP_18", "label": "ëŒ€ê²°ì˜ ë§ˆì¹¨í‘œì¸ ê²°ì •ì  ìŠ¹ë¦¬" }, "group": "edges" },
        { "data": { "id": "PRP_18_19", "source": "PRP_18", "target": "PRP_19", "label": "ì›í‰ ì œê±° í›„ íšŒë³µëœ ë³¸ë˜ì˜ ê°€ì¹˜" }, "group": "edges" },
        { "data": { "id": "PRP_19_20", "source": "PRP_19", "target": "PRP_20", "label": "ëª©ì  ë‹¬ì„± í›„ ì•ˆì „í•œ ê¸°ì§€ë¡œì˜ ë³µê·€" }, "group": "edges" },
        { "data": { "id": "PRP_20_21", "source": "PRP_20", "target": "PRP_21", "label": "ë³µê·€ ê¸¸ì— ë§ë‹¥ëœ¨ë¦° ì”ì¡´ ì„¸ë ¥ì˜ ìœ„í˜‘" }, "group": "edges" },
        { "data": { "id": "PRP_21_25", "source": "PRP_21", "target": "PRP_25", "label": "ìœ„í˜‘ì„ ëš«ê³  ë§ˆì£¼í•œ ìµœì¢… ìê²© ê²€ì¦" }, "group": "edges" },
        { "data": { "id": "PRP_25_26", "source": "PRP_25", "target": "PRP_26", "label": "ì§€í˜œì™€ ìš´ìœ¼ë¡œ í•´ê²°í•œ ë¶ˆê°€ëŠ¥í•œ ë‚œì œ" }, "group": "edges" },
        { "data": { "id": "PRP_26_27", "source": "PRP_26", "target": "PRP_27", "label": "ë‚œì œ í•´ê²°ì„ í†µí•œ ì˜ì›… ì‹ ë¶„ í™•ì¦" }, "group": "edges" },
        { "data": { "id": "PRP_27_30", "source": "PRP_27", "target": "PRP_30", "label": "ê³µì¸ëœ ê¶Œìœ„ë¡œ ì§‘í–‰í•˜ëŠ” ì•…ì¸ì˜ ì‹¬íŒ" }, "group": "edges" },
        { "data": { "id": "PRP_30_31", "source": "PRP_30", "target": "PRP_31", "label": "ê³µì˜ ì‹¤í˜„ í›„ ì£¼ì–´ì§€ëŠ” ì˜ê´‘ëœ ê²°ë§" }, "group": "edges" },

        { "data": { "id": "E_STC01_PRP01", "source": "STC_01", "target": "PRP_01", "label": "ì´ˆê¸° ì •ì ì¸ ì„¸ê³„ ì†ì˜ ê·¼ì›ì  ë¶€ì¬ ê²°í•©" }, "group": "edges" },
        { "data": { "id": "E_STC03_PRP08", "source": "STC_03", "target": "PRP_08", "label": "ì¼ìƒì˜ ì„¸íŠ¸ì—… ë‹¨ê³„ì—ì„œ ê²°í•ì˜ êµ¬ì²´í™”" }, "group": "edges" },
        { "data": { "id": "E_STC03_TRB03", "source": "STC_03", "target": "TRB_03", "label": "ì™¸ë¶€ í™˜ê²½ì˜ ê²°í•¨ê³¼ ë‚´ë©´ì˜ ì•½ì ì´ ì¡°ì‘" }, "group": "edges" },
        { "data": { "id": "E_STC04_TRB04", "source": "STC_04", "target": "TRB_04", "label": "ì™¸ë¶€ì  ì¶©ê²©ì´ ì£¼ì¸ê³µì˜ ë‚´ë©´ ìš•ë§ì„ ë°œí™”" }, "group": "edges" },
        { "data": { "id": "E_STC04_PRP09", "source": "STC_04", "target": "PRP_09", "label": "ì¶©ê²©ì  ì‚¬ê±´ì´ êµ¬ì›ìë¡œì„œì˜ ì†Œëª…ìœ¼ë¡œ ì—°ê²°" }, "group": "edges" },
        { "data": { "id": "E_STC05_PRP10", "source": "STC_05", "target": "PRP_10", "label": "ë‚´ì  ì €í•­ì„ ê·¹ë³µí•œ ì˜ì§€ì  ëŒ€ì‘ì˜ ì‹œì‘" }, "group": "edges" },
        { "data": { "id": "E_STC06_PRP11", "source": "STC_06", "target": "PRP_11", "label": "2ë§‰ ì§„ì…ì˜ ì„ íƒì´ ë¬¼ë¦¬ì ì¸ ì¶œë°œë¡œ í˜„í˜„" }, "group": "edges" },
        { "data": { "id": "E_STC07_TRB06", "source": "STC_07", "target": "TRB_06", "label": "ì¸ê°„ ê´€ê³„ì˜ ì‹œì‘ê³¼ í•¨ê»˜ ì°¾ì•„ì˜¨ ì •ì‹ ì  ì§€ì£¼" }, "group": "edges" },
        { "data": { "id": "E_STC07_PRP15", "source": "STC_07", "target": "PRP_15", "label": "ì •ì„œì  êµë¥˜ê°€ ì—¬ì •ì˜ ì˜¬ë°”ë¥¸ ë°©í–¥ì„ ì œì‹œ" }, "group": "edges" },
        { "data": { "id": "E_STC08_PRP16", "source": "STC_08", "target": "PRP_16", "label": "ì‹ ë‚˜ëŠ” íƒìƒ‰ ê³¼ì • ì¤‘ ë§ˆì£¼ì¹˜ëŠ” ì´ˆê¸° ì¥ì• ë¬¼" }, "group": "edges" },
        { "data": { "id": "E_STC09_TRB09", "source": "STC_09", "target": "TRB_09", "label": "ì‚¬ê±´ì˜ ì •ì ì—ì„œ ì–»ì€ ì¹˜ëª…ì ì¸ ì§„ì‹¤ ì¸ì‹" }, "group": "edges" },
        { "data": { "id": "E_STC10_TRB11", "source": "STC_10", "target": "TRB_11", "label": "ì•…ì˜ ê³µì„¸ë¡œ ì¸í•œ ê³„íšì˜ íŒŒíƒ„ê³¼ ë‚´ì  í˜¼ë€" }, "group": "edges" },
        { "data": { "id": "E_STC11_TRB14", "source": "STC_11", "target": "TRB_14", "label": "ê°€ì¥ í° ìƒì‹¤ì´ ê°€ì ¸ì˜¨ ìì•„ì˜ ì²˜ì°¸í•œ ë¶•ê´´" }, "group": "edges" },
        { "data": { "id": "E_STC13_TRB18", "source": "STC_13", "target": "TRB_18", "label": "ì¬ê¸° ê²°ì‹¬ì´ ìµœì¢… ê´€ë¬¸ì„ ëš«ëŠ” íˆ¬ì§€ë¡œ ìŠ¹í™”" }, "group": "edges" },
        { "data": { "id": "E_STC13_PRP25", "source": "STC_13", "target": "PRP_25", "label": "3ë§‰ì˜ í•´ê²°ì±…ì´ ì˜ì›… ìê²©ì˜ ë§ˆì§€ë§‰ ì‹œí—˜ê³¼ ì§ê²°" }, "group": "edges" },
        { "data": { "id": "E_STC14_TRB19", "source": "STC_14", "target": "TRB_19", "label": "ì™¸ì  ëŒ€ê²°ì˜ ìŠ¹ë¦¬ê°€ ë‚´ì  ê°€ì¹˜ì˜ ìŠ¹ë¦¬ë¡œ ì™„ì„±" }, "group": "edges" },
        { "data": { "id": "E_STC14_PRP26", "source": "STC_14", "target": "PRP_26", "label": "í”¼ë‚ ë ˆì˜ ì ˆì •ì´ ëª¨ë“  ë¶ˆê°€ëŠ¥í•œ ë‚œì œì˜ í•´ê²°" }, "group": "edges" },
        { "data": { "id": "E_STC14_PRP30", "source": "STC_14", "target": "PRP_30", "label": "ì •ì˜ êµ¬í˜„ì„ í†µí•œ ì•…ì˜ ì™„ì „í•œ ë°°ì œì™€ ì²˜ë²Œ" }, "group": "edges" },
        { "data": { "id": "E_STC15_TRB22", "source": "STC_15", "target": "TRB_22", "label": "ë³€í™”ëœ ì´ë¯¸ì§€ê°€ ìƒˆë¡œìš´ ì‚¶ì˜ í‰í˜• ìƒíƒœë¥¼ í™•ì •" }, "group": "edges" },
        { "data": { "id": "E_STC15_PRP31", "source": "STC_15", "target": "PRP_31", "label": "ì •ì„œì  ë§ˆë¬´ë¦¬ê°€ ì˜ì›…ì  ì„œì‚¬ì˜ ë³´ìƒê³¼ í•©ì¹˜" }, "group": "edges" },
        { "data": { "id": "E_PRP12_TRB06", "source": "PRP_12", "target": "TRB_06", "label": "ì‹œí—˜ì„ ì£¼ëŠ” ì¦ì—¬ìê°€ ì •ì‹ ì  ì¡°ë ¥ìì˜ ì—­í•  ìˆ˜í–‰" }, "group": "edges" },
        { "data": { "id": "E_PRP14_TRB06", "source": "PRP_14", "target": "TRB_06", "label": "ë§ˆë²•ì  ì¡°ë ¥ì˜ íšë“ê³¼ ì¸ì  ì¡°ë ¥ì˜ ì¼ì²´í™”" }, "group": "edges" },
        { "data": { "id": "E_PRP18_TRB19", "source": "PRP_18", "target": "TRB_19", "label": "ë¬¼ë¦¬ì  ì •ë³µì´ í•„ì—°ì ìœ¼ë¡œ ë§ì´í•˜ëŠ” ìµœì¢… ëŒ€ê²°" }, "group": "edges" },
        { "data": { "id": "E_PRP19_TRB20", "source": "PRP_19", "target": "TRB_20", "label": "ê²°í•ì˜ í•´ì†Œê°€ ê°€ì ¸ì˜¨ ì£¼ì¸ê³µì˜ ì •ì²´ì„± ë³µêµ¬" }, "group": "edges" },
        { "data": { "id": "E_PRP27_TRB20", "source": "PRP_27", "target": "TRB_20", "label": "ì£¼ë³€ì˜ ì¸ì •ê³¼ ìŠ¤ìŠ¤ë¡œì˜ ì¸ì‹ì´ í•˜ë‚˜ê°€ ë¨" }, "group": "edges" },
        { "data": { "id": "E_TRB02_PRP01", "source": "TRB_02", "target": "PRP_01", "label": "ê³¼ê±°ì˜ ìƒì²˜ì™€ ë¶€ì¬ì˜ ìƒì‹¤ê°ì´ í˜•ì„±í•œ í™˜ê²½" }, "group": "edges" },
        { "data": { "id": "E_TRB04_PRP09", "source": "TRB_04", "target": "PRP_09", "label": "ì‚¬ê±´ì˜ ì‹œì‘ì´ ì£¼ì¸ê³µì„ ì¤‘ì¬ìì˜ ìœ„ì¹˜ë¡œ ìœ ë„" }, "group": "edges" },
        { "data": { "id": "E_TRB08_PRP12", "source": "TRB_08", "target": "PRP_12", "label": "ê°€ì§œ ì•„êµ°ì˜ ë°©í•´ê°€ ì„±ì¥ì„ ìœ„í•œ ì—­ì„¤ì  ì‹œí—˜" }, "group": "edges" },
        { "data": { "id": "E_TRB16_PRP25", "source": "TRB_16", "target": "PRP_25", "label": "ì£½ìŒì˜ ìœ„ê¸°ê°€ ê³§ ê°€ì¥ ì–´ë ¤ìš´ ê³¼ì œì˜ ë„ì „" }, "group": "edges" },
        { "data": { "id": "E_TRB17_PRP27", "source": "TRB_17", "target": "PRP_27", "label": "ì™„ë²½í•œ ê¹¨ë‹¬ìŒì´ ì˜ì›…ìœ¼ë¡œì„œì˜ ìê²© ì¸ì‹ì„ ì´‰ë°œ" }, "group": "edges" },
        { "data": { "id": "E_TRB21_PRP26", "source": "TRB_21", "target": "PRP_26", "label": "ë„ë•ì  ì„ íƒì´ ê³§ ë‚œì œ í•´ê²°ì˜ ì—´ì‡ ê°€ ë¨" }, "group": "edges" },
        { "data": { "id": "E_TRB22_PRP20", "source": "TRB_22", "target": "PRP_20", "label": "ë‚´ì  í‰í™”ì™€ ì™¸ì  ê·€í™˜ì˜ ë™ì‹œì  ë‹¬ì„±" }, "group": "edges" }
      ];

      let cy = cytoscape({
        container: document.getElementById('cy'),
        elements: JSON.parse(JSON.stringify(initialData)),
        style: [
          { selector: 'node', style: { 'label': 'data(label)', 'background-color': 'data(color)', 'shape': 'round-rectangle', 'width': 'label', 'height': 30, 'padding': '10px', 'border-width': 2, 'border-color': '#333', 'border-style': 'solid', 'text-valign': 'center', 'text-halign': 'center', 'color': '#fff', 'font-weight': 'bold', 'font-size': 14, 'text-outline-width': 2, 'text-outline-color': '#000' } },
          { selector: 'edge', style: { 'label': 'data(label)', 'curve-style': 'bezier', 'line-color': '#999', 'width': 1, 'target-arrow-shape': 'triangle', 'target-arrow-color': '#999', 'font-size': 12 } },
          { selector: 'edge.timeline', style: { 'line-color': '#ff0055', 'width': 3, 'target-arrow-color': '#ff0055' } },
          { selector: 'node:selected', style: { 'border-width': 4, 'border-color': '#FFD700', 'border-style': 'double' } },
          { selector: 'edge:selected', style: { 'width': 4, 'line-color': '#FFD700', 'target-arrow-color': '#FFD700' } }
        ],
        layout: { name: 'cose', animate: true },
        boxSelectionEnabled: false
      });

      let selected = null, speechSynthesis = window.speechSynthesis, currentUtterance = null;
      let edgeCreationMode = false, edgeSourceNode = null, isDragMode = false, tremorInterval = null, currentLayout = null;

      const notesInfo = document.getElementById('notesInfo');
      const labelInput = document.getElementById('labelInput');
      const colorControl = document.getElementById('colorControl');
      const colorInput = document.getElementById('colorInput');
      const imageInput = document.getElementById('imageInput'); // Added
      const notesTextarea = document.getElementById('notesTextarea');
      const edgeSrcInput = document.getElementById('edgeSrc');
      const edgeTgtInput = document.getElementById('edgeTgt');

      window.addEventListener('load', function () {
        const hash = window.location.hash.substring(1);
        let loadedFromHash = false;

        if (hash) {
          try {
            const decoded = JSON.parse(LZString.decompressFromEncodedURIComponent(hash));
            if (decoded) {
              cy.elements().remove();
              cy.add(decoded);
              loadedFromHash = true;
            }
          } catch (e) {
            console.error("Failed to load from URL hash:", e);
            alert("URL ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. ê¸°ë³¸ ì˜ˆì œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.");
          }
        }

        runLayout('cose');
        resetRightPanel();

        // Overlay ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
        layer = document.getElementById('overlays');
        cy.on('render pan zoom position', updateNodeOverlays);
        // setInterval ì œê±°ë¨ (ì´ë²¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ ì™„ë£Œ)
      });

      // ------------------- â–¼ í•µì‹¬: ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ â–¼ -------------------

      // 1. ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜
      function deleteSelected() {
        if (!selected) { alert('ì‚­ì œí•  ìš”ì†Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        const element = cy.getElementById(selected.id);
        if (element.length === 0) return;

        const confirmMsg = selected.type === 'node'
          ? `'${element.data('label')}' ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ê²°ëœ ëª¨ë“  ì„ ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)`
          : `'${element.data('label') || 'ê´€ê³„'}' ì„ ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

        if (confirm(confirmMsg)) {
          cy.remove(element);
          resetRightPanel(); // íŒ¨ë„ ì´ˆê¸°í™”
          // ì—°ê²° ì…ë ¥ì°½ì— ì‚­ì œëœ ë…¸ë“œê°€ ìˆë‹¤ë©´ ì´ˆê¸°í™”
          if (edgeSrcInput.value === selected.id || edgeTgtInput.value === selected.id) {
            clearEdgeInputs();
          }
          selected = null;
        }
      }

      // 2. í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (Delete, Backspace) ë¦¬ìŠ¤ë„ˆ
      document.addEventListener('keydown', function (event) {
        // ì…ë ¥ì°½(input, textarea)ì—ì„œ íƒ€ì´í•‘ ì¤‘ì¼ ë•ŒëŠ” ì‚­ì œ í‚¤ ë™ì‘ ì•ˆ í•¨ (ê¸€ì ì§€ì›Œì•¼ í•˜ë‹ˆê¹Œ)
        const tag = document.activeElement.tagName.toUpperCase();
        if (tag === 'INPUT' || tag === 'TEXTAREA') return;

        if (event.key === 'Delete' || event.key === 'Backspace') {
          if (selected) {
            deleteSelected();
          }
        }
      });

      // ------------------- â–² í•µì‹¬: ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ â–² -------------------


      function toggleDragMode() {
        isDragMode = !isDragMode;
        const btn = document.getElementById('btnDragMode');
        if (isDragMode) {
          btn.classList.add('drag-mode-active');
          btn.innerText = "ğŸ–±ï¸ ë“œë˜ê·¸ ëª¨ë“œ ON (ë…¸ë“œë¥¼ ì¡ê³  ë„ì„¸ìš”)";
          cy.userZoomingEnabled(false); cy.userPanningEnabled(false);
        } else {
          btn.classList.remove('drag-mode-active');
          btn.innerText = "ğŸ–±ï¸ ë“œë˜ê·¸ ì—°ê²° ëª¨ë“œ (ì¼œê¸°/ë„ê¸°)";
          cy.userZoomingEnabled(true); cy.userPanningEnabled(true);
        }
      }

      function resetRightPanel() {
        selected = null;
        notesInfo.innerText = "ë…¸ë“œ/ì—£ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”";
        labelInput.value = ''; notesTextarea.value = ''; imageInput.value = ''; // Reset
        labelInput.disabled = true; notesTextarea.disabled = true;
        colorControl.style.display = 'none';
      }

      cy.on('tap', 'node', function (evt) {
        const node = evt.target; const nodeId = node.id();
        if (!isDragMode) {
          if (edgeSrcInput.value === '') { edgeSrcInput.value = nodeId; node.animate({ style: { 'border-color': '#4facfe', 'border-width': 4 } }, { duration: 200 }); }
          else if (edgeTgtInput.value === '' && edgeSrcInput.value !== nodeId) { edgeTgtInput.value = nodeId; node.animate({ style: { 'border-color': '#ff0055', 'border-width': 4 } }, { duration: 200 }); }
        }
        selected = { type: 'node', id: nodeId };
        notesInfo.innerText = "ë…¸ë“œ: " + nodeId;
        labelInput.value = node.data('label') || ''; notesTextarea.value = node.data('notes') || '';
        labelInput.disabled = false; notesTextarea.disabled = false;
        colorControl.style.display = 'block'; colorInput.value = node.data('color') || '#667eea';
        imageInput.value = node.data('image') || ''; // Load image URL
      });

      cy.on('tap', 'edge', function (evt) {
        const edge = evt.target;
        selected = { type: 'edge', id: edge.id() };
        notesInfo.innerText = "ê´€ê³„: " + edge.data('source') + " â†’ " + edge.data('target');
        labelInput.value = edge.data('label') || ''; notesTextarea.value = edge.data('notes') || '';
        labelInput.disabled = false; notesTextarea.disabled = false;
        colorControl.style.display = 'none';
      });

      cy.on('tap', function (evt) { if (evt.target === cy) { resetRightPanel(); } });

      cy.on('dbltap', function (evt) {
        if (evt.target === cy) {
          const pos = evt.position, nodeName = prompt("ìƒˆ ë…¸ë“œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "ìƒˆ ë…¸ë“œ");
          if (nodeName && nodeName.trim()) {
            const id = nodeName.trim();
            if (cy.getElementById(id).length > 0) { alert("ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤!"); return; }
            const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
            cy.add({ data: { id: id, label: id, color: colors[Math.floor(Math.random() * colors.length)], notes: "" }, position: { x: pos.x, y: pos.y } });
            stopObsidianTremor(); startObsidianTremor();
          }
        }
      });

      cy.on('mousedown', 'node', function (evt) {
        if (evt.originalEvent.ctrlKey || evt.originalEvent.metaKey || isDragMode) {
          edgeCreationMode = true; edgeSourceNode = evt.target;
          evt.target.style({ 'border-width': '4px', 'border-color': '#43e97b', 'border-style': 'dashed' });
        }
      });
      cy.on('mouseover', 'node', function (evt) { if (edgeCreationMode && edgeSourceNode && evt.target.id() !== edgeSourceNode.id()) evt.target.style({ 'border-width': '4px', 'border-color': '#4facfe' }); });
      cy.on('mouseout', 'node', function (evt) { if (edgeCreationMode && edgeSourceNode && evt.target.id() !== edgeSourceNode.id()) evt.target.style('border-width', '2px'); });
      cy.on('mouseup', 'node', function (evt) {
        if (edgeCreationMode && edgeSourceNode && evt.target.id() !== edgeSourceNode.id()) {
          const label = prompt("ê´€ê³„ ë¼ë²¨ ì…ë ¥:", "");
          if (label !== null) {
            let classes = (label && (label.toUpperCase() === "TIMELINE" || label.toUpperCase() === "íƒ€ì„ë¼ì¸")) ? "timeline" : "";
            cy.add({ data: { id: edgeSourceNode.id() + "_" + evt.target.id() + "_" + Date.now(), source: edgeSourceNode.id(), target: evt.target.id(), label: label || "", notes: "" }, classes: classes });
            stopObsidianTremor(); startObsidianTremor();
          }
          edgeSourceNode.style('border-width', '2px'); edgeCreationMode = false; edgeSourceNode = null;
        }
      });
      cy.on('mouseup', function (evt) { if (edgeCreationMode && evt.target === cy) { if (edgeSourceNode) edgeSourceNode.style('border-width', '2px'); edgeCreationMode = false; edgeSourceNode = null; } });

      function clearEdgeInputs() { edgeSrcInput.value = ''; edgeTgtInput.value = ''; document.getElementById('edgeLbl').value = ''; }
      function swapEdgeInputs() { const temp = edgeSrcInput.value; edgeSrcInput.value = edgeTgtInput.value; edgeTgtInput.value = temp; }
      function addEdge() {
        const src = edgeSrcInput.value.trim(), tgt = edgeTgtInput.value.trim(), lbl = document.getElementById('edgeLbl').value.trim();
        if (!src || !tgt) { alert('ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”!'); return; }
        if (cy.getElementById(src).length === 0 || cy.getElementById(tgt).length === 0) { alert('ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤!'); return; }
        let classes = (lbl && (lbl.toUpperCase() === "TIMELINE" || lbl.toUpperCase() === "íƒ€ì„ë¼ì¸")) ? "timeline" : "";
        cy.add({ data: { id: src + "_" + tgt + "_" + Date.now(), source: src, target: tgt, label: lbl || "", notes: "" }, classes: classes });
        runLayout('cose'); document.getElementById('edgeLbl').value = '';
      }

      function addNode() {
        const id = document.getElementById('newNode').value.trim();
        if (!id) { alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!'); return; }
        if (cy.getElementById(id).length > 0) { alert('ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤!'); return; }
        const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
        cy.add({ data: { id: id, label: id, color: colors[Math.floor(Math.random() * colors.length)], notes: "" } });
        runLayout('cose'); document.getElementById('newNode').value = '';
      }

      let isTremorOn = true; // Default to ON

      function toggleTremor() {
        isTremorOn = !isTremorOn;
        const btn = document.getElementById('btnTremorMode');
        if (isTremorOn) {
          btn.innerText = "ğŸŒŠ ìˆ¨ì‰¬ê¸° ëª¨ë“œ ON";
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-info');
          startObsidianTremor();
        } else {
          btn.innerText = "ğŸŒŠ ìˆ¨ì‰¬ê¸° ëª¨ë“œ OFF";
          btn.classList.remove('btn-info');
          btn.classList.add('btn-secondary'); // You might need to add a gray style or use inline style if btn-secondary is not defined
          btn.style.backgroundColor = '#6c757d'; // Fallback gray
          stopObsidianTremor();
        }
      }

      function startObsidianTremor() {
        if (!isTremorOn) return; // Respect the toggle
        if (tremorInterval) return;
        tremorInterval = setInterval(() => {
          cy.nodes().forEach(node => {
            if (node.selected()) return;
            const degree = node.degree(); const tremorStrength = 2.0 / (1 + degree); // Slightly reduced strength for stability
            node.position({ x: node.position('x') + (Math.random() - 0.5) * tremorStrength, y: node.position('y') + (Math.random() - 0.5) * tremorStrength });
          });
        }, 50);
      }
      function stopObsidianTremor() { if (tremorInterval) { clearInterval(tremorInterval); tremorInterval = null; } }
      function runLayout(layoutName) {
        stopObsidianTremor(); if (currentLayout) { currentLayout.stop(); currentLayout = null; }
        let opts = layoutName === 'cose' ? { name: 'cose', animate: true, animationDuration: 500, fit: true, padding: 10, nodeRepulsion: 20000, idealEdgeLength: 150, gravity: 0.05 } : { name: 'dagre', rankDir: 'TB', padding: 10, animate: true };
        if (layoutName === 'dagre') cy.nodes().unlock();
        const layout = cy.layout(opts);
        layout.on('layoutstop', updateNodeOverlays);
        layout.run();
        // Only restart if it's ON
        if (isTremorOn) {
          setTimeout(startObsidianTremor, 500);
        }
      }

      function saveNotes() {
        if (!selected) { alert('ì„ íƒëœ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const element = cy.getElementById(selected.id);
        if (element.length === 0) { alert('ì´ë¯¸ ì‚­ì œëœ ìš”ì†Œì…ë‹ˆë‹¤.'); resetRightPanel(); return; }

        const newLabel = labelInput.value.trim();
        if (!newLabel) { alert('ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
        element.data('label', newLabel); element.data('notes', notesTextarea.value);
        if (selected.type === 'node') {
          element.data('color', colorInput.value);
          element.data('image', imageInput.value.trim()); // Save image URL
        }
        if (selected.type === 'edge') {
          if (newLabel.toUpperCase() === "TIMELINE" || newLabel.toUpperCase() === "íƒ€ì„ë¼ì¸") element.addClass('timeline'); else element.removeClass('timeline');
        }
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        updateNodeOverlays(); // ì €ì¥ í›„ ì˜¤ë²„ë ˆì´ ê°±ì‹ 
      }

      // --- Floating Content Overlays Logic (Universal) ---
      let openImageNodes = new Set(); // í¼ì³ì§„ ë…¸ë“œ ID ëª©ë¡
      let layer = null;

      function detectContentType(val) {
        if (typeof val !== 'string') val = String(val);
        val = val.trim();

        // URL íŒŒë¼ë¯¸í„°/í•´ì‹œ ì œê±° í›„ í™•ì¥ì í™•ì¸ì„ ìœ„í•œ í´ë¦° ë²„ì „
        const cleanVal = val.split('?')[0].split('#')[0];
        const lowerClean = cleanVal.toLowerCase();
        const lowerFull = val.toLowerCase();

        // 1. YouTube (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
        if (lowerFull.includes('youtube.com') || lowerFull.includes('youtu.be')) {
          return 'youtube';
        }

        // 2. Image (í™•ì¥ì ì²´í¬ - íŒŒë¼ë¯¸í„° ë¬´ì‹œ)
        // ë¡œì»¬ íŒŒì¼ ê²½ë¡œ(drive letter)ë‚˜ file í”„ë¡œí† ì½œ ì§€ì›
        if (lowerClean.match(/\.(jpeg|jpg|gif|png|webp|svg|bmp|ico)$/) || lowerFull.startsWith('data:image')) {
          return 'image';
        }

        // 3. Video
        if (lowerClean.match(/\.(mp4|webm|ogg|mov|avi)$/)) {
          return 'video';
        }

        // 4. URL
        if (lowerFull.startsWith('http') || lowerFull.startsWith('file://')) {
          return 'url';
        }

        // 5. Text
        return 'text';
      }

      function getYouTubeEmbedUrl(url) {
        try {
          let videoId = null;
          let urlObj = null;

          // 1. URL ê°ì²´ ìƒì„± ì‹œë„ (í”„ë¡œí† ì½œì´ ì—†ìœ¼ë©´ https:// ë¶™ì—¬ì„œ ì‹œë„)
          try {
            urlObj = new URL(url);
          } catch (e) {
            if (!url.startsWith('http')) {
              try { urlObj = new URL('https://' + url); } catch (e2) { }
            }
          }

          if (urlObj) {
            // A. query param 'v' (youtube.com/watch?v=...)
            if (urlObj.searchParams.has('v')) {
              videoId = urlObj.searchParams.get('v');
            }
            // B. pathname (youtu.be/ID or youtube.com/embed/ID etc)
            else {
              const path = urlObj.pathname; // /embed/ID or /ID
              const segments = path.split('/').filter(s => s.length > 0);
              // youtu.be/ID -> segment[0]
              // youtube.com/embed/ID -> segment[1] usually
              // youtube.com/shorts/ID
              if (urlObj.hostname.includes('youtu.be')) {
                videoId = segments[0];
              } else if (urlObj.hostname.includes('youtube.com')) {
                // /embed/ID, /shorts/ID, /v/ID, /live/ID
                if (segments.length >= 2 && ['embed', 'shorts', 'live', 'v'].includes(segments[0])) {
                  videoId = segments[1];
                }
              }
            }
          }

          // 2. Regex Fallback (URL ê°ì²´ íŒŒì‹± ì‹¤íŒ¨í•˜ê±°ë‚˜ ID ëª» ì°¾ì€ ê²½ìš°)
          if (!videoId) {
            // ?v=ID ê°€ ë’¤ì— ìˆ¨ì–´ìˆëŠ” ê²½ìš° ë“± ëŒ€ë¹„
            const vParamMatch = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
            if (vParamMatch) videoId = vParamMatch[1];
            else {
              // youtu.be ë“± ê¸°ì¡´ regex
              const regex = /(?:youtu\.be\/|youtube\.com\/(?:embed\/|shorts\/|live\/))([a-zA-Z0-9_-]{11})/;
              const match = url.match(regex);
              if (match) videoId = match[1];
            }
          }

          if (videoId && videoId.length === 11) {
            return `https://www.youtube.com/embed/${videoId}`;
          }
          return null;
        } catch (e) {
          return null; // Fail safe
        }
      }

      function generateContentHTML(type, val, label) {
        switch (type) {
          case 'image':
            return `<div style="text-align:center;">
                    <img src="${val}" alt="Image" style="max-width:100%; max-height:100%; object-fit:contain;" 
                         onerror="this.style.display='none'; this.parentElement.querySelector('.err-msg').style.display='block';">
                    <div class="err-msg" style="display:none; color:red; font-size:0.8em; margin-top:5px;">
                      âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨<br><span style="color:#777; font-size:0.9em;">(ë³´ì•ˆ ë¬¸ì œë¡œ ë¡œì»¬ íŒŒì¼ì´ ì°¨ë‹¨ë˜ì—ˆê±°ë‚˜ ì£¼ì†Œê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤)</span><br>
                      <a href="${val}" target="_blank" style="text-decoration:underline; color:#0066cc;">[ìƒˆì°½ì—ì„œ ì—´ê¸°]</a>
                    </div>
                  </div>`;

          case 'video':
            return `<video class="node-content-video" controls style="width:100%;"><source src="${val}">ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</video>`;

          case 'youtube':
            const embed = getYouTubeEmbedUrl(val);
            if (embed) {
              return `<div style="display:flex; flex-direction:column; height:100%;">
                      <iframe class="node-content-iframe" src="${embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="flex:1; border:none;"></iframe>
                      <div style="text-align:right; font-size:0.8em; padding:2px;">
                        <a href="${val}" target="_blank" style="color:#cc0000; text-decoration:none;">ğŸ“º YouTubeì—ì„œ ë³´ê¸°</a>
                      </div>
                    </div>`;
            } else {
              return `<div class="node-content-text">
                        âŒ ìœ íŠœë¸Œ IDë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                        <a href="${val}" target="_blank">${val}</a>
                    </div>`;
            }

          case 'url':
            return `
                    <div style="display:flex; flex-direction:column; height:100%;">
                        <div class="node-content-link-card">
                            <a href="${val}" target="_blank">ğŸŒ ìƒˆì°½ìœ¼ë¡œ ì‚¬ì´íŠ¸ ì—´ê¸°</a>
                            <div style="font-size:0.75em; color:#666; margin-top:2px;">(ì—°ê²° ê±°ë¶€ ì‹œ ìœ„ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”)</div>
                        </div>
                        <iframe class="node-content-iframe" src="${val}" style="flex:1; width:100%; border:1px solid #eee;" title="Preview" onerror="alert('ì´ ì‚¬ì´íŠ¸ëŠ” Iframe ì—°ê²°ì„ ê±°ë¶€í•©ë‹ˆë‹¤.');"></iframe>
                    </div>
                `;

          case 'text':
          default:
            return `<div class="node-content-text" style="height:100%; overflow-y:auto;">${val.replace(/\n/g, '<br>')}</div>`;
        }
      }

      function updateNodeOverlays() {
        if (!layer) return;

        const nodes = cy.nodes();
        const activeNodeIds = new Set();

        nodes.forEach(node => {
          const rawContent = node.data('image'); // í•„ë“œëª…ì€ í˜¸í™˜ì„±ì„ ìœ„í•´ 'image' ìœ ì§€
          if (!rawContent || rawContent.trim() === '') return;

          const nodeId = node.id();
          activeNodeIds.add(nodeId);

          const pos = node.renderedPosition();
          const width = node.renderedWidth();
          const height = node.renderedHeight();

          // --- 1. Toggle Button Management ---
          const btnId = 'img-btn-' + nodeId;
          let btn = document.getElementById(btnId);

          // ì»¨í…ì¸  íƒ€ì… ê°ì§€
          const contentType = detectContentType(rawContent);
          let icon = 'ğŸ“'; // ê¸°ë³¸ ì•„ì´ì½˜
          if (contentType === 'image') icon = 'ğŸ“·';
          else if (contentType === 'video' || contentType === 'youtube') icon = 'â–¶ï¸';
          else if (contentType === 'url') icon = 'ğŸŒ';
          else if (contentType === 'text') icon = 'ğŸ“';


          if (!btn) {
            btn = document.createElement('div');
            btn.id = btnId;
            btn.className = 'node-image-toggle';
            btn.onclick = (e) => {
              e.stopPropagation();
              toggleNodeImage(nodeId);
            };
            layer.appendChild(btn);
          }

          const isOpen = openImageNodes.has(nodeId);
          btn.innerHTML = isOpen ? 'âŒ' : icon;
          btn.style.left = (pos.x + width / 2 - 10) + 'px';
          btn.style.top = (pos.y - height / 2 - 10) + 'px';
          btn.style.display = 'block';


          // --- 2. Popup Management ---
          const popupId = 'img-popup-' + nodeId;
          let popup = document.getElementById(popupId);

          if (isOpen) {
            if (!popup) {
              popup = document.createElement('div');
              popup.id = popupId;
              popup.className = 'node-image-popup';

              // ì»¨í…ì¸  ìƒì„±
              const innerHTML = generateContentHTML(contentType, rawContent, node.data('label'));

              popup.innerHTML = `
              <div id="content-${popupId}" style="width:100%; height:100%; display:flex; flex-direction:column;">
                 <div style="flex:1; overflow:hidden;">${innerHTML}</div>
                 <div class="close-btn" style="margin-top:5px; padding:5px; background:#eee; text-align:center; cursor:pointer;" onclick="toggleNodeImage('${nodeId}')">ì ‘ê¸° (ë”ë¸”í´ë¦­: í¬ê¸°ì´ˆê¸°í™”)</div>
              </div>
            `;

              // í¬ê¸° ì´ˆê¸°í™”/ë¦¬ì…‹ ê¸°ëŠ¥
              popup.querySelector('.close-btn').addEventListener('dblclick', (e) => {
                e.stopPropagation();
                delete popup.dataset.userResized; // ë¦¬ì…‹
              });

              // ì‚¬ìš©ì ë¦¬ì‚¬ì´ì¦ˆ ê°ì§€ (MouseUp ì‹œì )
              popup.addEventListener('mouseup', function () {
                const currentW = popup.offsetWidth;
                const currentH = popup.offsetHeight;
                const autoW = parseFloat(popup.dataset.lastAutoW || 0);
                const autoH = parseFloat(popup.dataset.lastAutoH || 0);

                // ì˜¤ì°¨ê°€ 5px ì´ìƒì´ë©´ ì‚¬ìš©ìê°€ ì¡°ì ˆí•œ ê²ƒìœ¼ë¡œ ê°„ì£¼
                if (Math.abs(currentW - autoW) > 5 || Math.abs(currentH - autoH) > 5) {
                  popup.dataset.userResized = "true";
                }
              });

              layer.appendChild(popup);
            }

            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            const isUserResized = popup.dataset.userResized === "true";

            if (!isUserResized) {
              // ìë™ í¬ê¸° ëª¨ë“œ: ë…¸ë“œ í¬ê¸°ì— ë§ì¶¤ (ìµœì†Œ 200px)
              const autoW = Math.max(width, 200);
              // ë†’ì´ëŠ” ì»¨í…ì¸ ì— ë”°ë¼ ìë™ì´ì§€ë§Œ, ì´ˆê¸°ê°’ ì„¤ì •

              popup.style.width = autoW + 'px';
              // ë†’ì´ëŠ” autoë¡œ ë‘ê±°ë‚˜ ë¹„ìœ¨ì— ë§ì¶¤. ì—¬ê¸°ì„  widthë§Œ ê°•ì œí•˜ê³  heightëŠ” auto (CSS resizeë¡œ ì¡°ì ˆ ê°€ëŠ¥)

              popup.dataset.lastAutoW = autoW;
              popup.dataset.lastAutoH = popup.offsetHeight; // í˜„ì¬ ë Œë”ë§ëœ ë†’ì´ ì €ì¥
            }

            popup.style.display = 'block';
            // ìœ„ì¹˜: ë…¸ë“œ ì¤‘ì•™ í•˜ë‹¨
            popup.style.left = (pos.x - popup.offsetWidth / 2) + 'px';
            popup.style.top = (pos.y + height / 2 + 5) + 'px';

          } else {
            if (popup) popup.remove();
          }
        });

        // --- 3. Cleanup ---
        const children = Array.from(layer.children);
        children.forEach(child => {
          if (child.id.startsWith('img-btn-')) {
            const nid = child.id.replace('img-btn-', '');
            if (!activeNodeIds.has(nid)) {
              child.remove();
              const p = document.getElementById('img-popup-' + nid);
              if (p) p.remove();
            }
          }
        });
      }

      function toggleNodeImage(nodeId) {
        if (openImageNodes.has(nodeId)) {
          openImageNodes.delete(nodeId);
        } else {
          openImageNodes.add(nodeId);
        }
        updateNodeOverlays();
      }

      function saveToLocalStorage() { localStorage.setItem("graphData", JSON.stringify(cy.json().elements)); alert('ì €ì¥ ì™„ë£Œ!'); }
      function loadFromLocalStorage() {
        const data = localStorage.getItem("graphData");
        if (data) {
          cy.elements().remove();
          cy.add(JSON.parse(data));
          openImageNodes.clear(); // ë¶ˆëŸ¬ì˜¬ ë•Œ ì—´ë¦¼ ìƒíƒœ ì´ˆê¸°í™”
          runLayout('cose');
          alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
        } else alert('ë°ì´í„° ì—†ìŒ');
      }
      function saveToURL() { window.location.hash = LZString.compressToEncodedURIComponent(JSON.stringify(cy.json().elements)); alert('URL ì €ì¥ ì™„ë£Œ!'); }
      function downloadJSON() {
        const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cy.json().elements, null, 2));
        a.download = "graph_" + new Date().toISOString().slice(0, 10) + ".json"; document.body.appendChild(a); a.click(); a.remove();
      }
      function extractElementsFromJSON(data) {
        let elements = [];
        if (data.graphData) {
          const gd = data.graphData;
          if (gd.nodes || gd.edges) elements = [...(gd.nodes || []), ...(gd.edges || [])];
          else if (gd.elements) elements = gd.elements;
        }
        if (elements.length === 0) {
          if (Array.isArray(data)) elements = data;
          else if (data.nodes || data.edges) elements = [...(data.nodes || []), ...(data.edges || [])];
          else if (data.elements) elements = Array.isArray(data.elements) ? data.elements : [...(data.elements.nodes || []), ...(data.elements.edges || [])];
        }
        return elements;
      }
      function uploadJSON(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = function (e) { try { const els = extractElementsFromJSON(JSON.parse(e.target.result)); if (els.length) { cy.elements().remove(); cy.add(els); runLayout('cose'); alert('ì„±ê³µ!'); } else alert('ë°ì´í„° ì—†ìŒ'); } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); } }; reader.readAsText(file);
      }
      function appendJSON(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = function (e) {
          try {
            const els = extractElementsFromJSON(JSON.parse(e.target.result)); if (!els.length) { alert('ë°ì´í„° ì—†ìŒ'); return; }
            const suffix = "_COPY_" + Date.now(), idMap = {}, newEls = [], offset = 500;
            els.forEach(el => { if (el.data && el.data.id && !el.data.source) { const old = el.data.id, nid = old + suffix; if (cy.getElementById(nid).length) return; const n = JSON.parse(JSON.stringify(el)); n.data.id = nid; n.position = n.position ? { x: n.position.x + offset, y: n.position.y + offset } : { x: cy.width() / 2 + offset, y: cy.height() / 2 + offset }; idMap[old] = nid; newEls.push(n); } });
            els.forEach(el => { if (el.data && el.data.source) { if (idMap[el.data.source] && idMap[el.data.target]) { const n = JSON.parse(JSON.stringify(el)); n.data.id = (n.data.id || "EDGE") + suffix; n.data.source = idMap[el.data.source]; n.data.target = idMap[el.data.target]; newEls.push(n); } } });
            if (newEls.length) { cy.add(newEls); runLayout('cose'); alert('ì¶”ê°€ ì™„ë£Œ!'); }
          } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); }
        }; reader.readAsText(file);
      }

      function loadVoices() {
        if (document.getElementById('ttsProvider').value === 'supertonic') {
          loadSupertonicVoices();
          return;
        }

        const vs = speechSynthesis.getVoices(), sel = document.getElementById('voiceSelect'); sel.innerHTML = '';
        const ko = vs.filter(v => v.lang.startsWith('ko'));
        if (ko.length) ko.forEach(v => sel.add(new Option(v.name, v.name))); else sel.add(new Option("ê¸°ë³¸ í•œêµ­ì–´", "default"));
      }

      function loadSupertonicVoices() {
        const sel = document.getElementById('voiceSelect'); sel.innerHTML = '';
        const voices = [
          { value: 'F1', name: 'ìŠˆí¼í† ë‹‰ Sarah (ë§‘ìŒ/ì—¬ì„±)' },
          { value: 'F2', name: 'ìŠˆí¼í† ë‹‰ Lily (ì°¨ë¶„í•¨/ì—¬ì„±)' },
          { value: 'F3', name: 'ìŠˆí¼í† ë‹‰ Sam (ëª…ë‘/ì—¬ì„±)' },
          { value: 'F4', name: 'ìŠˆí¼í† ë‹‰ Olivia (ë¶€ë“œëŸ¬ì›€/ì—¬ì„±)' },
          { value: 'F5', name: 'ìŠˆí¼í† ë‹‰ Emily (í™œë°œ/ì—¬ì„±)' },
          { value: 'M1', name: 'ìŠˆí¼í† ë‹‰ Alex (ì‹ ë¢°ê°/ë‚¨ì„±)' },
          { value: 'M2', name: 'ìŠˆí¼í† ë‹‰ James (ì €ìŒ/ë‚¨ì„±)' },
          { value: 'M3', name: 'ìŠˆí¼í† ë‹‰ Daniel (í™œê¸°/ë‚¨ì„±)' },
          { value: 'M4', name: 'ìŠˆí¼í† ë‹‰ Henry (í„°í”„í•¨/ë‚¨ì„±)' },
          { value: 'M5', name: 'ìŠˆí¼í† ë‹‰ Oscar (ì¹œì ˆí•œ/ë‚¨ì„±)' }
        ];
        voices.forEach(v => sel.add(new Option(v.name, v.value)));
      }

      function updateVoiceList() {
        loadVoices();
      }

      if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();

      function updateSpeedValue() { document.getElementById('speedValue').textContent = document.getElementById('speedControl').value + 'x'; }

      // --- Supertonic 2 Integration Logic ---
      let ttsPipeline = null;
      let audioContext = null;
      let currentSource = null;
      let lastGeneratedAudioBlob = null;

      async function initSupertonic(forceReset = false) {
        if (ttsPipeline && !forceReset) return ttsPipeline;
        const status = document.getElementById('ttsLoadingStatus');
        const readBtn = document.getElementById('btnTtsRead');

        status.style.display = 'block';
        status.innerText = "â³ ìŠˆí¼í† ë‹‰ 2 ëª¨ë¸ ë¡œë”© ì¤‘... (ë°ì´í„° ì•½ 60MB)";
        readBtn.disabled = true;

        try {
          if (!window.transformers) {
            throw new Error("Transformers.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          }
          const { pipeline, env } = window.transformers;

          env.allowLocalModels = false;
          env.remoteHost = 'https://huggingface.co';
          env.remotePathTemplate = '{model}/resolve/{revision}/';

          if (forceReset) env.useBrowserCache = false;

          // ì •ì‹ Supertonic 2 ONNX ëª¨ë¸ ë¡œë“œ
          console.log("Loading Supertonic 2 ONNX (CPU/WASM mode)...");
          ttsPipeline = await pipeline('text-to-speech', 'onnx-community/Supertonic-TTS-2-ONNX', {
            device: 'wasm'
          });

          status.style.display = 'none';
          readBtn.disabled = false;
          return ttsPipeline;
        } catch (err) {
          console.error("DEBUG - AI TTS Load Error:", err);

          let displayError = err && err.message ? err.message : "ìƒì„¸ ì •ë³´ ì—†ìŒ (Check Console)";
          if (typeof err === 'string') displayError = err;

          let errorMsg = "âŒ <b>AI ëª¨ë¸ ë¡œë”© ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (í¬ê¸°í•˜ì§€ ì•Šê³  í•´ê²° ì¤‘ì…ë‹ˆë‹¤!)</b><br><br>ì›ì¸: " + displayError;

          if (displayError.includes("FixedLength")) {
            errorMsg = "âŒ ìŠˆí¼í† ë‹‰ ìµœì‹  ê·œê²© í˜¸í™˜ì„± ì´ìŠˆì…ë‹ˆë‹¤. ëŒ€ì‹  ì¡°ê¸ˆ ë” ì•ˆì •ì ì¸ MMS ì—”ì§„ìœ¼ë¡œ ì „í™˜ ì¤‘ì…ë‹ˆë‹¤...";
            // ì—¬ê¸°ì„œ ê°•ì œë¡œ ë‹¤ë¥¸ ëª¨ë¸ë¡œ ì¬ì‹œë„ ë¡œì§ì„ ë„£ê±°ë‚˜ ì•ˆë‚´
          } else if (displayError.includes("Unauthorized")) {
            errorMsg = "âŒ íŠ¹ì • ëª¨ë¸ì— ë³´ì•ˆ ê¶Œí•œ(Gated)ì´ í•„ìš”í•©ë‹ˆë‹¤. ê³µê°œìš© ëª¨ë¸ë¡œ ìë™ ì „í™˜ì„ ì‹œë„í•´ ë³´ì„¸ìš”.";
          } else if (displayError.includes("fetch")) {
            if (window.location.protocol === 'file:') {
              errorMsg += "<br><br><b>ğŸ’¡ ì¤‘ìš”:</b> ë¡œì»¬ íŒŒì¼(file://) ëª¨ë“œì…ë‹ˆë‹¤. <code>run_server.bat</code> íŒŒì¼ì„ ì‹¤í–‰í•œ ë’¤ ì ‘ì†í•´ ë³´ì„¸ìš”!";
            } else {
              errorMsg += "<br><br><b>ğŸ’¡ ë„ì›€ë§:</b> ëª¨ë¸ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²° í˜¹ì€ ì‚¬ì´íŠ¸ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.";
            }
          }

          status.innerHTML = `${errorMsg}<br><br>
            <button class="btn-primary" onclick="initSupertonic(true)">âš™ï¸ ì„¤ì • ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ë¡œë”©</button>
            <button class="btn-secondary" onclick="clearTransformersCache()">ğŸ—‘ï¸ ëª¨ë¸ ìºì‹œ ì‚­ì œ</button>
            <button class="btn-secondary" onclick="switchToSystemTTS()">ì„ì‹œë¡œ ì‹œìŠ¤í…œ ìŒì„± ì“°ê¸°</button>`;
          readBtn.disabled = false;
          throw err;
        } finally {
          if (forceReset) {
            window.transformers.env.useBrowserCache = true; // ë³µêµ¬
          }
        }
      }

      async function clearTransformersCache() {
        if (confirm("ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ëª¨ë“  AI ëª¨ë¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ë‚´ë ¤ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì•½ 100MB ì •ë„ì˜ ì¬ë‹¤ìš´ë¡œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤)")) {
          try {
            await caches.delete('transformers-cache');
            alert("ìºì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨(Ctrl+F5) í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            location.reload(true);
          } catch (e) {
            alert("ìºì‹œ ì‚­ì œ ì‹¤íŒ¨: " + e.message);
          }
        }
      }

      function switchToSystemTTS() {
        document.getElementById('ttsProvider').value = 'system';
        updateVoiceList();
        document.getElementById('ttsLoadingStatus').style.display = 'none';
        alert("ê¸°ë³¸ ì‹œìŠ¤í…œ TTSë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ ì œê³µí•˜ëŠ” ìŒì„±ìœ¼ë¡œ ë‚­ë…í•©ë‹ˆë‹¤.");
      }

      function parseMultiVoiceText(text, defaultVoice) {
        const segments = [];
        // [Name] ë˜ëŠ” [F1], [M1] ë“±ì˜ íƒœê·¸ë¥¼ ì°¾ìŒ
        const regex = /\[(\w+)\]/g;
        let lastIdx = 0;
        let currentVoice = defaultVoice;
        let match;

        while ((match = regex.exec(text)) !== null) {
          const before = text.substring(lastIdx, match.index).trim();
          if (before) segments.push({ voice: currentVoice, text: before });
          currentVoice = match[1];
          lastIdx = regex.lastIndex;
        }
        const remaining = text.substring(lastIdx).trim();
        if (remaining) segments.push({ voice: currentVoice, text: remaining });

        return segments.length > 0 ? segments : [{ voice: defaultVoice, text: text }];
      }

      async function readNotes() {
        const text = notesTextarea.value.trim();
        if (!text) return;
        stopReading();
        document.getElementById('btnDownloadMp3').style.display = 'none';
        lastGeneratedAudioBlob = null;

        const provider = document.getElementById('ttsProvider').value;
        const defaultVoice = document.getElementById('voiceSelect').value;
        const speed = parseFloat(document.getElementById('speedControl').value);

        if (provider === 'supertonic') {
          try {
            const pipeline = await initSupertonic();
            if (!pipeline) throw new Error("TTS ì—”ì§„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");

            const btn = document.getElementById('btnTtsRead');
            const originalText = btn.innerText;
            btn.innerText = "â³ ìƒì„± ì¤‘...";
            btn.disabled = true;

            const segments = parseMultiVoiceText(text, defaultVoice);
            let combinedAudio = [];
            let sampleRate = 16000; // MMS ê¸°ë³¸ê°’ (ìƒì„± í›„ ì—…ë°ì´íŠ¸ë¨)

            for (const seg of segments) {
              const cleanText = seg.text.trim();
              if (!cleanText) continue;

              // Persona Mapping
              const mapping = {
                'Sarah': 'F1', 'Lily': 'F2', 'Sam': 'F3', 'Olivia': 'F4', 'Emily': 'F5',
                'Alex': 'M1', 'James': 'M2', 'Daniel': 'M3', 'Henry': 'M4', 'Oscar': 'M5'
              };
              let speakerId = mapping[seg.voice] || seg.voice;
              if (!/^[FM][1-5]$/.test(speakerId)) speakerId = 'F1';

              const embeddingUrl = `https://huggingface.co/onnx-community/Supertonic-TTS-2-ONNX/resolve/main/voices/${speakerId}.bin`;

              console.log(`Synthesizing (${speakerId}):`, cleanText);

              // Supertonic 2ëŠ” <ko> íƒœê·¸ì™€ speaker_embeddingsê°€ í•„ìš”í•¨
              const output = await pipeline(`<ko>${cleanText}</ko>`, {
                speaker_embeddings: embeddingUrl,
                num_inference_steps: 5,
                speed: speed
              });

              if (!output || !output.audio) {
                throw new Error("ìŒì„± ë°ì´í„° ìƒì„± ì‹¤íŒ¨");
              }

              combinedAudio.push(output.audio);
              sampleRate = output.sampling_rate;
            }

            btn.innerText = originalText;
            btn.disabled = false;

            // Concatenate buffers
            const totalLength = combinedAudio.reduce((acc, curr) => acc + curr.length, 0);
            const finalAudio = new Float32Array(totalLength);
            let offset = 0;
            for (const chunk of combinedAudio) {
              finalAudio.set(chunk, offset);
              offset += chunk.length;
            }

            playAudio(finalAudio, sampleRate);
            prepareDownload(finalAudio, sampleRate);

          } catch (err) {
            console.error("TTS Execution Error:", err);
            const displayErr = err && err.message ? err.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ (undefined)";
            alert("ìŒì„± ìƒì„± ì˜¤ë¥˜: " + displayErr + "\n\nê³„ì† ì˜¤ë¥˜ê°€ ë‚˜ë©´ 'ì‹œìŠ¤í…œ ìŒì„±'ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.");
            document.getElementById('btnTtsRead').disabled = false;
            document.getElementById('btnTtsRead').innerText = "ğŸ”Š ì½ê¸°";
          }
        } else {
          // System TTS (Multi-voice not supported here for simplicity, but could be added similarly)
          currentUtterance = new SpeechSynthesisUtterance(text.replace(/\[.*?\]/g, '').replace(/[#*_~`\[\]{}()\-+=|\\<>]/g, ' '));
          const vs = speechSynthesis.getVoices();
          const v = vs.find(v => v.name === defaultVoice);
          if (v) currentUtterance.voice = v;
          currentUtterance.rate = speed;
          speechSynthesis.speak(currentUtterance);
        }
      }

      function prepareDownload(audioData, sampleRate) {
        // Convert Float32 to Int16 PCM (LAMEjs expectation)
        const pcmData = new Int16Array(audioData.length);
        for (let i = 0; i < audioData.length; i++) {
          let s = Math.max(-1, Math.min(1, audioData[i]));
          pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }

        const mp3encoder = new lamejs.Mp3Encoder(1, sampleRate, 128);
        const mp3Data = [];
        const sampleBlockSize = 1152;

        for (let i = 0; i < pcmData.length; i += sampleBlockSize) {
          const sampleChunk = pcmData.subarray(i, i + sampleBlockSize);
          const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
          if (mp3buf.length > 0) mp3Data.push(mp3buf);
        }

        const mp3buf = mp3encoder.flush();
        if (mp3buf.length > 0) mp3Data.push(mp3buf);

        lastGeneratedAudioBlob = new Blob(mp3Data, { type: 'audio/mp3' });
        document.getElementById('btnDownloadMp3').style.display = 'block';
      }

      function downloadMp3() {
        if (!lastGeneratedAudioBlob) return;
        const url = URL.createObjectURL(lastGeneratedAudioBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `voice_${new Date().getTime()}.mp3`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }

      function playAudio(audioData, sampleRate) {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        const buffer = audioContext.createBuffer(1, audioData.length, sampleRate);
        buffer.getChannelData(0).set(audioData);

        currentSource = audioContext.createBufferSource();
        currentSource.buffer = buffer;
        currentSource.connect(audioContext.destination);
        currentSource.start();
      }

      function stopReading() {
        // System TTS Stop
        if (speechSynthesis.speaking) speechSynthesis.cancel();

        // Supertonic Stop
        if (currentSource) {
          currentSource.stop();
          currentSource = null;
        }
      }

      // ====================================================================
      // ğŸ”‘ API Key Management
      // ====================================================================
      function saveApiKeys() {
        localStorage.setItem("geminiApiKey", document.getElementById('geminiApiKey').value);
        localStorage.setItem("googleSearchKey", document.getElementById('googleSearchKey').value);
        localStorage.setItem("googleCxId", document.getElementById('googleCxId').value);
      }

      function loadApiKeys() {
        const k1 = localStorage.getItem("geminiApiKey");
        const k2 = localStorage.getItem("googleSearchKey");
        const k3 = localStorage.getItem("googleCxId");
        if (k1) document.getElementById('geminiApiKey').value = k1;
        if (k2) document.getElementById('googleSearchKey').value = k2;
        if (k3) document.getElementById('googleCxId').value = k3;
      }

      // Load keys on startup
      window.addEventListener('load', loadApiKeys);

      // ====================================================================
      // âœ¨ 1. Manual Mode: Copy Prompt & Open Gemini
      // ====================================================================
      async function copyPromptAndOpenGemini() {
        const template = document.getElementById('geminiPromptTemplate').value;
        const sourceText = document.getElementById('sourceTextInput').value.trim();

        if (!sourceText) {
          alert('âš ï¸ ë¶„ì„í•  [ì†ŒìŠ¤ í…ìŠ¤íŠ¸]ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        const finalPrompt = template.replace('{{SOURCE_TEXT}}', sourceText);

        try {
          await navigator.clipboard.writeText(finalPrompt);
          alert("âœ… í”„ë¡¬í”„íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nGemini ì±„íŒ…ì°½ì´ ì—´ë¦¬ë©´ ìŠ¹ì¸(Ctrl+V) í•˜ì„¸ìš”.");
          window.open("https://gemini.google.com/app", "_blank");
        } catch (err) {
          alert("âŒ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨. í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
        }
      }

      // ====================================================================
      // ğŸš€ 2. Auto Mode: Run Analysis + Image Search
      // ====================================================================
      async function runAutoAnalysis() {
        const geminiKey = document.getElementById('geminiApiKey').value.trim();
        const googleKey = document.getElementById('googleSearchKey').value.trim();
        const cxId = document.getElementById('googleCxId').value.trim();
        const sourceText = document.getElementById('sourceTextInput').value.trim();

        if (!geminiKey) { alert('Gemini API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
        if (!sourceText) { alert('ë¶„ì„í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        const btn = document.querySelector('button[onclick="runAutoAnalysis()"]');
        const originalText = btn.innerText;
        btn.innerText = "â³ ë¶„ì„ ì¤‘... (Gemini API í˜¸ì¶œ)";
        btn.disabled = true;

        try {
          // 1. Construct Prompt
          const template = document.getElementById('geminiPromptTemplate').value;
          const prompt = template.replace('{{SOURCE_TEXT}}', sourceText);

          // 2. Call Gemini API
          const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiKey}`;

          const response = await fetch(geminiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }]
            })
          });

          if (!response.ok) throw new Error(`Gemini API Error: ${response.statusText}`);
          const result = await response.json();

          let generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
          if (!generatedText) throw new Error("Gemini ì‘ë‹µì— í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");

          // Clean Markdown
          generatedText = generatedText.replace(/```json/g, '').replace(/```/g, '').trim();

          let graphData;
          try {
            graphData = JSON.parse(generatedText);
          } catch (e) {
            // Try lenient parse
            graphData = JSON.parse(generatedText.replace(/\\n/g, ' '));
          }

          const elements = extractElementsFromJSON(graphData);
          if (!elements || elements.length === 0) throw new Error("ìœ íš¨í•œ ë…¸ë“œ/ì—£ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

          // 3. Image Search (Google Custom Search)
          if (googleKey && cxId) {
            btn.innerText = "ğŸ–¼ï¸ ì´ë¯¸ì§€ ê²€ìƒ‰ ì¤‘...";

            // Process nodes sequentially or parallel? Parallel is faster.
            const updates = elements.map(async (el) => {
              if (el.data && el.data.id && !el.data.source) { // Is Node
                // Skip if image already exists (from prompt?) or skip system nodes
                // Gemini might fill dummy image, check if empty or placeholder
                if (!el.data.image || el.data.image.trim() === "") {
                  // Search using label
                  const query = el.data.label || el.data.id;
                  // Simple heuristics to skip non-characters? 
                  // For now, search everything except known system tags if any. 
                  // Let's just search all nodes.
                  try {
                    const searchUrl = `https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(query)}&cx=${cxId}&searchType=image&key=${googleKey}&num=1`;
                    const searchRes = await fetch(searchUrl);
                    const searchJson = await searchRes.json();

                    if (searchJson.items && searchJson.items.length > 0) {
                      el.data.image = searchJson.items[0].link;
                    }
                  } catch (err) {
                    console.warn(`Image search failed for ${query}:`, err);
                  }
                }
              }
              return el;
            });

            await Promise.all(updates);
          }

          // 4. Update Graph
          cy.elements().remove();
          cy.add(elements);
          runLayout('cose');
          alert(`âœ… ë¶„ì„ ì™„ë£Œ! ${elements.length}ê°œì˜ ìš”ì†Œë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤.`);

        } catch (err) {
          alert(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`);
          console.error(err);
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      }

      // ====================================================================
      // âœ¨ ë ˆì´ì•„ì›ƒ (Layout)
      // ====================================================================
      function runLayout(mode) {
        if (currentLayout) currentLayout.stop();

        let layoutOptions = {};

        if (mode === 'cose') {
          layoutOptions = {
            name: 'cose',
            animate: true,
            randomize: false,
            componentSpacing: 100,
            nodeOverlap: 20,
            idealEdgeLength: function (edge) { return 100; },
            nodeRepulsion: function (node) { return 400000; },
            edgeElasticity: function (edge) { return 100; },
            nestingFactor: 5,
            gravity: 80,
            numIter: 1000,
            initialTemp: 200,
            coolingFactor: 0.95,
            minTemp: 1.0
          };
        } else if (mode === 'dagre') { // ì„¸ë¡œ íŠ¸ë¦¬ (ê¸°ë³¸)
          layoutOptions = {
            name: 'dagre',
            rankDir: 'TB',
            rankSep: 100,
            nodeSep: 80,
            animate: true,
            animationDuration: 500
          };
        } else if (mode === 'mindmap') { // ê°€ë¡œ ë§ˆì¸ë“œë§µ (LR)
          layoutOptions = {
            name: 'dagre',
            rankDir: 'LR',
            rankSep: 200, // ê°€ë¡œ ê°„ê²©
            nodeSep: 50,  // ì„¸ë¡œ ê°„ê²©
            animate: true,
            animationDuration: 500
          };
        }

        currentLayout = cy.layout(layoutOptions);
        currentLayout.run();
      }

      // ====================================================================
      // ğŸ¤– JSON í…ìŠ¤íŠ¸ ë³€í™˜ ë° ì¶”ê°€ ê´€ë ¨ í•¨ìˆ˜ (NEW)
      // ====================================================================

      // í…ìŠ¤íŠ¸ ì˜ì—­ì—ì„œ JSON ë°ì´í„°ë¥¼ ì½ì–´ ê·¸ë˜í”„ì— ì¶”ê°€í•˜ê±°ë‚˜ ë®ì–´ì“°ëŠ” í•¨ìˆ˜
      function loadJSONFromTextarea(isAppend) {
        const jsonText = document.getElementById('jsonInputTextarea').value.trim();
        if (!jsonText) {
          alert('JSON í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          const data = JSON.parse(jsonText);
          // ê¸°ì¡´ì— ì •ì˜ëœ extractElementsFromJSON í•¨ìˆ˜ë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
          const els = extractElementsFromJSON(data);

          if (!els.length) {
            alert('ìœ íš¨í•œ ë…¸ë“œ/ì—£ì§€ ë°ì´í„°ê°€ JSONì—ì„œ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
          }

          if (isAppend) {
            // ì¶”ê°€ ë¡œì§ (ê¸°ì¡´ appendJSON ë¡œì§ê³¼ ìœ ì‚¬í•˜ê²Œ ID ì¤‘ë³µ ë°©ì§€ ë° ìœ„ì¹˜ ì¡°ì •)
            const suffix = "_COPY_" + Date.now(), idMap = {}, newEls = [], offset = 500;

            // ë…¸ë“œì˜ ID ë³€ê²½ ë° ìœ„ì¹˜ ì¡°ì •
            els.forEach(el => {
              if (el.data && el.data.id && !el.data.source) { // Node
                const old = el.data.id, nid = old + suffix;
                if (cy.getElementById(nid).length) return; // Skip if ID collision still occurs (unlikely)
                const n = JSON.parse(JSON.stringify(el));
                n.data.id = nid;
                // ìœ„ì¹˜ ì¡°ì •
                n.position = n.position ? { x: n.position.x + offset, y: n.position.y + offset } : { x: cy.width() / 2 + offset, y: cy.height() / 2 + offset };
                idMap[old] = nid;
                newEls.push(n);
              }
            });

            // ì—£ì§€ì˜ ID ë³€ê²½ ë° ì—°ê²° ë…¸ë“œ ID ì—…ë°ì´íŠ¸
            els.forEach(el => {
              if (el.data && el.data.source) { // Edge
                // ë§µí•‘ëœ ìƒˆ IDê°€ ì¡´ì¬í•˜ëŠ” ì—£ì§€ë§Œ ì¶”ê°€
                if (idMap[el.data.source] && idMap[el.data.target]) {
                  const n = JSON.parse(JSON.stringify(el));
                  n.data.id = (n.data.id || "EDGE_TEXT") + suffix; // ì—£ì§€ IDë„ ê³ ìœ í•˜ê²Œ ë³€ê²½
                  n.data.source = idMap[el.data.source];
                  n.data.target = idMap[el.data.target];
                  newEls.push(n);
                }
              }
            });

            if (newEls.length) {
              cy.add(newEls);
              runLayout('cose');
              alert(`JSON í…ìŠ¤íŠ¸ì—ì„œ ${newEls.length}ê°œì˜ ìš”ì†Œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
            } else {
              alert('ì¶”ê°€í•  ìƒˆë¡œìš´ ë…¸ë“œ/ì—£ì§€ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }

          } else {
            // ë®ì–´ì“°ê¸° ë¡œì§
            cy.elements().remove();
            cy.add(els);
            runLayout('cose');
            alert('JSON í…ìŠ¤íŠ¸ë¡œ ê·¸ë˜í”„ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë®ì–´ì¼ìŠµë‹ˆë‹¤!');
          }

        } catch (err) {
          alert('JSON íŒŒì‹± ì˜¤ë¥˜! ìœ íš¨í•œ JSON í˜•ì‹ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.\nì˜¤ë¥˜: ' + err.message);
        }
      }
      // ====================================================================
      // ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ + âš¡ ì´ë¯¸ì§€ ìµœì í™” (Resize)
      // ====================================================================

      function resizeImage(file, maxWidth, maxHeight, quality, callback) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.onload = function () {
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width *= maxHeight / height;
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // JPEG, quality 0.7ë¡œ ì••ì¶•
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            callback(dataUrl);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      function handleFileUpload(input) {
        if (input.files && input.files[0]) {
          const file = input.files[0];

          // 1. ì´ë¯¸ì§€ íŒŒì¼ -> ì••ì¶• ë° ë¦¬ì‚¬ì´ì¦ˆ í›„ Base64 ë³€í™˜
          if (file.type.startsWith('image/')) {
            // ê³ í•´ìƒë„ ì´ë¯¸ì§€ê°€ ê·¸ëŒ€ë¡œ ë“¤ì–´ê°€ë©´ ë¸Œë¼ìš°ì €ê°€ ëŠë ¤ì§€ë¯€ë¡œ ìµœì í™” ìˆ˜í–‰
            // Max Width/Height: 800px, Quality: 0.7
            resizeImage(file, 800, 800, 0.7, function (resizedDataUrl) {
              document.getElementById('imageInput').value = resizedDataUrl;
              alert("ì´ë¯¸ì§€ ìµœì í™”(ì••ì¶•) ì™„ë£Œ!\nì´ì œ 'ì €ì¥' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
            });
          }
          // 2. í…ìŠ¤íŠ¸ íŒŒì¼ (.txt, .md, .json ë“±) -> ë‚´ìš© ì½ì–´ì„œ ì…ë ¥
          else if (file.type.startsWith('text/') || file.name.endsWith('.md') || file.name.endsWith('.json') || file.name.endsWith('.txt')) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById('imageInput').value = e.target.result;
              alert("í…ìŠ¤íŠ¸ íŒŒì¼ ë‚´ìš©ì´ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
            reader.readAsText(file);
          }
          // 3. ë¹„ë””ì˜¤ ë° ê¸°íƒ€ -> ê²½ë¡œ ì•ˆë‚´
          else {
            alert("âš ï¸ [ì£¼ì˜] ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìƒ ë¹„ë””ì˜¤/ë¬¸ì„œ íŒŒì¼ì˜ 'ë¡œì»¬ ê²½ë¡œ(C:\\...)'ëŠ” ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n" +
              "ë¹„ë””ì˜¤ ì—°ê²°ì„ ì›í•˜ì‹œë©´ íƒìƒ‰ê¸°ì—ì„œ [Shift + ìš°í´ë¦­] -> [ê²½ë¡œë¡œ ë³µì‚¬] í›„ ì§ì ‘ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.");
            input.value = ''; // ì´ˆê¸°í™”
          }
        }
      }
    </script>
</body>

</html>