<!DOCTYPE TML>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„¸ê³„ê´€ ê·¸ë˜í”„ í¸ì§‘ê¸°</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Malgun Gothic', sans-serif;
      background: #f0f0f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      font-size: 1.5em;
      margin-bottom: 5px;
      text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
    }

    header p {
      text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
    }

    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .left-panel {
      width: 25%;
      background: white;
      padding: 15px;
      overflow-y: auto;
      border-right: 2px solid #ddd;
    }

    .graph-area {
      width: 50%;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .right-panel {
      width: 25%;
      background: white;
      padding: 15px;
      overflow-y: auto;
      border-left: 2px solid #ddd;
      display: flex;
      flex-direction: column;
    }

    #cy {
      flex: 1;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
    }

    .panel-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .panel-section h3 {
      font-size: 1em;
      margin-bottom: 10px;
      color: #667eea;
      border-bottom: 2px solid #667eea;
      padding-bottom: 5px;
      text-shadow: 0.5px 0.5px 0 #000;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9em;
    }

    button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 4px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.1s;
      font-weight: bold;
      color: white; 
    }

    /* í°ìƒ‰ ê¸€ì”¨ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  ë²„íŠ¼ì— ê²€ì€ìƒ‰ í…Œë‘ë¦¬ ì¶”ê°€ */
    .btn-primary, .btn-success, .btn-info {
        text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .btn-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }


    /* [í•µì‹¬] ì˜µì‹œë””ì–¸ ìŠ¤íƒ€ì¼ ë²„íŠ¼ íƒ„ë ¥ íš¨ê³¼ */
    button:active {
      transform: scale(0.98);
      box-shadow: none !important;
      transition: transform 0s;
    }

    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Malgun Gothic', monospace;
      font-size: 0.9em;
      resize: vertical;
      min-height: 150px;
    }

    .notes-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .notes-textarea {
      flex: 1;
      min-height: 200px;
      font-family: 'Malgun Gothic', sans-serif;
      line-height: 1.6;
    }

    .tts-controls {
      padding: 10px;
      background: #f0f7ff;
      border-radius: 6px;
      border: 1px solid #d0e7ff;
    }

    .tts-controls h3 {
      margin: 0 0 10px 0; 
      font-size: 0.95em;
    }

    .tts-controls label {
      display: block;
      font-size: 0.85em;
      color: #555;
      margin: 8px 0 4px 0;
      font-weight: bold;
    }

    .speed-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .speed-control input[type="range"] {
      flex: 1;
    }

    .speed-value {
      min-width: 40px;
      text-align: center;
      font-weight: bold;
      color: #667eea;
    }

    .tts-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .info-badge {
      display: inline-block;
      padding: 6px 12px;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 0.85em;
      margin-bottom: 10px;
      text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
    }

    .help-text {
      font-size: 0.8em;
      color: #888;
      margin-top: 5px;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ ì„¸ê³„ê´€ ê·¸ë˜í”„ í¸ì§‘ê¸°</h1>
    <p>ì°¨ìˆ˜ì— ë”°ë¼ ì›€ì§ì„ ê°•ë„ê°€ ë™ì ìœ¼ë¡œ ì¡°ì ˆë˜ëŠ” ë²„ì „ (ê°•ë„ ë§¤ìš° ë†’ìŒ)</p>
  </header>

  <div class="main-container">
    <div class="left-panel">
      <div class="panel-section">
        <h3>â• ë…¸ë“œ ì¶”ê°€</h3>
        <input type="text" id="newNode" placeholder="ë…¸ë“œ ì´ë¦„">
        <button class="btn-primary" onclick="addNode()">ë…¸ë“œ ì¶”ê°€</button>
        <div class="help-text">ğŸ’¡ ë¹ˆ ê³µê°„ì„ ë”ë¸”í´ë¦­í•´ë„ ë…¸ë“œë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
      </div>

      <div class="panel-section">
        <h3>ğŸ”— ê´€ê³„ ì—°ê²°</h3>
        <input type="text" id="edgeSrc" placeholder="ì¶œë°œ ë…¸ë“œ">
        <input type="text" id="edgeTgt" placeholder="ë„ì°© ë…¸ë“œ">
        <input type="text" id="edgeLbl" placeholder="ê´€ê³„ ë¼ë²¨ (TIMELINE ì…ë ¥ ì‹œ êµµì€ ì„ )">
        <button class="btn-primary" onclick="addEdge()">ì—°ê²° ì¶”ê°€</button>
        <div class="help-text">ğŸ’¡ Ctrl+ë“œë˜ê·¸ë¡œ ë…¸ë“œë¥¼ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
      </div>

      <div class="panel-section">
        <h3>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
        <button class="btn-success" onclick="saveToLocalStorage()">ğŸ’¾ ë¡œì»¬ ì €ì¥</button>
        <button class="btn-info" onclick="loadFromLocalStorage()">ğŸ“‚ ë¡œì»¬ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn-primary" onclick="saveToURL()">ğŸ”— URLë¡œ ì €ì¥</button>
        <button class="btn-success" onclick="downloadJSON()">â¬‡ï¸ JSON ë‹¤ìš´ë¡œë“œ</button>
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="uploadJSON(event)">
        <button class="btn-info" onclick="document.getElementById('fileInput').click()">â¬†ï¸ JSON ì—…ë¡œë“œ</button>
        
        <input type="file" id="appendFileInput" accept=".json" style="display:none" onchange="appendJSON(event)">
        <button class="btn-primary" onclick="document.getElementById('appendFileInput').click()">â• JSON ì¶”ê°€ ì—…ë¡œë“œ</button>
        <div class="help-text">ğŸ’¡ URLë¡œ ì €ì¥í•˜ë©´ ì£¼ì†Œì°½ ë³µì‚¬ë¡œ ê³µìœ  ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
      </div>

      <div class="panel-section">
        <h3>âœ¨ ë ˆì´ì•„ì›ƒ ì •ë ¬</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
          <button class="btn-info" onclick="runLayout('cose')">ğŸ’« ê¸°ë³¸ (ë¬¼ë¦¬ ë ˆì´ì•„ì›ƒ)</button>
          <button class="btn-info" onclick="runLayout('dagre')">ğŸŒ² íŠ¸ë¦¬í˜•</button>
        </div>
      </div>
    </div>

    <div class="graph-area">
      <div id="cy"></div>
    </div>
    
    <div class="right-panel">
      <div class="panel-section notes-area">
        <h3>âœï¸ ë…¸ë“œ/ì—£ì§€ ì†ì„± í¸ì§‘</h3>
        <div class="info-badge" id="notesInfo">ë…¸ë“œ/ì—£ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        
        <label for="labelInput" style="font-weight: bold; color: #333;">ì´ë¦„/ë¼ë²¨ ìˆ˜ì •</label>
        <input type="text" id="labelInput" placeholder="ì„ íƒí•œ ìš”ì†Œì˜ ì´ë¦„(ë¼ë²¨)ì´ í‘œì‹œë©ë‹ˆë‹¤." disabled>
        
        <div id="colorControl" style="display:none;">
            <label for="colorInput" style="font-weight: bold; color: #333; margin-top: 10px;">ë…¸ë“œ ìƒ‰ìƒ</label>
            <input type="color" id="colorInput" value="#667eea" style="height: 40px; padding: 0;">
        </div>
        <label for="notesTextarea" style="font-weight: bold; color: #333; margin-top: 10px;">ğŸ“ ë©”ëª¨ ìˆ˜ì •</label>
        <textarea class="notes-textarea" id="notesTextarea" placeholder="ì—¬ê¸°ì— ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
        
        <button class="btn-success" onclick="saveNotes()">ğŸ’¾ ì´ë¦„, ìƒ‰ìƒ ë° ë©”ëª¨ ì €ì¥</button>

        <div class="tts-controls">
          <h3>ğŸ”Š ì½ì–´ì£¼ê¸° (TTS)</h3>
          <label>ğŸ™ï¸ ìŒì„± ì„ íƒ</label>
          <select id="voiceSelect">
            <option value="ko-KR">í•œêµ­ì–´ (ê¸°ë³¸)</option>
          </select>
          <label>âš¡ ì†ë„</label>
          <div class="speed-control">
            <input type="range" id="speedControl" min="0.5" max="2.0" step="0.1" value="1.0"
              oninput="updateSpeedValue()">
            <span class="speed-value" id="speedValue">1.0x</span>
          </div>
          <div class="tts-buttons">
            <button class="btn-primary" onclick="readNotes()">ğŸ”Š ì½ê¸°</button>
            <button class="btn-danger" onclick="stopReading()">â¹ï¸ ì •ì§€</button>
          </div>
          <div class="help-text">ğŸ’¡ íŠ¹ìˆ˜ë¬¸ìëŠ” ìë™ìœ¼ë¡œ ì œê±°ë©ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let initialData = [
      { data: { id: "ì£¼ì¸ê³µ", label: "ì£¼ì¸ê³µ", color: "#667eea", notes: "" } },
      { data: { id: "ì•„ë¦°", label: "ì•„ë¦°", color: "#f093fb", notes: "" } },
      { data: { id: "ev1", label: "ì‹œì‘ ì´ë²¤íŠ¸", color: "#4facfe", notes: "" } },
      { data: { id: "ì£¼ì¸ê³µ_ì•„ë¦°", source: "ì£¼ì¸ê³µ", target: "ì•„ë¦°", label: "ì¹œêµ¬", notes: "" } }, 
      { data: { id: "ev1_ì£¼ì¸ê³µ", source: "ev1", target: "ì£¼ì¸ê³µ", label: "TIMELINE", notes: "ìŠ¤í† ë¦¬ ì‹œì‘ì " }, classes: "timeline" } 
    ];

    let cy = cytoscape({
      container: document.getElementById('cy'),
      elements: JSON.parse(JSON.stringify(initialData)),
      style: [
        {
          selector: 'node', style: {
            'label': 'data(label)',
            'background-color': 'data(color)',
            'shape': 'round-rectangle',
            'width': 'label',
            'height': 30,
            'padding': '10px',
            'border-width': 2,
            'border-color': '#333',
            'border-style': 'solid',
            'text-valign': 'center',
            'text-halign': 'center',
            'color': '#fff',
            'font-weight': 'bold',
            'font-size': 14,
            'text-outline-width': 2,
            'text-outline-color': '#000'
          }
        },
        {
          selector: 'edge', style: {
            'label': 'data(label)',
            'curve-style': 'bezier',
            'line-color': '#999',
            'width': 1,
            'target-arrow-shape': 'triangle',
            'target-arrow-color': '#999',
            'font-size': 12
          }
        },
        {
          selector: 'edge.timeline', 
          style: {
            'line-color': '#ff0055', 
            'width': 3, 
            'target-arrow-color': '#ff0055' 
          }
        }
      ],
      layout: { name: 'cose', animate: true },
      boxSelectionEnabled: false
    });

    let selected = null, 
        speechSynthesis = window.speechSynthesis, 
        currentUtterance = null, 
        edgeCreationMode = false, 
        edgeSourceNode = null;
        
    let tremorInterval = null; 
    let currentLayout = null; 
    
    // DOM ìš”ì†Œ ìºì‹œ
    const notesInfo = document.getElementById('notesInfo');
    const labelInput = document.getElementById('labelInput');
    const colorControl = document.getElementById('colorControl');
    const colorInput = document.getElementById('colorInput');
    const notesTextarea = document.getElementById('notesTextarea');

    window.addEventListener('load', function () {
      const hash = window.location.hash.substring(1);
      if (hash) {
        try {
          const decompressed = LZString.decompressFromEncodedURIComponent(hash);
          const data = JSON.parse(decompressed);
          cy.elements().remove();
          cy.add(data);
          runLayout('cose');
        } catch (e) { console.error('URL ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e); }
      } else {
          runLayout('cose');
      }
      
      // ì´ˆê¸° ìƒíƒœ ì„¤ì •
      labelInput.disabled = true;
      notesTextarea.disabled = true;
    });

    cy.on('dbltap', function (evt) {
      if (evt.target === cy) {
        const pos = evt.position, nodeName = prompt("ìƒˆ ë…¸ë“œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "ìƒˆ ë…¸ë“œ");
        if (nodeName && nodeName.trim()) {
          const id = nodeName.trim();
          if (cy.getElementById(id).length > 0) { alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë…¸ë“œ ì´ë¦„ì…ë‹ˆë‹¤!"); return; }
          const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
          cy.add({ data: { id: id, label: id, color: colors[Math.floor(Math.random() * colors.length)], notes: "" }, position: { x: pos.x, y: pos.y } });
          
          stopObsidianTremor();
          startObsidianTremor();
        }
      }
    });

    // ------------------- â–¼ Ctrl+ë“œë˜ê·¸ ê´€ê³„ ì—°ê²° ê¸°ëŠ¥ ìœ ì§€ & í´ë˜ìŠ¤ ìë™ ì ìš© ì¶”ê°€ â–¼ -------------------
    cy.on('mousedown', 'node', function (evt) {
      if (evt.originalEvent.ctrlKey || evt.originalEvent.metaKey) {
        edgeCreationMode = true; edgeSourceNode = evt.target;
        evt.target.style({ 'border-width': '4px', 'border-color': '#43e97b', 'border-style': 'dashed' });
      }
    });
    cy.on('mouseover', 'node', function (evt) { if (edgeCreationMode && evt.target.id() !== edgeSourceNode.id()) evt.target.style({ 'border-width': '4px', 'border-color': '#4facfe' }); });
    cy.on('mouseout', 'node', function (evt) { if (edgeCreationMode && evt.target.id() !== edgeSourceNode.id()) evt.target.style('border-width', '2px'); });
    
    cy.on('mouseup', 'node', function (evt) {
      if (edgeCreationMode && evt.target.id() !== edgeSourceNode.id()) {
        const label = prompt("ê´€ê³„ ë¼ë²¨ì„ ì…ë ¥í•˜ì„¸ìš”:", "ê´€ê³„");
        if (label !== null) {
          
          let classes = "";
          if (label && (label.toUpperCase() === "TIMELINE" || label.toUpperCase() === "íƒ€ì„ë¼ì¸")) {
              classes = "timeline";
          }

          cy.add({ 
            data: { 
              id: edgeSourceNode.id() + "_" + evt.target.id() + "_" + Date.now(), 
              source: edgeSourceNode.id(), 
              target: evt.target.id(), 
              label: label || "",
              notes: "" 
            },
            classes: classes 
          });
          
          stopObsidianTremor();
          startObsidianTremor();
        }
        edgeSourceNode.style('border-width', '2px'); edgeCreationMode = false; edgeSourceNode = null;
      }
    });
    cy.on('mouseup', function (evt) { if (edgeCreationMode && evt.target === cy) { if (edgeSourceNode) edgeSourceNode.style('border-width', '2px'); edgeCreationMode = false; edgeSourceNode = null; } });
    // ------------------- â–² Ctrl+ë“œë˜ê·¸ ê´€ê³„ ì—°ê²° ê¸°ëŠ¥ ìœ ì§€ & í´ë˜ìŠ¤ ìë™ ì ìš© ì¶”ê°€ â–² -------------------


    // ------------------- â–¼ ì˜µì‹œë””ì–¸ íŠ¸ë ˆë¨¸(Tremor) í•¨ìˆ˜ (ê°•ë„ ë™ì  ì¡°ì •) (ìœ ì§€) â–¼ -------------------
    function startObsidianTremor() {
      if (tremorInterval) return;
      
      const BASE_MAX_TREMOR_STRENGTH = 5.0; 
      
      tremorInterval = setInterval(() => {
        cy.nodes().forEach(node => {
          const degree = node.degree(); 
          const tremorStrength = BASE_MAX_TREMOR_STRENGTH / (1 + degree);
          
          const dx = (Math.random() - 0.5) * tremorStrength; 
          const dy = (Math.random() - 0.5) * tremorStrength; 
          
          node.position({
            x: node.position('x') + dx,
            y: node.position('y') + dy
          });
        });
      }, 50); 
    }

    function stopObsidianTremor() {
      if (tremorInterval) {
        clearInterval(tremorInterval);
        tremorInterval = null;
      }
    }
    // ------------------- â–² ì˜µì‹œë””ì–¸ íŠ¸ë ˆë¨¸(Tremor) í•¨ìˆ˜ (ê°•ë„ ë™ì  ì¡°ì •) (ìœ ì§€) â–² -------------------


    // ------------------- â–¼ TTS í•¨ìˆ˜ (ìœ ì§€) â–¼ -------------------
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      const voiceSelect = document.getElementById('voiceSelect');
      voiceSelect.innerHTML = '';
      const koVoices = voices.filter(v => v.lang.startsWith('ko'));
      if (koVoices.length > 0) {
        koVoices.forEach((voice) => {
          const option = document.createElement('option');
          option.value = voice.name;
          option.textContent = `${voice.name} (${voice.lang})${voice.default ? ' (ê¸°ë³¸)' : ''}`;
          voiceSelect.appendChild(option);
        });
      } else {
        const option = document.createElement('option');
        option.value = "default";
        option.textContent = "í•œêµ­ì–´ ìŒì„± ì—†ìŒ (ì‹œìŠ¤í…œ ê¸°ë³¸)";
          voiceSelect.appendChild(option);
      }
    }
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices();

    function updateSpeedValue() { document.getElementById('speedValue').textContent = document.getElementById('speedControl').value + 'x'; }

    function cleanTextForTTS(text) {
      return text
        .replace(/[#*_~`\[\]{}()\-+=|\\<>]/g, ' ')
        .replace(/[!@$%^&]/g, ' ')
        .replace(/[:;]/g, ',')
        .replace(/[.]{2,}/g, '.')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function readNotes() {
      const text = notesTextarea.value.trim();
      if (!text) { alert('ì½ì„ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤!'); return; }
      stopReading();

      const cleanedText = cleanTextForTTS(text);
      currentUtterance = new SpeechSynthesisUtterance(cleanedText);

      const voices = speechSynthesis.getVoices();
      const selectedVoiceName = document.getElementById('voiceSelect').value;
      const selectedVoice = voices.find(v => v.name === selectedVoiceName);

      if (selectedVoice) {
        currentUtterance.voice = selectedVoice;
        currentUtterance.lang = selectedVoice.lang;
      } else {
        currentUtterance.lang = 'ko-KR';
      }

      currentUtterance.rate = parseFloat(document.getElementById('speedControl').value);
      currentUtterance.pitch = 1.0;
      currentUtterance.volume = 1.0;

      speechSynthesis.speak(currentUtterance);
    }

    function stopReading() { if (speechSynthesis.speaking) speechSynthesis.cancel(); currentUtterance = null; }
    // ------------------- â–² TTS í•¨ìˆ˜ (ìœ ì§€) â–¼ -------------------


    function runLayout(layoutName) {
      stopObsidianTremor(); 
      if (currentLayout) {
          currentLayout.stop();
          currentLayout = null;
      }

      let layoutOptions = {};
      
      if (layoutName === 'cose') {
        layoutOptions = {
          name: 'cose', animate: true, animationDuration: 500, animationEasing: 'ease-out', stepSize: 1, 
          fit: true, padding: 10, nodeRepulsion: 20000, idealEdgeLength: 150, edgeElasticity: 0.2, gravity: 0.05,
        };
        
        const layout = cy.layout(layoutOptions);
        layout.run();
        setTimeout(startObsidianTremor, 500); 

      } else if (layoutName === 'dagre') {
        cy.nodes().unlock(); 
        layoutOptions = { name: 'dagre', rankDir: 'TB', padding: 10, animate: true };
        const layout = cy.layout(layoutOptions);
        layout.run();
        setTimeout(startObsidianTremor, 500);
      }
    }

    function addNode() {
      const id = document.getElementById('newNode').value.trim();
      if (!id) { alert('ë…¸ë“œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!'); return; }
      if (cy.getElementById(id).length > 0) { alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë…¸ë“œì…ë‹ˆë‹¤!'); return; }
      const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
      cy.add({ data: { id: id, label: id, color: colors[Math.floor(Math.random() * colors.length)], notes: "" } });
      
      runLayout('cose');

      document.getElementById('newNode').value = '';
    }

    function addEdge() {
      const src = document.getElementById('edgeSrc').value.trim(), 
            tgt = document.getElementById('edgeTgt').value.trim(), 
            lbl = document.getElementById('edgeLbl').value.trim();
      
      if (!src || !tgt) { alert('ì¶œë°œ ë…¸ë“œì™€ ë„ì°© ë…¸ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”!'); return; }
      if (cy.getElementById(src).length === 0 || cy.getElementById(tgt).length === 0) { alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë…¸ë“œì…ë‹ˆë‹¤!'); return; }
      
      let classes = "";
      if (lbl && (lbl.toUpperCase() === "TIMELINE" || lbl.toUpperCase() === "íƒ€ì„ë¼ì¸")) {
          classes = "timeline";
      }

      cy.add({ 
          data: { 
              id: src + "_" + tgt + "_" + Date.now(), 
              source: src, 
              target: tgt, 
              label: lbl || "",
              notes: "" 
          },
          classes: classes 
      });
      
      runLayout('cose');

      document.getElementById('edgeSrc').value = ''; 
      document.getElementById('edgeTgt').value = ''; 
      document.getElementById('edgeLbl').value = '';
    }

    // ------------------- â–¼ ë©”ëª¨/ì„ íƒ ê¸°ëŠ¥ (ì´ë¦„ ë° ìƒ‰ìƒ ìˆ˜ì • í•„ë“œ ì—°ë™) â–¼ -------------------

    cy.on('tap', 'node', function (evt) {
      const node = evt.target;
      selected = { type: 'node', id: node.id() };
      
      notesInfo.innerText = "ë…¸ë“œ: " + node.id();
      labelInput.value = node.data('label') || '';
      notesTextarea.value = node.data('notes') || '';
      
      labelInput.disabled = false;
      notesTextarea.disabled = false;
      
      // ë…¸ë“œ ì „ìš© í•„ë“œ í‘œì‹œ ë° ê°’ ì„¤ì •
      colorControl.style.display = 'block';
      colorInput.value = node.data('color') || '#667eea';
    });

    cy.on('tap', 'edge', function (evt) {
      const edge = evt.target;
      selected = { type: 'edge', id: edge.id() };
      
      notesInfo.innerText = "ì—£ì§€: " + edge.data('source') + " â†’ " + edge.data('target');
      labelInput.value = edge.data('label') || '';
      notesTextarea.value = edge.data('notes') || '';
      
      labelInput.disabled = false;
      notesTextarea.disabled = false;
      
      // ì—£ì§€ëŠ” ìƒ‰ìƒ ìˆ˜ì • í•„ë“œë¥¼ ìˆ¨ê¹€
      colorControl.style.display = 'none';
    });
    
    // ë¹ˆ ê³µê°„ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
    cy.on('tap', function(evt){
        if(evt.target === cy){
            selected = null;
            notesInfo.innerText = "ë…¸ë“œ/ì—£ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”";
            labelInput.value = '';
            notesTextarea.value = '';
            labelInput.disabled = true;
            notesTextarea.disabled = true;
            colorControl.style.display = 'none';
        }
    });

    function saveNotes() {
      if (!selected) { alert('ë…¸ë“œ ë˜ëŠ” ì—£ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”!'); return; }
      const element = cy.getElementById(selected.id);
      
      const newLabel = labelInput.value.trim();
      const newNotes = notesTextarea.value;

      if (!newLabel) {
        alert('ì´ë¦„/ë¼ë²¨ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // 1. ì´ë¦„/ë¼ë²¨ ì €ì¥
      element.data('label', newLabel);
      
      // 2. ë©”ëª¨ ì €ì¥
      element.data('notes', newNotes);

      // 3. ë…¸ë“œ ì „ìš©: ìƒ‰ìƒ ì €ì¥ ë° ì ìš©
      if (selected.type === 'node') {
        const newColor = colorInput.value;
        element.data('color', newColor);
      }

      // 4. ì—£ì§€ ì „ìš©: ë¼ë²¨ì— ë”°ë¥¸ í´ë˜ìŠ¤(TIMELINE) ìë™ ì—…ë°ì´íŠ¸
      if (selected.type === 'edge') {
        if (newLabel.toUpperCase() === "TIMELINE" || newLabel.toUpperCase() === "íƒ€ì„ë¼ì¸") {
            element.addClass('timeline');
        } else {
            element.removeClass('timeline');
        }
      }

      alert('ì†ì„± ë° ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ------------------- â–² ë©”ëª¨/ì„ íƒ ê¸°ëŠ¥ (ì´ë¦„ ë° ìƒ‰ìƒ ìˆ˜ì • í•„ë“œ ì—°ë™) â–² -------------------


    function saveToLocalStorage() { localStorage.setItem("graphData", JSON.stringify(cy.json().elements)); alert('ë¡œì»¬ ì €ì¥ ì™„ë£Œ!'); }
    function loadFromLocalStorage() {
      const data = localStorage.getItem("graphData");
      if (data) { cy.elements().remove(); cy.add(JSON.parse(data)); runLayout('cose'); alert('ë¡œì»¬ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!'); }
      else alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
    }

    function saveToURL() {
      const json = cy.json().elements;
      const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(json));
      window.location.hash = compressed;
      alert('URLì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì£¼ì†Œì°½ì˜ URLì„ ë³µì‚¬í•˜ì—¬ ê³µìœ í•˜ì„¸ìš”.');
    }

    function downloadJSON() {
      const json = cy.json().elements;
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", "graph_" + new Date().toISOString().slice(0, 10) + ".json");
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      alert('JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
    }

    // ------------------- â–¼ ìš”ì†Œ ì¶”ì¶œ ê³µí†µ ë¡œì§ (ìœ ì§€) â–¼ -------------------
    function extractElementsFromJSON(data) {
        let elements = [];
        
        if (data.graphData) {
            const gd = data.graphData;
            if (gd.nodes || gd.edges) {
                elements = [
                    ...(Array.isArray(gd.nodes) ? gd.nodes : []),
                    ...(Array.isArray(gd.edges) ? gd.edges : [])
                ];
            } 
            else if (Array.isArray(gd.elements)) {
                elements = gd.elements;
            }
            else if (gd.elements && (gd.elements.nodes || gd.elements.edges)) {
                elements = [
                    ...(Array.isArray(gd.elements.nodes) ? gd.elements.nodes : []),
                    ...(Array.isArray(gd.elements.edges) ? gd.elements.edges : [])
                ];
            }
        }
        
        if (elements.length === 0) {
            if (Array.isArray(data)) {
                elements = data;
            } else if (data.nodes || data.edges) {
                elements = [
                    ...(Array.isArray(data.nodes) ? data.nodes : []),
                    ...(Array.isArray(data.edges) ? data.edges : [])
                ];
            } else if (data.elements) {
                if (Array.isArray(data.elements)) {
                    elements = data.elements;
                } else if (data.elements.nodes || data.elements.edges) {
                    elements = [
                        ...(Array.isArray(data.elements.nodes) ? data.elements.nodes : []),
                        ...(Array.isArray(data.elements.edges) ? data.elements.edges : [])
                    ];
                }
            }
        }
        return elements;
    }
    // ------------------- â–² ìš”ì†Œ ì¶”ì¶œ ê³µí†µ ë¡œì§ (ìœ ì§€) â–² -------------------


    function uploadJSON(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);
            const elementsToAdd = extractElementsFromJSON(data); 

            if (elementsToAdd.length === 0) {
                alert('JSON íŒŒì¼ì— ìœ íš¨í•œ ë…¸ë“œ ë˜ëŠ” ì—£ì§€ ë°ì´í„°ê°€ ì—†ì–´ ê·¸ë˜í”„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            cy.elements().remove();
            cy.add(elementsToAdd); 
            runLayout('cose');
            alert('JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
          } catch (err) { alert('JSON íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜: ' + err.message); }
        };
        reader.readAsText(file);
      }
    }
    
    function appendJSON(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const elementsToAdd = extractElementsFromJSON(data);
                    
                    if (elementsToAdd.length === 0) {
                        alert('JSON íŒŒì¼ì— ì¶”ê°€í•  ìœ íš¨í•œ ë…¸ë“œ ë˜ëŠ” ì—£ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    const suffix = "_COPY_" + Date.now(); 
                    const idMap = {}; 
                    const newElements = [];
                    let addedNodeCount = 0;
                    let addedEdgeCount = 0;
                    const offset = 500; 

                    elementsToAdd.forEach(el => {
                        const isNode = el.data && el.data.id && !el.data.source && !el.data.target; 
                        
                        if (isNode) {
                            const oldId = el.data.id;
                            const newId = oldId + suffix;
                            
                            if (cy.getElementById(newId).length > 0) return; 

                            const newEl = JSON.parse(JSON.stringify(el)); 
                            newEl.data.id = newId;
                            
                            if (newEl.position) {
                                newEl.position = { x: newEl.position.x + offset, y: newEl.position.y + offset };
                            } else {
                                newEl.position = { x: cy.width() / 2 + offset, y: cy.height() / 2 + offset };
                            }
                            
                            idMap[oldId] = newId; 
                            newElements.push(newEl);
                            addedNodeCount++;
                        }
                    });
                    
                    elementsToAdd.forEach(el => {
                        const isEdge = el.data && el.data.source && el.data.target;
                        
                        if (isEdge) {
                            const oldSource = el.data.source;
                            const oldTarget = el.data.target;
                            
                            if (idMap[oldSource] && idMap[oldTarget]) {
                                const newEl = JSON.parse(JSON.stringify(el)); 
                                
                                newEl.data.id = (newEl.data.id || (oldSource + "_" + oldTarget + "_EDGE")) + suffix; 
                                newEl.data.source = idMap[oldSource]; 
                                newEl.data.target = idMap[oldTarget]; 
                                
                                newElements.push(newEl);
                                addedEdgeCount++;
                            }
                        }
                    });


                    if (newElements.length > 0) {
                        cy.add(newElements);
                        runLayout('cose');
                        alert(`JSON íŒŒì¼ ì¶”ê°€ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! (${addedNodeCount}ê°œ ë…¸ë“œ, ${addedEdgeCount}ê°œ ì—£ì§€ ë³µì œë³¸ ì¶”ê°€)`);
                    } else if (addedNodeCount === 0 && addedEdgeCount === 0) {
                        alert('JSON íŒŒì¼ì— ì¶”ê°€í•  ìœ íš¨í•œ ë…¸ë“œ ë˜ëŠ” ì—£ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    
                } catch (err) {
                    alert('JSON íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
    }
  </script>
</body>

</html>